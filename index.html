<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PS Smart Financial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 1.5rem; border: 1px solid #f1f5f9; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <nav class="bg-white border-b sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center gap-2 text-blue-600 font-black text-xl">
                <span>฿</span> PS SMART FINANCE
            </div>
            <div class="flex bg-gray-100 p-1 rounded-xl text-[10px] font-black">
                <button onclick="switchTab('dashboard')" id="btn-dashboard" class="px-4 py-2 rounded-lg bg-white shadow-sm text-blue-600">DASHBOARD</button>
                <button onclick="switchTab('edit')" id="btn-edit" class="px-4 py-2 rounded-lg text-gray-400">RECORDS</button>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto w-full p-4 py-8 flex-grow">
        <!-- Dashboard Tab -->
        <div id="tab-dashboard" class="space-y-6">
            <div id="no-data" class="text-center py-20 bg-white rounded-[2rem] border-2 border-dashed border-gray-200">
                <h2 class="text-gray-400 font-bold mb-6">ยังไม่มีข้อมูลในระบบ</h2>
                <button onclick="document.getElementById('fileInput').click()" class="bg-blue-600 text-white px-8 py-3 rounded-2xl font-black shadow-lg">Open JSON Database</button>
            </div>

            <div id="dashboard-content" class="hidden space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="card"><div class="text-[10px] font-black text-gray-400 mb-1">INCOME</div><div id="stat-income" class="text-2xl font-black">0</div></div>
                    <div class="card"><div class="text-[10px] font-black text-gray-400 mb-1">EXPENSE</div><div id="stat-expense" class="text-2xl font-black text-red-500">0</div></div>
                    <div id="stat-surplus-card" class="card bg-blue-600 text-white border-none shadow-xl shadow-blue-100">
                        <div class="text-[10px] font-black opacity-60 mb-1">SURPLUS</div>
                        <div id="stat-surplus" class="text-2xl font-black">0</div>
                    </div>
                </div>
                <div class="card h-64 flex items-center justify-center text-gray-300 font-bold italic">
                    Trend Chart will appear after adding more data.
                </div>
            </div>
        </div>

        <!-- Edit Tab -->
        <div id="tab-edit" class="hidden space-y-6 max-w-2xl mx-auto">
            <div class="flex flex-col md:flex-row gap-4 bg-white p-4 rounded-3xl border border-gray-100 shadow-sm">
                <input type="month" id="monthInput" class="font-black text-blue-600 bg-blue-50 px-4 py-2 rounded-xl outline-none border border-blue-100">
                <button onclick="exportData()" class="flex-grow bg-gray-900 text-white px-6 py-3 rounded-xl text-[10px] font-black shadow-lg">EXPORT DATABASE (.JSON)</button>
            </div>

            <div class="card">
                <label class="text-[10px] font-black text-gray-400 mb-2 block">MONTHLY INCOME (PAYDAY)</label>
                <input type="number" id="paydayInput" oninput="updateCalculation()" class="w-full text-4xl font-black text-blue-600 outline-none" placeholder="0.00">
            </div>

            <div id="fixed-container" class="card bg-blue-50/50 border-blue-100">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-[10px] font-black text-gray-500">FIXED & INVESTMENTS</span>
                    <button onclick="addItem('fixed')" class="text-blue-600 font-bold text-xl">+</button>
                </div>
                <div id="fixed-list" class="space-y-3"></div>
            </div>

            <div id="dynamic-container" class="card bg-orange-50/50 border-orange-100">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-[10px] font-black text-gray-500">VARIABLE EXPENSES</span>
                    <button onclick="addItem('dynamic')" class="text-orange-600 font-bold text-xl">+</button>
                </div>
                <div id="dynamic-list" class="space-y-3"></div>
            </div>
        </div>
    </main>

    <input type="file" id="fileInput" class="hidden" accept=".json" onchange="importData(event)">

    <script>
        let records = [];
        let currentMonth = new Date().toISOString().slice(0, 7);

        function switchTab(tab) {
            document.getElementById('tab-dashboard').classList.toggle('hidden', tab !== 'dashboard');
            document.getElementById('tab-edit').classList.toggle('hidden', tab !== 'edit');
            document.getElementById('btn-dashboard').className = tab === 'dashboard' ? 'px-4 py-2 rounded-lg bg-white shadow-sm text-blue-600' : 'px-4 py-2 rounded-lg text-gray-400';
            document.getElementById('btn-edit').className = tab === 'edit' ? 'px-4 py-2 rounded-lg bg-white shadow-sm text-blue-600' : 'px-4 py-2 rounded-lg text-gray-400';
            if (tab === 'dashboard') renderDashboard();
        }

        function renderDashboard() {
            if (records.length === 0) {
                document.getElementById('no-data').classList.remove('hidden');
                document.getElementById('dashboard-content').classList.add('hidden');
                return;
            }
            document.getElementById('no-data').classList.add('hidden');
            document.getElementById('dashboard-content').classList.remove('hidden');

            const latest = records[records.length - 1];
            const fixed = (latest.fixedItems || []).reduce((s, i) => s + (Number(i.amount) || 0), 0);
            const dynamic = (latest.dynamicItems || []).reduce((s, i) => s + (Number(i.amount) || 0), 0);
            const expense = fixed + dynamic;
            const surplus = Number(latest.payday || 0) - expense;

            document.getElementById('stat-income').innerText = Number(latest.payday).toLocaleString();
            document.getElementById('stat-expense').innerText = expense.toLocaleString();
            document.getElementById('stat-surplus').innerText = surplus.toLocaleString();
            document.getElementById('stat-surplus-card').style.backgroundColor = surplus >= 0 ? '#2563eb' : '#dc2626';
        }

        function addItem(type, name = '', amount = '') {
            const container = document.getElementById(type + '-list');
            const id = Date.now() + Math.random();
            const html = `
                <div id="item-${id}" class="flex gap-2">
                    <input type="text" value="${name}" oninput="updateRecord()" class="flex-grow p-3 rounded-xl text-sm font-bold border-none shadow-sm" placeholder="รายการ...">
                    <input type="number" value="${amount}" oninput="updateRecord()" class="w-24 p-3 rounded-xl text-sm font-black text-right border-none shadow-sm" placeholder="0">
                    <button onclick="document.getElementById('item-${id}').remove(); updateRecord();" class="text-gray-300 px-2">×</button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        function updateRecord() {
            const payday = document.getElementById('paydayInput').value;
            const fixedItems = Array.from(document.getElementById('fixed-list').children).map(el => ({
                name: el.querySelectorAll('input')[0].value,
                amount: el.querySelectorAll('input')[1].value
            }));
            const dynamicItems = Array.from(document.getElementById('dynamic-list').children).map(el => ({
                name: el.querySelectorAll('input')[0].value,
                amount: el.querySelectorAll('input')[1].value
            }));

            const record = { id: currentMonth, payday, fixedItems, dynamicItems };
            const idx = records.findIndex(r => r.id === currentMonth);
            if (idx > -1) records[idx] = record;
            else records.push(record);
            records.sort((a,b) => a.id.localeCompare(b.id));
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(records, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `finance_db_${currentMonth}.json`;
            a.click();
        }

        function importData(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                records = JSON.parse(ev.target.result);
                loadMonth(currentMonth);
                switchTab('dashboard');
            };
            reader.readAsText(file);
        }

        function loadMonth(m) {
            currentMonth = m;
            const r = records.find(rec => rec.id === m);
            document.getElementById('paydayInput').value = r ? r.payday : '';
            document.getElementById('fixed-list').innerHTML = '';
            document.getElementById('dynamic-list').innerHTML = '';
            
            if (r) {
                r.fixedItems.forEach(i => addItem('fixed', i.name, i.amount));
                r.dynamicItems.forEach(i => addItem('dynamic', i.name, i.amount));
            } else {
                addItem('fixed', 'รถ+คอนโด', '8963.01');
                addItem('fixed', 'DCA (VOO+SMH)', '3000.00');
                addItem('dynamic', 'ค่าน้ำมัน', '');
            }
        }

        document.getElementById('monthInput').value = currentMonth;
        document.getElementById('monthInput').onchange = (e) => loadMonth(e.target.value);
        loadMonth(currentMonth);
    </script>
</body>
</html>
