<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PS Smart Finance - Secured</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Apply dark mode before paint to prevent flash
        if (localStorage.getItem('ps_dark') === '1') {
            document.documentElement.classList.add('dark');
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=IBM+Plex+Mono:wght@400;500;600;700&display=optional" rel="stylesheet">
    <style>
        /* Prevent FOUT ‚Äî lock font size/weight immediately with system fallback that matches Inter metrics */
        body { font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    </style>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;700&family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --font-main: 'Inter', 'IBM Plex Sans Thai', system-ui, sans-serif;
            --font-mono: 'IBM Plex Mono', 'Courier New', monospace;
            --bg-dark: #f0f4f8;
            --bg-card: #ffffff;
            --bg-card2: #e8eef5;
            --border: #d0dce8;
            --accent: #0d9488;
            --accent2: #0f766e;
            --danger: #e11d48;
            --warning: #d97706;
            --text-primary: #0f2030;
            --text-secondary: #64748b;
            --text-dim: #94a3b8;
        }

        html.dark {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-card2: #162032;
            --border: #334155;
            --accent: #14b8a6;
            --accent2: #0d9488;
            --danger: #f43f5e;
            --warning: #f59e0b;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-dim: #64748b;
        }

        html.dark body {
            background-color: #0b1120;
            color: #e2e8f0;
        }

        /* NAV */
        html.dark nav {
            background: rgba(15,23,42,0.95) !important;
            border-color: #1e293b !important;
        }
        html.dark nav .bg-white\/90 { background: rgba(15,23,42,0.95) !important; }

        /* GLASS CARDS */
        html.dark .glass-card {
            background: #1e293b !important;
            border-color: #334155 !important;
        }

        /* TAB BUTTONS */
        html.dark .bg-gray-100 { background-color: #1e293b !important; }
        html.dark .tab-active {
            background: #0f172a !important;
            color: #38bdf8 !important;
        }

        /* DASHBOARD */
        html.dark #tab-dashboard {
            background: #111827 !important;
            border-color: #1e293b !important;
        }
        html.dark .dash-card {
            background: #1e293b !important;
            border-color: #334155 !important;
        }
        html.dark .dash-chart-card {
            background: #1e293b !important;
            border-color: #334155 !important;
        }
        html.dark .dash-select {
            background: #0f172a !important;
            border-color: #334155 !important;
            color: #14b8a6 !important;
        }
        html.dark .dash-label { color: var(--text-secondary) !important; }
        /* Only override dash-value that doesn't carry a color class */
        html.dark .dash-value:not(.dash-green):not(.dash-red):not(.dash-yellow) { color: var(--text-primary) !important; }
        html.dark .dash-section-title { color: var(--text-secondary) !important; }
        html.dark .dash-divider { border-color: #334155 !important; }

        /* RECORDS */
        html.dark .bg-white {
            background-color: #1e293b !important;
        }
        html.dark .bg-gray-50 {
            background-color: #162032 !important;
        }
        html.dark .border-gray-100 { border-color: #334155 !important; }
        html.dark .border-gray-200 { border-color: #334155 !important; }
        html.dark .text-gray-900 { color: #f1f5f9 !important; }
        html.dark .text-gray-700 { color: #cbd5e1 !important; }
        html.dark .text-gray-600 { color: #94a3b8 !important; }
        html.dark .text-gray-500 { color: #64748b !important; }
        html.dark .text-gray-400 { color: #475569 !important; }
        html.dark .text-gray-300 { color: #334155 !important; }

        /* INPUTS */
        html.dark input[type="text"],
        html.dark input[type="number"],
        html.dark input[type="month"],
        html.dark input[type="password"],
        html.dark select {
            background-color: #0f172a !important;
            border-color: #334155 !important;
            color: #f1f5f9 !important;
        }
        html.dark input::placeholder { color: #475569 !important; }

        /* WATCHLIST TABLE */
        html.dark table thead tr {
            background-color: #162032 !important;
        }
        html.dark .hover\:bg-gray-50:hover {
            background-color: #1e293b !important;
        }
        html.dark .border-gray-50 { border-color: #1e293b !important; }

        /* QUICK CHART */
        /* Fix input backgrounds in dark mode */
        html.dark input[type="month"] {
            background-color: transparent !important;
            color-scheme: dark;
        }
        html.dark #paydayDisplay {
            background-color: transparent !important;
            color: #60a5fa !important;
        }
        html.dark #month-picker-wrap {
            background-color: #0f172a !important;
        }
            background-color: #1e293b !important;
            border-color: #334155 !important;
        }
        html.dark #financial-bar .divide-gray-100 { border-color: #334155 !important; }
        html.dark #financial-bar > div { border-color: #334155 !important; }
        html.dark .md\:divide-x > * { border-color: #334155 !important; }
        html.dark .bg-gray-100.p-0\.5 {
            background-color: #0f172a !important;
        }

        /* MODALS */
        html.dark .bg-white.rounded-\[2rem\] {
            background-color: #1e293b !important;
        }

        /* BADGES */
        html.dark .bg-blue-50 { background-color: rgba(59,130,246,0.15) !important; }
        html.dark .bg-rose-50 { background-color: rgba(244,63,94,0.15) !important; }
        html.dark .bg-emerald-50 { background-color: rgba(16,185,129,0.12) !important; }
        html.dark .bg-purple-50 { background-color: rgba(168,85,247,0.15) !important; }
        html.dark .bg-teal-50 { background-color: rgba(20,184,166,0.12) !important; }
        html.dark .bg-gray-900 { background-color: #0f172a !important; }
        html.dark .row-paid { background-color: rgba(16,185,129,0.08) !important; }

        /* Watchlist tab full-width breakout */
        #tab-watchlist {
        }
        #wl-split-wrap {
            display: flex;
            gap: 0;
            align-items: flex-start;
        }
        #wl-split-wrap.chart-open {
            gap: 8px;
            min-height: calc(100vh - 98px);
            padding-bottom: 24px;
        }
        #wl-table-panel {
            flex: 1 1 auto;
            min-width: 0;
            transition: flex-basis 0.3s cubic-bezier(0.4,0,0.2,1), max-width 0.3s cubic-bezier(0.4,0,0.2,1);
        }
        #quick-chart-panel {
            flex: 0 0 0px;
            max-width: 0;
            overflow: hidden;
            opacity: 0;
            transition: flex-basis 0.3s cubic-bezier(0.4,0,0.2,1), max-width 0.3s cubic-bezier(0.4,0,0.2,1), opacity 0.2s ease;
        }

        /* ‚îÄ‚îÄ Chart open state ‚îÄ‚îÄ */
        #wl-split-wrap.chart-open #wl-table-panel {
            flex: 0 0 340px;
            max-width: 340px;
            display: flex;
            flex-direction: column;
        }
        /* Table card fills left panel ‚Äî exact same height as chart panel */
        #wl-split-wrap.chart-open #wl-table-panel .glass-card {
            flex: 1 1 auto;
            height: calc(100vh - 98px);
            max-height: calc(100vh - 98px);
            overflow-y: auto;
            overflow-x: hidden;
        }
        /* Chart panel: sticky full-viewport height */
        #wl-split-wrap.chart-open #quick-chart-panel {
            flex: 1 1 auto;
            max-width: 100%;
            opacity: 1;
            position: sticky;
            top: 98px;
            height: calc(100vh - 98px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-radius: 12px;
        }
        /* TV chart: 60% */
        #wl-split-wrap.chart-open #qc-tv-container {
            flex: 0 0 60%;
            min-height: 200px;
            overflow: hidden;
        }
        /* News: fills remaining 40%, internal scroll */
        #wl-split-wrap.chart-open #qc-news-panel {
            flex: 1 1 0;
            min-height: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-top: 1px solid var(--border);
        }
        #wl-split-wrap.chart-open #qc-news-list {
            flex: 1 1 0;
            min-height: 0;
            overflow-y: auto;
        }
        /* Hide extra columns when compact */
        #wl-split-wrap.chart-open .wl-col-hide { display: none !important; }
        #wl-split-wrap.chart-open #watchlist-table { min-width: unset !important; }
        /* In compact mode name column truncates to fit */
        #wl-split-wrap.chart-open td:nth-child(3),
        #wl-split-wrap.chart-open th:nth-child(3) {
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ‚îÄ‚îÄ Skeleton shimmer for loading rows ‚îÄ‚îÄ */
        @keyframes shimmer {
            0%   { background-position: -400px 0; }
            100% { background-position: 400px 0; }
        }
        .skeleton-cell {
            display: inline-block;
            height: 10px;
            border-radius: 4px;
            background: linear-gradient(90deg, var(--border) 25%, var(--bg-card2) 50%, var(--border) 75%);
            background-size: 400px 100%;
            animation: shimmer 1.4s ease infinite;
        }

        /* AI chat typing indicator */
        @keyframes blink { 0%,100%{opacity:0} 50%{opacity:1} }
        .ai-typing .dots { animation: blink 1.2s infinite; }
        .ai-cursor { display:inline-block; animation: blink 0.7s infinite; color:#4285f4; font-weight:bold; margin-left:1px; }

        /* Market news grid ‚Äî must not overflow card width */
        #market-news-grid {
            min-width: 0;
            width: 100%;
            overflow: hidden;
        }
        #market-news-grid > * {
            min-width: 0;
            overflow: hidden;
        }

        /* Watchlist table inner scroll ‚Äî scrollbar stays inside card, doesn't affect outer width */
        #wl-table-panel .glass-card > div[style*="overflow-x"] {
            overflow-x: auto;
            overflow-y: hidden;
            scrollbar-gutter: auto;
        }

        /* Consistent scrollbar for both modes ‚Äî prevents layout shift */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        html.dark ::-webkit-scrollbar-track { background: #0f172a; }
        html.dark ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        html.dark ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* DARK TOGGLE BUTTON */
        .dark-toggle {
            width: 40px; height: 22px;
            background: #e2e8f0;
            border-radius: 11px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
            border: none;
            outline: none;
            flex-shrink: 0;
        }
        .dark-toggle::after {
            content: '';
            position: absolute;
            width: 16px; height: 16px;
            background: white;
            border-radius: 50%;
            top: 3px; left: 3px;
            transition: transform 0.3s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        html.dark .dark-toggle {
            background: #0d9488;
        }
        html.dark .dark-toggle::after {
            transform: translateX(18px);
        }

        body { 
            font-family: var(--font-main); 
            background-color: #f8fafc; 
            color: #1e293b;
            overflow-y: auto;
        }

        /* ‚îÄ‚îÄ Watchlist table font ‚Äî uniform Inter weight 500 ‚îÄ‚îÄ */
        #watchlist-table th {
            font-family: var(--font-main);
            font-weight: 500;
            font-size: 9px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-dim);
        }
        #watchlist-table td {
            font-family: var(--font-main);
            font-weight: 500;
            font-size: 12px;
            color: var(--text-secondary);
        }
        /* Fix: td color override must yield to explicit color classes ‚Äî use !important on color utilities */
        #watchlist-table td.text-emerald-600 { color: #059669 !important; }
        #watchlist-table td.text-rose-500    { color: #f43f5e !important; }
        #watchlist-table td.text-gray-300    { color: #94a3b8 !important; }
        html.dark #watchlist-table td.text-emerald-600 { color: #34d399 !important; }
        html.dark #watchlist-table td.text-rose-500    { color: #fb7185 !important; }
        /* Symbol ‚Äî slightly bolder for quick scan */
        #watchlist-table .sym-cell {
            font-weight: 600;
            letter-spacing: 0.02em;
        }
        /* Price/numbers ‚Äî mono font for alignment */
        #watchlist-table .price-cell,
        #watchlist-table .num-cell {
            font-family: var(--font-mono);
            font-weight: 500;
        }

        #tab-dashboard {
            background: #f0f4f8;
            border-radius: 1.5rem;
            padding: 1.25rem 1rem 1rem 1rem;
            border: 1px solid #d0dce8;
            margin-top: 12px;
        }

        .dash-card {
            background: #ffffff;
            border: 1px solid #d0dce8;
            border-radius: 0.75rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(13,148,136,0.06);
        }

        .dash-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, #0d9488, #14b8a6, #0d9488);
            opacity: 0.5;
        }

        .dash-label {
            font-family: var(--font-mono);
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.12em;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .dash-value {
            font-family: var(--font-mono);
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }

        .dash-accent { color: #0d9488; }
        .dash-green { color: #0d9488; }
        .dash-red { color: #e11d48; }
        .dash-yellow { color: #d97706; }

        .dash-divider {
            border-color: #d0dce8;
        }

        .dash-chart-card {
            background: #ffffff;
            border: 1px solid #d0dce8;
            border-radius: 0.75rem;
            box-shadow: 0 1px 4px rgba(13,148,136,0.06);
        }

        .dash-select {
            background: #f0f4f8;
            border: 1px solid #d0dce8;
            color: #0d9488;
            font-family: var(--font-mono);
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.05em;
            padding: 4px 10px;
            border-radius: 4px;
            outline: none;
            cursor: pointer;
        }

        .dash-section-title {
            font-family: var(--font-mono);
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.12em;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .ticker-line {
            height: 2px;
            background: linear-gradient(90deg, #0d9488 0%, #14b8a6 50%, transparent 100%);
            opacity: 0.4;
            margin-bottom: 1.5rem;
            border-radius: 2px;
        }

        .glass-card { 
            background: white; 
            border-radius: 1.5rem; 
            border: 1px solid #f1f5f9; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); 
        }
        
        .tab-active { 
            background: white; 
            color: #2563eb; 
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.1); 
        }

        .thai-label {
            font-size: 0.85rem;
            font-weight: 800;
            color: #64748b;
            letter-spacing: 0.025em;
            line-height: 1;
        }

        .animate-in {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .summary-badge {
            display: inline-block;
            min-width: 80px;
            white-space: nowrap;
            text-align: right;
            padding: 0.375rem 0.75rem;
            border-radius: 0.5rem;
            font-weight: 900;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .row-paid {
            opacity: 0.6;
            background-color: #f0fdf4 !important;
        }
        .row-paid input {
            background-color: transparent !important;
        }

        .ref-badge {
            font-size: 10px;
            font-weight: 700;
            color: #94a3b8;
            background: none;
            padding: 0;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            margin-left: 8px;
            line-height: 1;
        }

        /* Modal Background */
        #confirm-modal {
            background-color: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="min-h-screen pb-20">
<script>
// Pre-load avatar before first paint to prevent blank flash
(function(){
    try {
        var av = localStorage.getItem('ps_avatar');
        if (av) {
            // Inject style that sets avatar as background immediately
            var s = document.createElement('style');
            s.id = 'avatar-preload';
            s.textContent = '#avatarImg{content:url("' + av + '");display:block!important}#avatarPlaceholder{display:none!important}';
            document.head.appendChild(s);
        }
    } catch(e) {}
})();
</script>

    <!-- Gist Token Modal -->
    <div id="gist-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div style="background-color:rgba(15,23,42,0.6);backdrop-filter:blur(4px)" class="fixed inset-0"></div>
        <div class="bg-white rounded-[2rem] max-w-sm w-full p-8 shadow-2xl animate-in relative z-10">
            <div class="w-16 h-16 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>
            </div>
            <h3 class="text-xl font-black text-gray-900 text-center mb-1">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ GitHub Gist</h3>
            <p class="text-gray-400 text-center text-xs mb-6 leading-relaxed">‡πÉ‡∏™‡πà GitHub Token ‡πÄ‡∏û‡∏∑‡πà‡∏≠ sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≤‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå<br>Token ‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô browser ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
            <div class="space-y-3">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">GitHub Token</label>
                    <input type="password" id="gist-token-input" placeholder="ghp_xxxxxxxxxxxx" class="w-full mt-1 px-4 py-3 border border-gray-200 rounded-xl text-sm font-medium outline-none focus:border-blue-400 transition-all">
                </div>
            </div>
            <div class="flex flex-col gap-2 mt-6">
                <button onclick="saveGistToken()" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-bold transition-all active:scale-95 uppercase text-xs tracking-widest">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
                <button onclick="document.getElementById('gist-modal').classList.add('hidden')" class="w-full py-4 bg-gray-100 hover:bg-gray-200 text-gray-500 rounded-2xl font-bold transition-all uppercase text-xs tracking-widest">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] max-w-sm w-full p-8 shadow-2xl animate-in">
            <div class="w-16 h-16 bg-rose-50 text-rose-500 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            </div>
            <h3 class="text-xl font-black text-gray-900 text-center mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?</h3>
            <p class="text-gray-500 text-center text-sm mb-8 leading-relaxed">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö-‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô <span id="modal-month-name" class="font-bold text-gray-900 underline"></span> ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ</p>
            <div class="flex flex-col gap-2">
                <button onclick="executeClear()" class="w-full py-4 bg-rose-500 hover:bg-rose-600 text-white rounded-2xl font-bold transition-all active:scale-95 shadow-lg shadow-rose-100 uppercase text-xs tracking-widest">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
                <button onclick="closeModal()" class="w-full py-4 bg-gray-100 hover:bg-gray-200 text-gray-500 rounded-2xl font-bold transition-all uppercase text-xs tracking-widest">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- Header & Navigation -->
    <nav class="fixed top-0 left-0 right-0 z-50 border-b" style="background:var(--bg-card);border-color:var(--border);backdrop-filter:blur(12px)">
        <div class="w-full px-4 h-24 flex items-center justify-between gap-3">
            <!-- Left: Avatar + brand -->
            <div class="flex items-center gap-3 flex-shrink-0">
                <div onclick="document.getElementById('avatarInput').click()" title="Click to change profile picture"
                    style="width:88px;height:88px;border-radius:50%;border:2.5px solid #2563eb;overflow:hidden;cursor:pointer;flex-shrink:0;background:#eff6ff;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 12px rgba(37,99,235,0.2);"
                    onmouseover="this.style.borderColor='#1d4ed8'" onmouseout="this.style.borderColor='#2563eb'">
                    <img id="avatarImg" src="" alt="avatar" style="width:100%;height:100%;object-fit:cover;display:none;">
                    <svg id="avatarPlaceholder" xmlns="http://www.w3.org/2000/svg" style="width:44px;height:44px;color:#93c5fd;" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z"/>
                    </svg>
                </div>
                <input type="file" id="avatarInput" accept="image/*" style="display:none;" onchange="handleAvatar(event)">
                <div>
                    <div class="font-black text-base tracking-tight leading-none uppercase" style="color:#2563eb;font-family:var(--font-main)">PS SMART FINANCE</div>
                    <div class="flex items-center gap-1.5 mt-1">
                        <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>
                        <div id="db-name-display" class="text-[10px] font-bold uppercase tracking-widest leading-none" style="color:var(--text-dim);max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">Ready</div>
                    </div>
                    <div class="text-[8px] font-bold uppercase tracking-widest mt-0.5" style="color:var(--text-dim);opacity:0.5">v2026.03.02-r29</div>
                </div>
            </div>
            
            <!-- Right: Tabs + controls -->
            <div class="flex items-center gap-1.5 flex-shrink-0">
                <!-- Tabs -->
                <div class="flex gap-0.5 p-1 rounded-xl" style="background:var(--bg-card2)">
                    <button onclick="showTab('dashboard')" id="btn-dash" class="px-4 py-1.5 rounded-lg text-[11px] font-bold tab-active transition-all uppercase tracking-wide" style="font-family:var(--font-main)">Dashboard</button>
                    <button onclick="showTab('edit')" id="btn-edit" class="px-4 py-1.5 rounded-lg text-[11px] font-bold transition-all uppercase tracking-wide" style="color:var(--text-dim);font-family:var(--font-main)">Records</button>
                    <button onclick="showTab('watchlist')" id="btn-watchlist" class="px-4 py-1.5 rounded-lg text-[11px] font-bold transition-all uppercase tracking-wide flex items-center gap-1" style="color:var(--text-dim);font-family:var(--font-main)">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                        Watchlist
                    </button>
                </div>
                <!-- Divider -->
                <div class="w-px h-5" style="background:var(--border)"></div>
                <!-- Import/Export -->
                <div class="flex gap-0.5 p-1 rounded-xl" style="background:var(--bg-card2)">
                    <button onclick="document.getElementById('fileInput').click()" title="Import JSON" class="px-2.5 py-1.5 rounded-lg transition-all flex items-center" style="color:var(--text-dim)">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                    </button>
                    <button onclick="exportJSON()" title="Export JSON" class="px-2.5 py-1.5 rounded-lg transition-all flex items-center" style="color:var(--text-dim)">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    </button>
                </div>
                <!-- Divider -->
                <div class="w-px h-5" style="background:var(--border)"></div>
                <!-- Sync / Upload -->
                <div class="flex gap-0.5 p-1 rounded-xl" style="background:var(--bg-card2)">
                    <button onclick="syncFromGist()" class="px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all uppercase tracking-wider flex items-center gap-1" style="color:var(--text-dim);font-family:var(--font-main)">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                        Sync
                    </button>
                    <button onclick="syncToGist()" class="tab-active px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all uppercase tracking-wider flex items-center gap-1" style="font-family:var(--font-main)">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                        Upload
                    </button>
                </div>
                <!-- Divider -->
                <div class="w-px h-5" style="background:var(--border)"></div>
                <!-- Dark Mode Toggle -->
                <div class="flex items-center gap-1.5" title="Dark Mode">
                    <svg class="w-3 h-3 text-amber-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm0 16a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zm8-8a1 1 0 110 2h-1a1 1 0 110-2h1zM4 12a1 1 0 110 2H3a1 1 0 110-2h1zm13.66-5.66a1 1 0 010 1.41l-.71.71a1 1 0 11-1.41-1.41l.71-.71a1 1 0 011.41 0zM7.05 16.95a1 1 0 010 1.41l-.71.71a1 1 0 01-1.41-1.41l.71-.71a1 1 0 011.41 0zM17.66 16.95a1 1 0 00-1.41 0l-.71.71a1 1 0 001.41 1.41l.71-.71a1 1 0 000-1.41zM7.05 7.05a1 1 0 00-1.41 0l-.71.71a1 1 0 001.41 1.41l.71-.71a1 1 0 000-1.41zM12 7a5 5 0 100 10A5 5 0 0012 7z"/></svg>
                    <button onclick="toggleDarkMode()" class="dark-toggle"></button>
                    <svg class="w-3 h-3 text-slate-400" fill="currentColor" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
                </div>
            </div>
        </div>
    </nav>

    <main class="w-full px-4 pt-24">
        
        <!-- DASHBOARD TAB -->
        <div id="tab-dashboard" class="space-y-5">
            <div id="dash-content" class="hidden space-y-5">

                <!-- 4 Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                    <!-- Current Balance -->
                    <div id="surplus-card-main" class="dash-card p-5">
                        <div class="dash-label mb-2">Current Balance</div>
                        <div id="dash-surplus" class="dash-value text-3xl dash-green mb-1">0.00</div>
                        <div id="mom-change" class="hidden" style="font-family:var(--font-mono);font-size:10px;color:var(--text-secondary);margin-bottom:8px;"></div>
                        <div class="border-t dash-divider pt-3 flex justify-between items-center">
                            <span id="status-text" style="font-family:var(--font-mono);font-size:11px;font-weight:700;letter-spacing:0.08em;color:var(--accent2);">‚Äî</span>
                            <span id="current-month-label" style="font-family:var(--font-mono);font-size:10px;color:var(--text-secondary);">‚Äî</span>
                        </div>
                    </div>
                    <!-- YTD Income -->
                    <div class="dash-card p-5">
                        <div class="dash-label mb-1">YTD Earnings</div>
                        <div id="ytd-year-income" style="font-family:var(--font-mono);font-size:10px;color:var(--text-dim);margin-bottom:6px;">‚Äî</div>
                        <div id="ytd-income" class="dash-value text-2xl dash-green">0.00</div>
                    </div>
                    <!-- YTD Expense -->
                    <div class="dash-card p-5">
                        <div class="dash-label mb-1">YTD Expenses</div>
                        <div id="ytd-year-expense" style="font-family:var(--font-mono);font-size:10px;color:var(--text-dim);margin-bottom:6px;">‚Äî</div>
                        <div id="ytd-expense" class="dash-value text-2xl dash-red">0.00</div>
                    </div>
                    <!-- Savings Rate -->
                    <div class="dash-card p-5">
                        <div class="dash-label mb-1">Savings Rate</div>
                        <div id="ytd-year-savings" style="font-family:var(--font-mono);font-size:10px;color:var(--text-dim);margin-bottom:6px;">‚Äî</div>
                        <div id="ytd-savings-rate" class="dash-value text-2xl dash-yellow">0%</div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div class="dash-chart-card p-5">
                        <div class="flex justify-between items-center mb-5">
                            <span class="dash-section-title">Trend Comparison</span>
                            <select id="compareRange" onchange="updateDashboard()" class="dash-select">
                                <option value="2" selected>Last Month</option>
                                <option value="6">Last 6 Months</option>
                                <option value="12">Last 12 Months</option>
                            </select>
                        </div>
                        <div class="h-64"><canvas id="compareChart"></canvas></div>
                    </div>
                    <div class="dash-chart-card p-5">
                        <div class="dash-section-title mb-5 text-center">Distribution</div>
                        <div class="h-64 flex justify-center items-center"><canvas id="distChart"></canvas></div>
                    </div>
                </div>
            </div>

            <div class="dash-card p-12 text-center max-w-xl mx-auto hidden" id="empty-state">
                <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4" style="background:rgba(13,148,136,0.12);border:1px solid var(--border);">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color:#0d9488"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                </div>
                <h3 style="color:var(--text-primary);font-family:var(--font-mono);" class="font-bold text-lg mb-2">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
                <p style="color:var(--text-secondary);" class="text-sm mb-6">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏ô‡∏π RECORDS ‡∏´‡∏£‡∏∑‡∏≠ Import ‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà</p>
                <div class="flex flex-col sm:flex-row gap-2 justify-center">
                    <button onclick="showTab('edit')" style="background:#0d9488;color:#fff;font-family:var(--font-mono);font-weight:700;" class="px-8 py-3 rounded-xl text-xs uppercase tracking-widest transition-all active:scale-95">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    <button onclick="document.getElementById('fileInput').click()" style="background:var(--bg-card2);color:var(--text-secondary);border:1px solid var(--border);font-family:var(--font-mono);" class="px-8 py-3 rounded-xl text-xs uppercase tracking-widest font-bold transition-all active:scale-95">Import Data</button>
                </div>
            </div>
        </div>

        <!-- RECORDS TAB -->
        <div id="tab-edit" class="hidden space-y-4 pt-3">
            <div class="flex flex-wrap gap-4 items-center justify-between bg-white p-4 rounded-3xl border border-gray-100" id="records-toolbar">
                <div class="flex items-center gap-4">
                    <div class="flex items-center bg-gray-50 rounded-xl px-2" id="month-picker-wrap">
                        <button onclick="stepMonth(-1)" class="p-2 text-blue-600 hover:bg-blue-100 rounded-lg transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <input type="month" id="monthInput" onchange="loadMonth(this.value)" class="bg-transparent border-none font-black text-blue-600 outline-none text-lg px-2">
                        <button onclick="stepMonth(1)" class="p-2 text-blue-600 hover:bg-blue-100 rounded-lg transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="clonePreviousMonth()" class="text-blue-600 text-[10px] font-bold px-3 py-1.5 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors uppercase">Pull Last Data</button>
                        
                        <div class="relative group">
                            <!-- Clear Button with Tooltip/Lock mechanism -->
                            <button id="clear-btn" onclick="requestClear()" class="text-rose-600 text-[10px] font-bold px-3 py-1.5 bg-rose-50 rounded-lg hover:bg-rose-100 disabled:bg-gray-50 disabled:text-gray-300 disabled:cursor-not-allowed transition-colors uppercase flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                Clear Month
                            </button>
                            <div id="lock-tooltip" class="absolute -top-8 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-[8px] py-1 px-2 rounded opacity-0 pointer-events-none group-hover:opacity-100 transition-opacity whitespace-nowrap">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Ñ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FINANCIAL BAR -->
            <div class="glass-card overflow-hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 divide-y md:divide-y-0 md:divide-x divide-gray-100" id="financial-bar">
                    <div class="p-6" id="income-cell">
                        <p class="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-1">Monthly Income (‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö)</p>
                        <div class="flex items-center gap-2">
                            <span class="text-xl font-black text-blue-600">‡∏ø</span>
                            <input type="text" id="paydayDisplay" oninput="handleCurrencyInput(this, 'paydayVal')" onpaste="handlePaste(event, this, 'paydayVal')" onblur="handleBlur(this, 'paydayVal')" class="w-full text-2xl font-black text-blue-600 outline-none bg-transparent" placeholder="0.00">
                            <input type="hidden" id="paydayVal">
                        </div>
                    </div>
                    <div class="p-6">
                        <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Total Expenses (‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢)</p>
                        <div id="sum-total-exp" class="text-2xl font-black text-rose-500">‡∏ø 0.00</div>
                    </div>
                    <div id="record-balance-card" class="p-6 transition-colors duration-300">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-[10px] font-black uppercase tracking-widest opacity-60 mb-1">Balance (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠)</p>
                                <div id="record-balance-val" class="text-2xl font-black">‡∏ø 0.00</div>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] font-black uppercase tracking-widest opacity-60 mb-1">Saving Rate</p>
                                <div id="current-saving-rate" class="inline-block px-3 py-1 rounded-lg text-sm font-black" style="background:rgba(13,148,136,0.12);color:#0d9488">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- List Columns -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <div class="flex items-center justify-between px-2 min-h-[40px]">
                        <div class="flex flex-col gap-0.5">
                            <div class="flex items-center gap-2">
                                <h4 class="thai-label uppercase">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥ / ‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô</h4>
                            </div>
                            <div class="flex items-center gap-2">
                                <span id="last-fixed-ref" class="ref-badge" style="margin-left:0">LAST MONTH: -</span>
                                <button onclick="toggleCheckAll('fixed', this)" class="text-[9px] font-bold text-gray-300 hover:text-blue-500 transition-colors uppercase tracking-wide border border-gray-200 hover:border-blue-300 rounded px-1.5 py-0.5">Uncheck All</button>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-1" style="min-width:120px">
                            <span id="sum-fixed" class="summary-badge w-full text-center text-rose-500 bg-rose-50 border border-rose-100">‡∏ø 0.00</span>
                            <div id="paid-fixed-badge" class="w-full text-center text-[10px] font-bold text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded border border-emerald-100" style="visibility:hidden">PAID: ‡∏ø 0.00</div>
                        </div>
                    </div>
                    <div id="fixed-list" class="space-y-2"></div>
                    <button onclick="addInput('fixed')" class="w-full py-3 border-2 border-dashed border-gray-200 rounded-xl text-gray-400 font-bold hover:border-blue-400 hover:text-blue-500 transition-all text-xs uppercase tracking-widest">+ Add Fixed Expense</button>
                </div>

                <div class="space-y-4">
                    <div class="flex items-center justify-between px-2 min-h-[40px]">
                        <div class="flex flex-col gap-0.5">
                            <div class="flex items-center gap-2">
                                <h4 class="thai-label uppercase">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ú‡∏±‡∏ô‡πÅ‡∏õ‡∏£</h4>
                            </div>
                            <div class="flex items-center gap-2">
                                <span id="last-dynamic-ref" class="ref-badge" style="margin-left:0">LAST MONTH: -</span>
                                <button onclick="toggleCheckAll('dynamic', this)" class="text-[9px] font-bold text-gray-300 hover:text-orange-500 transition-colors uppercase tracking-wide border border-gray-200 hover:border-orange-300 rounded px-1.5 py-0.5">Uncheck All</button>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-1" style="min-width:120px">
                            <span id="sum-dynamic" class="summary-badge w-full text-center text-rose-500 bg-rose-50 border border-rose-100">‡∏ø 0.00</span>
                            <div id="paid-dynamic-badge" class="w-full text-center text-[10px] font-bold text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded border border-emerald-100" style="visibility:hidden">PAID: ‡∏ø 0.00</div>
                        </div>
                    </div>
                    <div id="dynamic-list" class="space-y-2"></div>
                    <button onclick="addInput('dynamic')" class="w-full py-3 border-2 border-dashed border-gray-200 rounded-xl text-gray-400 font-bold hover:border-orange-400 hover:text-orange-500 transition-all text-xs uppercase tracking-widest">+ Add Variable Expense</button>
                </div>
            </div>
        </div>

        <!-- WATCHLIST TAB -->
        <div id="tab-watchlist" class="hidden space-y-3 animate-in pt-3">

            <!-- Finnhub Token Modal -->
            <div id="finnhub-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
                <div style="background-color:rgba(15,23,42,0.6);backdrop-filter:blur(4px)" class="fixed inset-0"></div>
                <div class="bg-white rounded-[2rem] max-w-sm w-full p-8 shadow-2xl animate-in relative z-10">
                    <div class="w-16 h-16 bg-teal-50 rounded-full flex items-center justify-center mx-auto mb-6">
                        <svg class="w-8 h-8 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                    </div>
                    <h3 class="text-xl font-black text-gray-900 text-center mb-1">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Finnhub</h3>
                    <p class="text-gray-400 text-center text-xs mb-6 leading-relaxed">‡πÉ‡∏™‡πà Finnhub API Key ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏∏‡πâ‡∏ô‡∏™‡∏´‡∏£‡∏±‡∏ê<br>Key ‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô browser ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                    <input type="password" id="finnhub-key-input" placeholder="xxxxxxxxxxxxxxxxxxxxxxxx" class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm font-medium outline-none focus:border-teal-400 transition-all mb-4">
                    <div class="flex flex-col gap-2">
                        <button onclick="saveFinnhubKey()" class="w-full py-4 bg-teal-600 hover:bg-teal-700 text-white rounded-2xl font-bold transition-all active:scale-95 uppercase text-xs tracking-widest">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
                        <button onclick="document.getElementById('finnhub-modal').classList.add('hidden')" class="w-full py-4 bg-gray-100 hover:bg-gray-200 text-gray-500 rounded-2xl font-bold transition-all uppercase text-xs tracking-widest">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </div>
            </div>

            <!-- Header -->
            <div class="flex items-center gap-3">
                <!-- Left: title + status -->
                <div class="flex items-center gap-3 flex-shrink-0">
                    <h3 class="font-black text-base uppercase tracking-tight" style="color:var(--text-primary);font-family:var(--font-main)">Watchlist</h3>
                    <span id="wl-last-update" class="text-[9px] font-bold uppercase tracking-widest" style="color:var(--text-dim)"></span>
                    <span id="wl-market-status" class="text-[9px] font-bold px-2 py-0.5 rounded-full uppercase tracking-widest"></span>
                </div>

                <!-- USD/THB FX Widget ‚Äî compact Dime style -->
                <div id="fx-widget" class="flex items-center gap-1.5 flex-shrink-0">
                    <!-- USD‚ÜíTHB: ‡∏Ç‡∏≤‡∏¢ 1 USD ‡πÑ‡∏î‡πâ XX THB -->
                    <div class="flex flex-col justify-center px-2.5 py-1.5 rounded-xl border" style="background:var(--bg-card2);border-color:var(--border);height:36px;min-width:105px">
                        <div class="flex items-center gap-1">
                            <span class="text-[8px] font-semibold leading-none" style="color:var(--text-dim)">üá∫üá∏‚Üíüáπüá≠ USD‚ÜíTHB</span>
                        </div>
                        <div class="flex items-baseline gap-1.5 mt-0.5">
                            <span id="fx-change" class="text-[9px] font-bold" style="color:#22c55e;font-family:var(--font-mono)">‚Üë 0.00%</span>
                            <span id="fx-rate" class="text-[12px] font-black leading-none" style="color:var(--text-primary);font-family:var(--font-mono);font-variant-numeric:tabular-nums">‚Äî</span>
                            <span class="text-[8px] font-semibold" style="color:var(--text-dim)">THB</span>
                        </div>
                    </div>
                    <!-- THB‚ÜíUSD: ‡∏ã‡∏∑‡πâ‡∏≠ 1 USD ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ XX THB (always slightly higher = spread) -->
                    <div class="flex flex-col justify-center px-2.5 py-1.5 rounded-xl border" style="background:var(--bg-card2);border-color:var(--border);height:36px;min-width:105px">
                        <div class="flex items-center gap-1">
                            <span class="text-[8px] font-semibold leading-none" style="color:var(--text-dim)">üáπüá≠‚Üíüá∫üá∏ THB‚ÜíUSD</span>
                        </div>
                        <div class="flex items-baseline gap-1.5 mt-0.5">
                            <span id="fx-change-inv" class="text-[9px] font-bold" style="color:#22c55e;font-family:var(--font-mono)">‚Üë 0.00%</span>
                            <span id="fx-rate-inv" class="text-[12px] font-black leading-none" style="color:var(--text-primary);font-family:var(--font-mono);font-variant-numeric:tabular-nums">‚Äî</span>
                            <span class="text-[8px] font-semibold" style="color:var(--text-dim)">THB</span>
                        </div>
                    </div>
                </div>

                <!-- AI Chat input ‚Äî stretches to fill remaining space -->
                <div class="flex items-center gap-2 flex-1 min-w-0 rounded-xl px-3 py-1.5 border" style="background:var(--bg-card2);border-color:var(--border)">
                    <div class="w-5 h-5 rounded-md flex items-center justify-center flex-shrink-0" style="background:linear-gradient(135deg,#6366f1,#8b5cf6)">
                        <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.347.347a3.5 3.5 0 01-4.95 0l-.347-.347z"/></svg>
                    </div>
                    <input id="ai-input" type="text" placeholder="‡∏ñ‡∏≤‡∏° AI ‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå... ‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏ô‡∏ß‡∏£‡∏±‡∏ö NVDA, outlook TSLA ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ"
                        class="flex-1 min-w-0 text-xs outline-none bg-transparent"
                        style="color:var(--text-primary);font-family:var(--font-main)"
                        onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendAiMessage()}">
                    <button onclick="sendAiMessage()" id="ai-send-btn"
                        class="flex items-center gap-1 px-3 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wider flex-shrink-0 transition-all"
                        style="background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                        ‡∏™‡πà‡∏á
                    </button>
                </div>

                <!-- Right: Refresh + Add -->
                <div class="flex items-center gap-2 flex-shrink-0">
                    <button onclick="refreshWatchlist()" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all uppercase tracking-wider" style="background:var(--bg-card2);color:var(--text-secondary);border:1px solid var(--border);font-family:var(--font-main)">
                        <svg id="wl-refresh-icon" class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                        Refresh
                    </button>
                    <button onclick="showAddTickerInput()" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all uppercase tracking-wider" style="background:#14b8a6;color:#fff;font-family:var(--font-main)">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        Add
                    </button>
                </div>
            </div>

            <!-- Add ticker input ‚Äî Webull style -->
            <div id="add-ticker-bar" class="hidden rounded-xl p-3 flex items-center gap-2 relative" style="background:var(--bg-card2);border:1px solid var(--border)">
                <div class="flex-grow relative">
                    <div class="absolute left-3 top-1/2 -translate-y-1/2" style="color:var(--text-dim)">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    </div>
                    <input type="text" id="ticker-input" placeholder="Search symbol e.g. NVDA, AAPL, SPY"
                        class="w-full pl-10 pr-4 py-2 rounded-lg text-sm font-semibold outline-none transition-all"
                        style="background:var(--bg-card);border:1.5px solid var(--border);color:var(--text-primary);font-family:var(--font-main);text-transform:uppercase;letter-spacing:0.03em"
                        onfocus="this.style.borderColor='#14b8a6'" onblur="this.style.borderColor='var(--border)'"
                        oninput="onTickerInput(this.value)"
                        onkeydown="onTickerKeydown(event)"
                        autocomplete="off">
                    <div id="ticker-dropdown" class="hidden absolute top-full left-0 right-0 mt-1 rounded-xl shadow-2xl z-50 overflow-hidden max-h-64 overflow-y-auto" style="background:var(--bg-card);border:1px solid var(--border)"></div>
                </div>
                <button onclick="addTicker()" class="px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider flex-shrink-0 transition-all" style="background:#14b8a6;color:#fff;font-family:var(--font-main)">Add</button>
                <button onclick="closeAddTicker()" class="flex-shrink-0 transition-colors" style="color:var(--text-dim)">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>

            <!-- Watchlist Split Layout -->
            <div id="wl-split-wrap">

            <!-- Watchlist Table -->
            <div id="wl-table-panel">
            <div class="glass-card overflow-hidden">
                <div style="overflow-x:auto;overflow-y:hidden;scrollbar-gutter:auto">
                <table id="watchlist-table" class="w-full min-w-[700px]">
                    <thead>
                        <tr class="border-b" style="border-color:var(--border);background:var(--bg-card2)">
                            <th class="px-3 py-2 text-left text-[9px] font-medium uppercase tracking-widest" style="color:var(--text-secondary) w-8">#</th>
                            <th class="px-3 py-2 text-left text-[9px] font-medium uppercase tracking-widest" style="color:var(--text-secondary)">Symbol</th>
                            <th id="wl-th-name" class="px-3 py-2 text-left text-[9px] font-medium uppercase tracking-widest" style="color:var(--text-secondary)">Name</th>
                            <th id="wl-th-price" class="px-3 py-2 text-right text-[9px] font-medium uppercase tracking-widest" style="color:var(--text-secondary)">Price</th>
                            <th class="px-3 py-2 text-right text-[9px] font-medium uppercase tracking-widest" style="color:var(--text-secondary) wl-col-hide">Change</th>
                            <th class="px-3 py-2 text-right text-[9px] font-medium uppercase tracking-widest" style="color:var(--text-secondary)">% Change</th>
                            <th class="px-3 py-2 text-right text-[9px] font-medium uppercase tracking-widest" style="color:var(--text-secondary) wl-col-hide">Open</th>
                            <th class="px-3 py-2 text-right text-[9px] font-medium uppercase tracking-widest" style="color:var(--text-secondary) wl-col-hide">Prev Close</th>
                            <th class="px-3 py-2 text-right text-[9px] font-medium uppercase tracking-widest" style="color:var(--text-secondary) wl-col-hide">High</th>
                            <th class="px-3 py-2 text-right text-[9px] font-medium uppercase tracking-widest" style="color:var(--text-secondary) wl-col-hide">Low</th>
                            <th class="px-3 py-2 text-right text-[9px] font-medium uppercase tracking-widest" style="color:var(--text-secondary) wl-col-hide">52W High</th>
                            <th class="px-3 py-2 text-right text-[9px] font-medium uppercase tracking-widest" style="color:var(--text-secondary) wl-col-hide">52W Low</th>
                            <th class="px-3 py-2 text-right text-[9px] font-medium uppercase tracking-widest" style="color:var(--text-secondary) wl-col-hide">Mkt Cap</th>
                            <th class="px-3 py-2 text-right text-[9px] font-medium uppercase tracking-widest" style="color:var(--text-secondary) wl-col-hide">Avg Vol 10D</th>
                            <th class="px-3 py-2 text-right text-[9px] font-medium uppercase tracking-widest" style="color:var(--text-secondary) wl-col-hide">Beta</th>
                            <th class="px-3 py-2 text-right text-[9px] font-medium uppercase tracking-widest" style="color:var(--text-secondary) wl-col-hide">P/E</th>
                            <th class="px-3 py-2 text-right text-[9px] font-medium uppercase tracking-widest" style="color:var(--text-secondary) wl-col-hide">Div Yield</th>
                            <th class="px-2 py-2 w-8"></th>
                        </tr>
                    </thead>
                    <tbody id="watchlist-rows">
                        <tr id="wl-empty">
                            <td colspan="11" class="py-16 text-center">
                                <svg class="w-10 h-10 text-gray-200 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                                <p class="text-gray-300 text-sm font-bold uppercase tracking-widest">No stocks added yet</p>
                                <p class="text-gray-300 text-xs mt-1">‡∏Å‡∏î Add ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏∏‡πâ‡∏ô</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
                </div><!-- /overflow-x scroll wrapper -->
            </div>
            </div><!-- /wl-table-panel -->

            <!-- Quick Chart Panel -->
            <div id="quick-chart-panel" class="glass-card overflow-hidden flex flex-col">
                <!-- Header -->
                <div class="flex items-center gap-3 px-4 pt-4 pb-3">
                    <!-- Close button on LEFT ‚Äî nearest to watchlist panel -->
                    <button onclick="closeQuickChart()" 
                        class="flex-shrink-0 w-7 h-7 flex items-center justify-center rounded-lg transition-all hover:scale-110"
                        style="background:var(--bg-card2);border:1px solid var(--border);color:var(--text-secondary)"
                        title="Close chart">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"/></svg>
                    </button>
                    <div class="w-10 h-10 flex-shrink-0 relative">
                        <img id="qc-logo" src="" 
                            class="w-10 h-10 rounded-full absolute inset-0 transition-opacity duration-150"
                            style="opacity:0;object-fit:contain;background:white;padding:2px;border:1.5px solid #e2e8f0;"
                            onerror="this.style.opacity='0'">
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <span id="qc-symbol" class="font-black text-lg" style="color:var(--text-primary)"></span>
                            <span id="qc-price" class="font-black text-lg"></span>
                            <span id="qc-change" class="text-sm font-bold px-2 py-0.5 rounded"></span>
                        </div>
                        <div id="qc-name" class="text-xs mt-0.5" style="color:var(--text-dim)"></div>
                    </div>
                    <a id="qc-tv-link" href="#" target="_blank"
                       class="flex-shrink-0 flex items-center gap-1.5 px-3 py-1.5 rounded-xl text-[10px] font-bold uppercase tracking-widest transition-all"
                       style="background:rgba(37,99,235,0.1);color:#3b82f6">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M10 6v2H5v11h11v-5h2v7H3V6h7zm11-3v8l-3-3-7 7-1.5-1.5 7-7-3-3h8z"/></svg>
                        TradingView
                    </a>
                </div>
                <!-- TradingView Widget -->
                <div id="qc-tv-container" style="height:480px;flex-shrink:0"></div>

                <!-- News Panel -->
                <div id="qc-news-panel" class="flex flex-col" style="background:var(--bg-card)">
                    <!-- News Header -->
                    <div class="flex items-center justify-between px-4 py-2 flex-shrink-0" style="background:var(--bg-card2);border-bottom:1px solid var(--border)">
                        <div class="flex items-center gap-2">
                            <span class="text-[9px] font-black uppercase tracking-widest" style="color:var(--text-dim)">News</span>
                            <span id="qc-news-symbol" class="text-[9px] font-black uppercase tracking-widest px-1.5 py-0.5 rounded" style="background:rgba(20,184,166,0.12);color:#14b8a6"></span>
                        </div>
                        <span id="qc-news-status" class="text-[9px]" style="color:var(--text-dim)"></span>
                    </div>
                    <!-- News List -->
                    <div id="qc-news-list"></div>
                </div>
            </div><!-- /quick-chart-panel -->

            </div><!-- /wl-split-wrap -->

            <!-- ‚îÄ‚îÄ AI Stock Analyst Chat ‚îÄ‚îÄ -->
            <div id="ai-chat-card" class="glass-card overflow-hidden">
                <!-- Header -->
                <div class="flex items-center justify-between px-5 py-3 border-b" style="border-color:var(--border);background:var(--bg-card2)">
                    <div class="flex items-center gap-3">
                        <div class="w-6 h-6 rounded-lg flex items-center justify-center flex-shrink-0" style="background:linear-gradient(135deg,#1a73e8,#34a853)">
                            <svg class="w-3.5 h-3.5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/></svg>
                        </div>
                        <span class="text-xs font-bold uppercase tracking-widest" style="color:var(--text-primary);font-family:var(--font-main)">AI Stock Analyst</span>
                        <span class="text-[9px] font-medium px-2 py-0.5 rounded-full" style="background:rgba(99,102,241,0.12);color:#818cf8">Llama 3.3</span>
                        <span id="ai-status-dot" class="w-1.5 h-1.5 rounded-full bg-gray-400"></span>
                        <span id="ai-status-text" class="text-[9px]" style="color:var(--text-dim)">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ API Key</span>
                    </div>
                    <button onclick="toggleAiKeyPanel()" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-widest transition-all" style="background:var(--bg-card);border:1px solid var(--border);color:var(--text-secondary)">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>
                        API Key
                    </button>
                </div>

                <!-- API Key panel -->
                <div id="ai-key-panel" class="hidden px-5 py-3 border-b" style="border-color:var(--border);background:var(--bg-card)">
                    <div class="flex items-center gap-2">
                        <input id="ai-key-input" type="password" placeholder="sk-or-v1-..."
                            class="flex-1 text-xs px-3 py-2 rounded-lg outline-none"
                            style="background:var(--bg-card2);border:1px solid var(--border);color:var(--text-primary);font-family:var(--font-mono)"
                            onkeydown="if(event.key==='Enter') saveAiKey()">
                        <button onclick="saveAiKey()" class="px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider" style="background:#1a73e8;color:white">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        <button onclick="clearAiKey()" class="px-3 py-2 rounded-lg text-xs font-bold" style="background:var(--bg-card2);border:1px solid var(--border);color:var(--text-dim)">‡∏•‡∏ö</button>
                    </div>
                    <p class="text-[9px] mt-1.5" style="color:var(--text-dim)">‡∏ü‡∏£‡∏µ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡∏π‡∏Å‡∏ö‡∏±‡∏ï‡∏£ ¬∑ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ <strong>openrouter.ai</strong> ‚Üí API Keys ‚Üí Create Key ¬∑ ‡πÉ‡∏™‡πà key ‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô <strong>sk-or-v1-</strong></p>
                </div>

                <!-- Quick prompts -->
                <div class="flex flex-wrap gap-2 px-5 py-3">
                    <span class="text-[9px] font-bold uppercase tracking-widest self-center mr-1" style="color:var(--text-dim)">Quick:</span>
                    <button onclick="aiQuickAsk(this)" class="ai-quick-btn text-[9px] font-bold px-2.5 py-1 rounded-full transition-all" style="background:rgba(26,115,232,0.1);border:1px solid rgba(26,115,232,0.2);color:#4285f4">üìä ‡πÅ‡∏ô‡∏ß‡∏£‡∏±‡∏ö‡πÅ‡∏ô‡∏ß‡∏ï‡πâ‡∏≤‡∏ô NVDA</button>
                    <button onclick="aiQuickAsk(this)" class="ai-quick-btn text-[9px] font-bold px-2.5 py-1 rounded-full transition-all" style="background:rgba(26,115,232,0.1);border:1px solid rgba(26,115,232,0.2);color:#4285f4">üì∞ ‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏û‡∏≠‡∏£‡πå‡∏ï</button>
                    <button onclick="aiQuickAsk(this)" class="ai-quick-btn text-[9px] font-bold px-2.5 py-1 rounded-full transition-all" style="background:rgba(26,115,232,0.1);border:1px solid rgba(26,115,232,0.2);color:#4285f4">üéØ ‡∏´‡∏∏‡πâ‡∏ô‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</button>
                    <button onclick="aiQuickAsk(this)" class="ai-quick-btn text-[9px] font-bold px-2.5 py-1 rounded-full transition-all" style="background:rgba(26,115,232,0.1);border:1px solid rgba(26,115,232,0.2);color:#4285f4">‚ö†Ô∏è ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡∏•‡∏≤‡∏î‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
                </div>
            </div><!-- /ai-chat-card -->


            <div class="glass-card overflow-hidden">
                <div class="flex items-center justify-between px-5 py-3 border-b" style="border-color:var(--border);background:var(--bg-card2)">
                    <div class="flex items-center gap-3">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color:var(--text-dim)"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>
                        <span class="text-xs font-bold uppercase tracking-widest" style="color:var(--text-primary);font-family:var(--font-main)">Market News</span>
                        <span class="text-[9px] font-medium px-2 py-0.5 rounded-full" style="background:rgba(20,184,166,0.12);color:#14b8a6">US Markets</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span id="market-news-status" class="text-[9px]" style="color:var(--text-dim)"></span>
                        <button onclick="loadMarketNews()" class="flex items-center gap-1 px-3 py-1.5 rounded-lg text-[10px] font-medium uppercase tracking-widest transition-all" style="background:var(--bg-card2);color:var(--text-secondary);border:1px solid var(--border)">
                            <svg id="market-news-icon" class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                            Refresh
                        </button>
                    </div>
                </div>
                <div id="market-news-grid" class="grid grid-cols-2 min-w-0 overflow-hidden">
                    <div class="col-span-2 flex items-center justify-center py-8 gap-2" style="color:var(--text-dim)">
                        <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                        <span class="text-xs font-medium" style="color:var(--text-dim)">Loading...</span>
                    </div>
                </div>
            </div>
            <!-- bottom spacer -->
            <div class="pb-4"></div>

        </div>

    </main>

    <!-- ‚îÄ‚îÄ News Reader Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="news-modal" class="fixed inset-0 z-50 hidden" onclick="if(event.target===this)closeNewsModal()">
        <div id="nm-pane" class="absolute right-0 top-0 bottom-0 w-full max-w-lg flex flex-col shadow-2xl" style="background:var(--bg-card);transform:translateX(100%)">
            <!-- Header -->
            <div class="flex items-start justify-between p-4 border-b flex-shrink-0" style="border-color:var(--border)">
                <div class="flex-1 pr-3">
                    <div class="flex items-center gap-2 mb-1.5">
                        <span id="nm-source" class="text-[9px] font-black uppercase tracking-widest text-teal-500"></span>
                        <span class="text-[9px]" style="color:var(--border)">¬∑</span>
                        <span id="nm-time" class="text-[9px]" style="color:var(--text-dim)"></span>
                    </div>
                    <h2 id="nm-headline" class="text-sm font-black leading-snug" style="color:var(--text-primary)"></h2>
                </div>
                <button onclick="closeNewsModal()" class="flex-shrink-0 w-7 h-7 flex items-center justify-center rounded-full transition-colors mt-0.5" style="background:var(--bg-card2);color:var(--text-dim)">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <!-- Image -->
            <div id="nm-img-wrap" class="flex-shrink-0 hidden">
                <img id="nm-img" src="" alt="" class="w-full object-cover" style="max-height:180px" onerror="document.getElementById('nm-img-wrap').classList.add('hidden')">
            </div>
            <!-- Body -->
            <div class="flex-1 overflow-y-auto p-4 flex flex-col gap-4">
                <!-- Summary -->
                <p id="nm-summary" class="text-sm leading-relaxed" style="color:var(--text-secondary)"></p>
                <!-- Related Symbols -->
                <div>
                    <p class="text-[9px] font-black uppercase tracking-widest mb-2" style="color:var(--text-dim)">Related Stocks</p>
                    <div id="nm-related" class="flex flex-wrap gap-1.5"></div>
                </div>
                <!-- Read More -->
                <a id="nm-link" href="#" target="_blank" rel="noopener"
                   class="inline-flex items-center gap-2 px-4 py-2.5 rounded-xl text-xs font-bold self-start"
                   style="background:rgba(20,184,166,0.12);color:#14b8a6">
                    <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24"><path d="M10 6v2H5v11h11v-5h2v7H3V6h7zm11-3v8l-3-3-7 7-1.5-1.5 7-7-3-3h8z"/></svg>
                    Read full article
                </a>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" class="hidden" accept=".json" onchange="importJSON(event)">

    <script>
        let records = [];
        let db = { avatar: null }; // metadata stored alongside records in JSON
        let curMonth = new Date().toISOString().slice(0, 7);
        let isLoading = false;
        let compareChart, distChart;

        const formatNumber = (num) => {
            if (num === 0) return "0.00";
            return parseFloat(num).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        const stripCommas = (str) => str.toString().replace(/,/g, '');

        function parseToValidNumber(str) {
            let val = stripCommas(str);
            val = val.replace(/[^0-9.]/g, '');
            const parts = val.split('.');
            if (parts.length > 2) val = parts[0] + '.' + parts.slice(1).join('');
            return val;
        }

        function handleCurrencyInput(el, hiddenId) {
            let val = parseToValidNumber(el.value);
            document.getElementById(hiddenId).value = val;
            if (!val.includes('.') && val !== "") {
                el.value = parseFloat(val).toLocaleString();
            } else {
                el.value = val;
            }
            saveAndCalc();
        }

        function handlePaste(e, el, hiddenId) {
            e.preventDefault();
            let text = (e.clipboardData || window.clipboardData).getData('text');
            let clean = parseToValidNumber(text);
            el.value = clean;
            document.getElementById(hiddenId).value = clean;
            handleBlur(el, hiddenId);
        }

        function handleBlur(el, hiddenId) {
            let val = parseFloat(document.getElementById(hiddenId).value) || 0;
            el.value = val > 0 ? formatNumber(val) : "";
            saveAndCalc();
        }

        const sumArr = (arr) => arr ? arr.reduce((s, i) => s + (parseFloat(i.amount) || 0), 0) : 0;
        const sumPaidArr = (arr) => arr ? arr.reduce((s, i) => s + (i.isPaid ? (parseFloat(i.amount) || 0) : 0), 0) : 0;

        function showTab(t, save = true, skipWlRefresh = false) {
            document.getElementById('tab-dashboard').classList.toggle('hidden', t !== 'dashboard');
            document.getElementById('tab-edit').classList.toggle('hidden', t !== 'edit');
            document.getElementById('tab-watchlist').classList.toggle('hidden', t !== 'watchlist');
            document.getElementById('btn-dash').className = t === 'dashboard' ? 'px-5 py-2 rounded-xl text-xs font-bold tab-active transition-all uppercase' : 'px-5 py-2 rounded-xl text-xs font-bold text-gray-400 transition-all uppercase';
            document.getElementById('btn-edit').className = t === 'edit' ? 'px-5 py-2 rounded-xl text-xs font-bold tab-active transition-all uppercase' : 'px-5 py-2 rounded-xl text-xs font-bold text-gray-400 transition-all uppercase';
            document.getElementById('btn-watchlist').className = t === 'watchlist' ? 'px-5 py-2 rounded-xl text-xs font-bold tab-active transition-all uppercase flex items-center gap-1.5' : 'px-5 py-2 rounded-xl text-xs font-bold text-gray-400 transition-all uppercase flex items-center gap-1.5';
            if (t === 'dashboard') updateDashboard();
            if (t === 'watchlist' && !skipWlRefresh) {
                // Render from cache instantly ‚Äî skip symbols that already have rows with data
                watchlist.forEach(s => {
                    const row = document.getElementById('wl-row-' + s);
                    if (!row) renderWatchlistRow(s, wlDataCache[s] || null);
                    // If row exists but is skeleton, replace with cached data if available
                    else if (row.classList.contains('is-skeleton') && wlDataCache[s]) {
                        renderWatchlistRow(s, wlDataCache[s]);
                    }
                });
                refreshWatchlist();
                fetchFxRate();
            }
            if (t !== 'watchlist') disconnectFinnhubWs(); // save API quota when not viewing
            if (save) try { localStorage.setItem('ps_tab', t); } catch(e) {}
        }

        function stepMonth(delta) {
            const input = document.getElementById('monthInput');
            if (!input.value) return;
            const [year, month] = input.value.split('-').map(Number);
            const date = new Date(year, (month - 1) + delta, 1);
            const newYear = date.getFullYear();
            const newMonth = (date.getMonth() + 1).toString().padStart(2, '0');
            const newValue = `${newYear}-${newMonth}`;
            input.value = newValue;
            loadMonth(newValue);
        }

        function addInput(type, name = '', val = '', isPaid = false) {
            const container = document.getElementById(type + '-list');
            const id = 'row-' + Math.random().toString(36).substr(2, 9);
            const hiddenId = 'hidden-' + id;
            const displayVal = val !== '' ? formatNumber(val) : '';

            const html = `
                <div id="${id}" class="flex gap-2 items-center group p-1 rounded-xl transition-colors ${isPaid ? 'row-paid' : ''}">
                    <input type="checkbox" onchange="togglePaidStatus('${id}', this.checked)" ${isPaid ? 'checked' : ''} 
                        class="w-5 h-5 rounded-md border-gray-200 text-blue-600 focus:ring-blue-500 cursor-pointer">
                    <input type="text" value="${name}" oninput="saveAndCalc()" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£..." 
                        class="flex-grow bg-white border border-gray-100 rounded-xl px-4 py-2 text-sm font-medium outline-none shadow-sm focus:border-blue-300 transition-all">
                    <div class="relative w-40 flex-shrink-0">
                        <input type="text" value="${displayVal}" oninput="handleCurrencyInput(this, '${hiddenId}')" onpaste="handlePaste(event, this, '${hiddenId}')" onblur="handleBlur(this, '${hiddenId}')"
                            placeholder="0.00" class="w-full bg-white border border-gray-100 rounded-xl px-4 py-2 text-sm font-black text-right outline-none shadow-sm focus:border-blue-300 transition-all">
                        <input type="hidden" id="${hiddenId}" value="${val}">
                    </div>
                    <button onclick="document.getElementById('${id}').remove(); saveAndCalc();" class="text-gray-300 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100 flex-shrink-0">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        function togglePaidStatus(rowId, checked) {
            const el = document.getElementById(rowId);
            if (checked) el.classList.add('row-paid');
            else el.classList.remove('row-paid');
            saveAndCalc();
        }

        // --- Safety Features Implementation ---
        
        function requestClear() {
            const monthVal = document.getElementById('monthInput').value;
            document.getElementById('modal-month-name').innerText = monthVal;
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('confirm-modal').classList.add('hidden');
        }

        function executeClear() {
            document.getElementById('paydayVal').value = 0;
            document.getElementById('paydayDisplay').value = '';
            document.getElementById('fixed-list').innerHTML = '';
            document.getElementById('dynamic-list').innerHTML = '';
            saveAndCalc();
            updateDashboard();
            closeModal();
        }

        function checkSafetyLock(m) {
            const today = new Date();
            const thisMonth = today.toISOString().slice(0, 7);
            const btn = document.getElementById('clear-btn');
            const tooltip = document.getElementById('lock-tooltip');
            
            // Lock if viewed month is earlier than current month
            if (m < thisMonth) {
                btn.disabled = true;
                tooltip.classList.remove('hidden');
            } else {
                btn.disabled = false;
                tooltip.classList.add('hidden');
            }
        }

        // --- Core Logic ---

        function saveAndCalc() {
            const payday = parseFloat(document.getElementById('paydayVal').value) || 0;
            const month = document.getElementById('monthInput').value;
            
            const getItems = (id) => Array.from(document.getElementById(id).children).map(row => {
                const inputs = row.querySelectorAll('input');
                return {
                    isPaid: inputs[0].checked,
                    name: inputs[1].value,
                    amount: inputs[3].value 
                };
            });

            const fixed = getItems('fixed-list');
            const dynamic = getItems('dynamic-list');
            
            const sf = sumArr(fixed);
            const sd = sumArr(dynamic);
            const pf = sumPaidArr(fixed);
            const pd = sumPaidArr(dynamic);

            const totalExp = sf + sd;
            const balance = payday - totalExp;
            const rate = payday > 0 ? Math.round((balance / payday) * 100) : 0;

            document.getElementById('sum-fixed').innerText = '‡∏ø ' + formatNumber(sf);
            document.getElementById('sum-dynamic').innerText = '‡∏ø ' + formatNumber(sd);
            
            const fBadge = document.getElementById('paid-fixed-badge');
            if (pf > 0) {
                fBadge.innerText = 'PAID: ‡∏ø ' + formatNumber(pf);
                fBadge.style.visibility = 'visible';
            } else { fBadge.style.visibility = 'hidden'; }

            const dBadge = document.getElementById('paid-dynamic-badge');
            if (pd > 0) {
                dBadge.innerText = 'PAID: ‡∏ø ' + formatNumber(pd);
                dBadge.style.visibility = 'visible';
            } else { dBadge.style.visibility = 'hidden'; }

            document.getElementById('sum-total-exp').innerText = '‡∏ø ' + formatNumber(totalExp);
            document.getElementById('current-saving-rate').innerText = rate + '%';
            document.getElementById('record-balance-val').innerText = '‡∏ø ' + formatNumber(balance);
            
            const card = document.getElementById('record-balance-card');
            if (payday === 0 && totalExp === 0) {
                card.className = "p-6 bg-gray-50 text-gray-400 transition-colors duration-300";
            } else if (balance < 0) {
                card.className = "p-6 bg-rose-50 text-rose-600 transition-colors duration-300";
            } else {
                card.className = "p-6 bg-emerald-50 text-emerald-600 transition-colors duration-300";
            }

            const data = { id: month, payday, fixed, dynamic };
            if (!isLoading) {
                const idx = records.findIndex(r => r.id === month);
                if (idx > -1) records[idx] = data; else records.push(data);
                records.sort((a,b) => a.id.localeCompare(b.id));
                // Auto-save to localStorage (records only, no avatar to avoid size limit)
                try {
                    localStorage.setItem('ps_records', JSON.stringify(records));
                } catch(e) {}
            }

            updateReferenceBadges();
        }

        function updateReferenceBadges() {
            const currentIdx = records.findIndex(r => r.id === curMonth);
            const fixedRef = document.getElementById('last-fixed-ref');
            const dynRef = document.getElementById('last-dynamic-ref');
            
            let prevData = null;
            for (let i = currentIdx - 1; i >= 0; i--) {
                const hasFixed = records[i].fixed && records[i].fixed.length > 0;
                const hasDyn = records[i].dynamic && records[i].dynamic.length > 0;
                if (hasFixed || hasDyn) {
                    prevData = records[i];
                    break;
                }
            }

            if (prevData) {
                const lastFixed = sumArr(prevData.fixed);
                const lastDyn = sumArr(prevData.dynamic);
                fixedRef.innerText = `LAST MONTH: ‡∏ø ${formatNumber(lastFixed)}`;
                dynRef.innerText = `LAST MONTH: ‡∏ø ${formatNumber(lastDyn)}`;
            } else {
                fixedRef.innerText = "LAST MONTH: -";
                dynRef.innerText = "LAST MONTH: -";
            }
        }

        function updateDashboard() {
            const validRecords = records.filter(r => r.payday > 0 || (r.fixed && r.fixed.length > 0) || (r.dynamic && r.dynamic.length > 0));
            if (validRecords.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                document.getElementById('dash-content').classList.add('hidden');
                return;
            }
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('dash-content').classList.remove('hidden');

            const latest = records.find(r => r.id === curMonth) || records[records.length - 1];
            const expense = sumArr(latest.fixed) + sumArr(latest.dynamic);
            const surplus = latest.payday - expense;

            document.getElementById('dash-surplus').innerText = formatNumber(surplus);
            document.getElementById('current-month-label').innerText = latest.id;

            // MoM change
            const latestIdx = records.findIndex(r => r.id === latest.id);
            const momEl = document.getElementById('mom-change');
            if (latestIdx > 0) {
                const prev = records[latestIdx - 1];
                const prevSurplus = prev.payday - (sumArr(prev.fixed) + sumArr(prev.dynamic));
                if (prevSurplus !== 0) {
                    const pct = Math.round(((surplus - prevSurplus) / Math.abs(prevSurplus)) * 100);
                    const arrow = pct >= 0 ? '‚Üë' : '‚Üì';
                    momEl.innerText = `${arrow} ${Math.abs(pct)}% vs last month`;
                    momEl.classList.remove('hidden');
                }
            } else {
                momEl.classList.add('hidden');
            }
            
            const mainCard = document.getElementById('surplus-card-main');
            if (surplus < 0) {
                document.getElementById('dash-surplus').style.color = '#e11d48';
                document.getElementById('status-text').style.color = '#e11d48';
                document.getElementById('status-text').innerText = "OVERSPENT";
            } else {
                document.getElementById('dash-surplus').style.color = '#0d9488';
                document.getElementById('status-text').style.color = '#0d9488';
                document.getElementById('status-text').innerText = "HEALTHY";
            }

            const currentYear = latest.id.split('-')[0];
            const ytdRecords = records.filter(r => r.id.startsWith(currentYear));
            const ytdInc = ytdRecords.reduce((s, r) => s + r.payday, 0);
            const ytdExp = ytdRecords.reduce((s, r) => s + (sumArr(r.fixed) + sumArr(r.dynamic)), 0);
            
            document.getElementById('ytd-income').innerText = '‡∏ø ' + formatNumber(ytdInc);
            document.getElementById('ytd-expense').innerText = '‡∏ø ' + formatNumber(ytdExp);
            document.getElementById('ytd-savings-rate').innerText = (ytdInc > 0 ? Math.round(((ytdInc-ytdExp)/ytdInc)*100) : 0) + '%';
            document.getElementById('ytd-year-income').innerText = `FY ${currentYear}`;
            document.getElementById('ytd-year-expense').innerText = `FY ${currentYear}`;
            document.getElementById('ytd-year-savings').innerText = `FY ${currentYear}`;
            updateCharts(latest, validRecords);
        }

        function updateCharts(latest, validRecords) {
            const ctxDist = document.getElementById('distChart').getContext('2d');
            const fixedAmt = sumArr(latest.fixed);
            const dynAmt = sumArr(latest.dynamic);
            const savingsAmt = Math.max(0, latest.payday - (fixedAmt + dynAmt));
            const total = fixedAmt + dynAmt + savingsAmt;
            const pct = (val) => total > 0 ? Math.round((val / total) * 100) : 0;

            // Theme-aware colors
            const isDark = document.documentElement.classList.contains('dark');
            const gridCol    = isDark ? 'rgba(255,255,255,0.04)' : '#e8eef5';
            const borderCol  = isDark ? '#1e293b' : '#d0dce8';
            const tickCol    = isDark ? '#334155' : '#94a3b8';
            const tickColX   = isDark ? '#334155' : '#64748b';
            const legendCol  = isDark ? '#475569' : '#64748b';
            const tooltipBg  = isDark ? '#1e293b' : '#ffffff';
            const tooltipBdr = isDark ? '#334155' : '#d0dce8';
            const tooltipTtl = isDark ? '#64748b' : '#64748b';
            const tooltipBdy = isDark ? '#f1f5f9' : '#0f2030';

            if (distChart) distChart.destroy();
            distChart = new Chart(ctxDist, {
                type: 'doughnut',
                data: {
                    labels: [
                        `Fixed ${pct(fixedAmt)}%`,
                        `Variable ${pct(dynAmt)}%`,
                        `Savings ${pct(savingsAmt)}%`
                    ],
                    datasets: [{
                        data: [fixedAmt, dynAmt, savingsAmt],
                        backgroundColor: ['#0d9488', '#f97316', '#6366f1'],
                        borderWidth: 0,
                        hoverOffset: 6
                    }]
                },
                options: {
                    cutout: '75%',
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { font: { family: 'IBM Plex Mono', weight: '600', size: 10 }, color: legendCol, padding: 16 }
                        },
                        tooltip: {
                            backgroundColor: tooltipBg, borderColor: tooltipBdr, borderWidth: 1,
                            titleColor: tooltipTtl, bodyColor: tooltipBdy,
                            titleFont: { family: 'IBM Plex Mono', size: 10 },
                            bodyFont: { family: 'IBM Plex Mono', size: 11 },
                            callbacks: { label: (ctx) => ` ‡∏ø${formatNumber(ctx.raw)}  (${pct(ctx.raw)}%)` }
                        }
                    }
                }
            });

            const rangeLimit = parseInt(document.getElementById('compareRange').value);
            const displayData = validRecords.slice(-rangeLimit);
            const ctxComp = document.getElementById('compareChart').getContext('2d');
            if (compareChart) compareChart.destroy();
            compareChart = new Chart(ctxComp, {
                type: 'bar',
                data: {
                    labels: displayData.map(r => r.id),
                    datasets: [
                        { label: 'Income',  data: displayData.map(r => r.payday), backgroundColor: '#0d9488', borderRadius: 3 },
                        { label: 'Expense', data: displayData.map(r => sumArr(r.fixed) + sumArr(r.dynamic)), backgroundColor: '#e11d48', borderRadius: 3 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { boxWidth: 10, font: { family: 'IBM Plex Mono', weight: '600', size: 10 }, color: legendCol, padding: 16 } },
                        tooltip: {
                            backgroundColor: tooltipBg, borderColor: tooltipBdr, borderWidth: 1,
                            titleColor: tooltipTtl, bodyColor: tooltipBdy,
                            titleFont: { family: 'IBM Plex Mono', size: 10 },
                            bodyFont: { family: 'IBM Plex Mono', size: 11 },
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: gridCol, lineWidth: 1 }, ticks: { font: { family: 'IBM Plex Mono', size: 9 }, color: tickCol }, border: { color: borderCol } },
                        x: { grid: { display: false }, ticks: { font: { family: 'IBM Plex Mono', weight: '600', size: 9 }, color: tickColX }, border: { color: borderCol } }
                    }
                }
            });
        }

        function loadMonth(m) {
            isLoading = true;
            curMonth = m;
            document.getElementById('monthInput').value = m;
            try { localStorage.setItem('ps_month', m); } catch(e) {}
            checkSafetyLock(m);
            
            const r = records.find(rec => rec.id === m);
            const paydayVal = r ? r.payday : 0;
            document.getElementById('paydayVal').value = paydayVal;
            document.getElementById('paydayDisplay').value = paydayVal > 0 ? formatNumber(paydayVal) : '';
            document.getElementById('fixed-list').innerHTML = '';
            document.getElementById('dynamic-list').innerHTML = '';
            if (r) {
                if(r.fixed) r.fixed.forEach(i => addInput('fixed', i.name, i.amount, i.isPaid));
                if(r.dynamic) r.dynamic.forEach(i => addInput('dynamic', i.name, i.amount, i.isPaid));
            }
            isLoading = false;
            saveAndCalc();
            updateDashboard();
        }

        function clonePreviousMonth() {
            const currentIdx = records.findIndex(r => r.id === curMonth);
            let searchIdx = currentIdx > -1 ? currentIdx - 1 : records.length - 1;
            let prevData = null;
            for (let i = searchIdx; i >= 0; i--) {
                if (records[i].payday > 0 || records[i].fixed?.length > 0) {
                    prevData = records[i];
                    break;
                }
            }
            if (prevData) {
                document.getElementById('paydayVal').value = prevData.payday;
                document.getElementById('paydayDisplay').value = formatNumber(prevData.payday);
                document.getElementById('fixed-list').innerHTML = '';
                document.getElementById('dynamic-list').innerHTML = '';
                if(prevData.fixed) prevData.fixed.forEach(i => addInput('fixed', i.name, i.amount, false));
                if(prevData.dynamic) prevData.dynamic.forEach(i => addInput('dynamic', i.name, i.amount, false));
                saveAndCalc();
            }
        }

        function exportJSON() {
            const exportData = { meta: { avatar: db.avatar, dark: document.documentElement.classList.contains('dark') }, records: records, watchlist: watchlist };
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'PS-Smart-Finance.json';
            a.click();
        }

        function importJSON(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    if (Array.isArray(data)) {
                        records = data;
                    } else if (data.records && Array.isArray(data.records)) {
                        records = data.records;
                        if (data.meta && data.meta.avatar) {
                            db.avatar = data.meta.avatar;
                            setAvatarImage(db.avatar);
                            localStorage.setItem('ps_avatar', db.avatar);
                        }
                        if (data.watchlist && Array.isArray(data.watchlist)) {
                            watchlist = data.watchlist;
                            localStorage.setItem('ps_watchlist', JSON.stringify(watchlist));
                        }
                        // Only apply dark mode from Gist if user hasn't set local preference
                        if (typeof data.meta?.dark === 'boolean' && localStorage.getItem('ps_dark') === null) {
                            applyDarkMode(data.meta.dark);
                            localStorage.setItem('ps_dark', data.meta.dark ? '1' : '0');
                            updateChartThemes(data.meta.dark);
                        }
                    }
                    localStorage.setItem('ps_records', JSON.stringify(records));
                    try { localStorage.setItem('ps_avatar', db.avatar || ''); } catch(e) {}
                    document.getElementById('db-name-display').innerText = file.name;
                    try { localStorage.setItem('ps_dbname', file.name); } catch(e) {}
                    loadMonth(curMonth);
                    e.target.value = '';
                } catch(err) { console.error(err); }
            };
            reader.readAsText(file);
        }

        function toggleCheckAll(type, btn) {
            const list = document.getElementById(`${type}-list`);
            const checkboxes = list.querySelectorAll('input[type="checkbox"]');
            const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
            checkboxes.forEach(cb => {
                cb.checked = !anyChecked;
                const row = cb.closest('div[id^="row-"]');
                if (row) row.classList.toggle('row-paid', !anyChecked);
            });
            btn.textContent = anyChecked ? 'Check All' : 'Uncheck All';
            saveAndCalc();
        }

        function setAvatarImage(src) {
            document.getElementById('avatarImg').src = src;
            document.getElementById('avatarImg').style.display = 'block';
            document.getElementById('avatarPlaceholder').style.display = 'none';
        }

        function handleAvatar(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                db.avatar = ev.target.result;
                setAvatarImage(db.avatar);
                localStorage.setItem('ps_avatar', db.avatar);
            };
            reader.readAsDataURL(file);
        }

        // --- GitHub Gist Sync ---
        const GIST_ID = '5f913baf7d6636bf42da5e5d07a1570c';
        const GIST_FILENAME = 'PS-Smart-Finance.json';

        function getGistToken() { return localStorage.getItem('ps_gist_token') || ''; }

        function saveGistToken() {
            const token = document.getElementById('gist-token-input').value.trim();
            if (!token) return;
            localStorage.setItem('ps_gist_token', token);
            document.getElementById('gist-modal').classList.add('hidden');
            syncFromGist();
        }

        let gistStatusTimer = null;
        function showGistStatus(msg, color = 'text-gray-400') {
            const el = document.getElementById('db-name-display');
            if (gistStatusTimer) clearTimeout(gistStatusTimer);
            el.className = `text-[10px] font-bold uppercase tracking-widest leading-none truncate max-w-[150px] ${color}`;
            el.innerText = msg;
            if (!msg.endsWith('...')) {
                gistStatusTimer = setTimeout(() => {
                    el.className = 'text-[10px] font-bold text-gray-400 uppercase tracking-widest leading-none truncate max-w-[150px]';
                    el.innerText = localStorage.getItem('ps_dbname') || 'Ready to Start';
                }, 2500);
            }
        }

        async function syncToGist() {
            const token = getGistToken();
            if (!token) { document.getElementById('gist-modal').classList.remove('hidden'); return; }
            showGistStatus('UPLOADING...', 'text-blue-500');
            const exportData = { meta: { avatar: db.avatar, dark: document.documentElement.classList.contains('dark') }, records, watchlist };
            // Always save to localStorage first as fallback
            try { localStorage.setItem('ps_records', JSON.stringify(records)); } catch(e) {}
            try { localStorage.setItem('ps_watchlist', JSON.stringify(watchlist)); } catch(e) {}
            try {
                const res = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ files: { [GIST_FILENAME]: { content: JSON.stringify(exportData, null, 2) } } })
                });
                if (res.ok) {
                    showGistStatus('UPLOADED ‚úì', 'text-emerald-500');
                } else if (res.status === 401) {
                    showGistStatus('TOKEN EXPIRED ‚Äî re-enter token', 'text-rose-500');
                } else if (res.status === 404) {
                    showGistStatus('GIST NOT FOUND ‚Äî check GIST_ID', 'text-rose-500');
                } else {
                    showGistStatus(`UPLOAD FAILED (${res.status}) ‚Äî saved locally`, 'text-amber-400');
                }
            } catch(e) {
                showGistStatus('OFFLINE ‚Äî saved to localStorage', 'text-amber-400');
            }
        }

        async function syncFromGist(isInitialLoad = false) {
            const token = getGistToken();
            if (!token) { document.getElementById('gist-modal').classList.remove('hidden'); return; }
            showGistStatus('SYNCING...', 'text-blue-500');
            try {
                const res = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                if (res.status === 401) { showGistStatus('TOKEN EXPIRED ‚úó', 'text-rose-500'); return; }
                if (res.status === 404) { showGistStatus('GIST NOT FOUND ‚úó', 'text-rose-500'); return; }
                if (!res.ok) { showGistStatus(`SYNC FAILED (${res.status}) ‚úó`, 'text-rose-500'); return; }
                const gist = await res.json();
                const content = gist.files[GIST_FILENAME]?.content;
                if (!content) { showGistStatus('NO DATA IN GIST', 'text-gray-400'); return; }
                const data = JSON.parse(content);
                if (Array.isArray(data)) {
                    records = data;
                } else if (data.records) {
                    records = data.records;
                    if (data.meta?.avatar) { db.avatar = data.meta.avatar; setAvatarImage(db.avatar); }
                    if (data.watchlist && Array.isArray(data.watchlist)) {
                        watchlist = data.watchlist;
                        try { localStorage.setItem('ps_watchlist', JSON.stringify(watchlist)); } catch(e) {}
                    }
                    if (typeof data.meta?.dark === 'boolean' && localStorage.getItem('ps_dark') === null) {
                        applyDarkMode(data.meta.dark);
                        localStorage.setItem('ps_dark', data.meta.dark ? '1' : '0');
                        updateChartThemes(data.meta.dark);
                    }
                }
                try { localStorage.setItem('ps_records', JSON.stringify(records)); } catch(e) {}
                try { localStorage.setItem('ps_dbname', GIST_FILENAME); } catch(e) {}
                loadMonth(curMonth);
                showGistStatus('SYNCED ‚úì', 'text-emerald-500');
                // Always refresh watchlist after sync ‚Äî render skeletons first then fetch prices
                if (watchlist.length > 0) {
                    fetchFxRate();
                    isWlRefreshing = false;
                    watchlist.forEach(s => {
                        if (!document.getElementById('wl-row-' + s)) renderWatchlistRow(s, null);
                    });
                    refreshWatchlist();
                }
            } catch(e) {
                showGistStatus('ERROR ‚Äî check connection', 'text-rose-500');
            }
        }

        // --- Watchlist ---
        let watchlist = [];
        let dropdownSelectedIdx = -1;
        let dropdownResults = [];

        function getFinnhubKey() { return localStorage.getItem('ps_finnhub_key') || ''; }

        function saveFinnhubKey() {
            const key = document.getElementById('finnhub-key-input').value.trim();
            if (!key) return;
            localStorage.setItem('ps_finnhub_key', key);
            document.getElementById('finnhub-modal').classList.add('hidden');
            refreshWatchlist();
        }

        function saveWatchlist() {
            try { localStorage.setItem('ps_watchlist', JSON.stringify(watchlist)); } catch(e) {}
        }

        function showAddTickerInput() {
            if (!getFinnhubKey()) {
                document.getElementById('finnhub-modal').classList.remove('hidden');
                return;
            }
            const bar = document.getElementById('add-ticker-bar');
            bar.classList.remove('hidden');
            document.getElementById('ticker-input').value = '';
            document.getElementById('ticker-dropdown').classList.add('hidden');
            dropdownSelectedIdx = -1;
            document.getElementById('ticker-input').focus();
        }

        function closeAddTicker() {
            document.getElementById('add-ticker-bar').classList.add('hidden');
            document.getElementById('ticker-dropdown').classList.add('hidden');
        }

        let tickerSearchTimeout = null;
        let tickerAbortController = null;

        async function onTickerInput(val) {
            const q = val.trim().toUpperCase();
            clearTimeout(tickerSearchTimeout);
            // Cancel any in-flight request immediately
            if (tickerAbortController) { tickerAbortController.abort(); tickerAbortController = null; }
            const dd = document.getElementById('ticker-dropdown');
            if (q.length < 1) { dd.classList.add('hidden'); return; }

            tickerSearchTimeout = setTimeout(async () => {
                try {
                    const key = getFinnhubKey();
                    tickerAbortController = new AbortController();
                    const res = await fetch(
                        `https://finnhub.io/api/v1/search?q=${q}&token=${key}`,
                        { signal: tickerAbortController.signal }
                    );
                    // Rate limited ‚Äî silently wait for next keystroke
                    if (res.status === 429) return;
                    const data = await res.json();
                    dropdownResults = (data.result || [])
                        .filter(r => r.type === 'Common Stock' || r.type === 'ETP')
                        .slice(0, 8);
                    renderDropdown(q);
                } catch(e) {
                    // AbortError = user typed again, ignore silently
                    if (e.name !== 'AbortError') dd.classList.add('hidden');
                }
            }, 500); // 500ms debounce ‚Äî safe for Finnhub free tier
        }

        function renderDropdown(q) {
            const dd = document.getElementById('ticker-dropdown');
            if (dropdownResults.length === 0) { dd.classList.add('hidden'); return; }
            dropdownSelectedIdx = -1;
            dd.innerHTML = dropdownResults.map((r, i) => `
                <div class="dropdown-item px-4 py-3 cursor-pointer hover:bg-teal-50 transition-colors border-b border-gray-50 last:border-0 flex items-center justify-between"
                    onmousedown="selectDropdownItem(${i})">
                    <div>
                        <span class="font-black text-gray-900 text-sm">${r.symbol}</span>
                        <span class="text-gray-400 text-xs ml-2 truncate max-w-[200px] inline-block align-middle">${r.description}</span>
                    </div>
                    <span class="text-[9px] font-bold px-2 py-0.5 rounded ${r.type === 'ETP' ? 'bg-purple-50 text-purple-500' : 'bg-blue-50 text-blue-500'} uppercase tracking-widest flex-shrink-0 ml-2">${r.type === 'ETP' ? 'ETF' : 'Stock'}</span>
                </div>
            `).join('');
            dd.classList.remove('hidden');
        }

        function selectDropdownItem(idx) {
            const item = dropdownResults[idx];
            if (!item) return;
            document.getElementById('ticker-input').value = item.symbol;
            document.getElementById('ticker-dropdown').classList.add('hidden');
            addTickerBySymbol(item.symbol);
        }

        function onTickerKeydown(e) {
            const dd = document.getElementById('ticker-dropdown');
            const items = dd.querySelectorAll('.dropdown-item');
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                dropdownSelectedIdx = Math.min(dropdownSelectedIdx + 1, items.length - 1);
                updateDropdownHighlight(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                dropdownSelectedIdx = Math.max(dropdownSelectedIdx - 1, -1);
                updateDropdownHighlight(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (dropdownSelectedIdx >= 0 && dropdownResults[dropdownSelectedIdx]) {
                    selectDropdownItem(dropdownSelectedIdx);
                } else {
                    addTicker();
                }
            } else if (e.key === 'Escape') {
                closeAddTicker();
            }
        }

        function updateDropdownHighlight(items) {
            items.forEach((el, i) => {
                el.classList.toggle('bg-teal-50', i === dropdownSelectedIdx);
            });
        }

        function addTicker() {
            const symbol = document.getElementById('ticker-input').value.trim().toUpperCase();
            if (symbol) addTickerBySymbol(symbol);
        }

        function addTickerBySymbol(symbol) {
            if (!symbol || watchlist.includes(symbol)) { closeAddTicker(); return; }
            watchlist.push(symbol);
            saveWatchlist();
            closeAddTicker();
            refreshWatchlist();
            subscribeWs(symbol); // realtime stream for new symbol
        }

        function removeTicker(symbol) {
            watchlist = watchlist.filter(s => s !== symbol);
            saveWatchlist();
            renderWatchlistRow(symbol, null, true);
            unsubscribeWs(symbol); // stop streaming removed symbol
        }

        // data cache for drag&drop re-render
        const wlDataCache = {};
        const logoCache = {}; // preloaded logo URLs

        // ‚îÄ‚îÄ Persist cache to localStorage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function saveWlCache() {
            try {
                const payload = { wl: wlDataCache, profile: profileCache, ts: Date.now() };
                localStorage.setItem('ps_wl_cache', JSON.stringify(payload));
            } catch(e) {}
        }

        function loadWlCache() {
            try {
                const raw = localStorage.getItem('ps_wl_cache');
                if (!raw) return;
                const payload = JSON.parse(raw);
                Object.assign(wlDataCache, payload.wl || {});
                Object.assign(profileCache, payload.profile || {});
                // Preload all logos that were cached ‚Äî so icons show instantly on next load
                Object.values(profileCache).forEach(p => { if (p?.logo) preloadLogo(p.logo); });
            } catch(e) {}
        }
        loadWlCache();

        function preloadLogo(url) {
            if (!url || logoCache[url]) return;
            const img = new Image();
            img.src = url;
            logoCache[url] = true;
        }

        function renderWatchlistRow(symbol, data, remove = false) {
            const existing = document.getElementById('wl-row-' + symbol);
            if (remove) { if (existing) existing.remove(); delete wlDataCache[symbol]; checkWlEmpty(); return; }
            if (data) wlDataCache[symbol] = data;
            const d = data || wlDataCache[symbol] || null;
            const isLoading = !d;

            // If row already exists with real data and we're just re-rendering same data ‚Üí skip to avoid flash
            if (existing && !isLoading && !existing.classList.contains('is-skeleton')) {
                // Just update price cells in-place (no DOM replace = no flash)
                if (data) updateWatchlistPriceCells(symbol, d);
                return;
            }

            const price     = d?.c   ?? null;
            const change    = d?.d   ?? null;
            const changePct = d?.dp  ?? null;
            const open      = d?.o   ?? null;
            const prevClose = d?.pc  ?? null;
            const high      = d?.h   ?? null;
            const low       = d?.l   ?? null;
            const name      = d?.name ?? '';
            const type      = d?.type ?? '';
            const logo      = d?.logo ?? '';

            const isUp = changePct >= 0;
            const priceColor  = price === null   ? '' : isUp ? 'text-emerald-600' : 'text-rose-500';
            const changeColor = change === null   ? '' : isUp ? 'text-emerald-600' : 'text-rose-500';
            const arrow = isUp ? '‚ñ≤' : '‚ñº';
            const idx = watchlist.indexOf(symbol) + 1;
            const typeBadge = type === 'ETF'
                ? `<span class="text-[8px] font-black px-1.5 py-0.5 rounded bg-purple-50 text-purple-500 ml-1">ETF</span>`
                : '';
            const logoHtml = logo
                ? `<img src="${logo}" loading="eager" decoding="sync" class="w-6 h-6 rounded-full object-contain bg-white border border-gray-100 flex-shrink-0" onerror="this.outerHTML='<div class=\\'w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0\\'style=\\'background:linear-gradient(135deg,#6366f1,#8b5cf6)\\'><span class=\\'text-[8px] font-black text-white\\'>${symbol[0]}</span></div>'">`
                : `<div class="w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0" style="background:linear-gradient(135deg,#6366f1,#8b5cf6)"><span class="text-[8px] font-black text-white">${symbol[0]}</span></div>`;
            const fmt = (v) => v !== null ? v.toFixed(2) : '‚Äî';

            // Shimmer helper ‚Äî shown while data is loading
            const sk = (w = 48) => isLoading
                ? `<span class="skeleton-cell" style="width:${w}px"></span>`
                : null;

            const html = `
                <tr id="wl-row-${symbol}" draggable="true" ${isLoading ? 'class="is-skeleton"' : ''}
                    ondragstart="onDragStart(event,'${symbol}')"
                    ondragover="onDragOver(event)"
                    ondragenter="onDragEnter(event)"
                    ondragleave="onDragLeave(event)"
                    ondrop="onDrop(event,'${symbol}')"
                    ondragend="onDragEnd(event)"
                    onclick="openQuickChart('${symbol}')"
                    class="border-b hover:bg-gray-50 transition-colors group cursor-grab active:cursor-grabbing select-none" style="border-color:var(--border)">
                    <td class="px-3 py-1.5">
                        <div class="flex items-center gap-1.5">
                            <svg class="w-3 h-3 text-gray-200 group-hover:text-gray-400 transition-colors flex-shrink-0" fill="currentColor" viewBox="0 0 16 16">
                                <circle cx="5" cy="4" r="1.2"/><circle cx="11" cy="4" r="1.2"/>
                                <circle cx="5" cy="8" r="1.2"/><circle cx="11" cy="8" r="1.2"/>
                                <circle cx="5" cy="12" r="1.2"/><circle cx="11" cy="12" r="1.2"/>
                            </svg>
                            <span class="wl-idx text-[10px] font-medium w-4 text-center" style="color:var(--text-dim)">${idx}</span>
                        </div>
                    </td>
                    <td class="px-3 py-1.5">
                        <div class="flex items-center gap-2">
                            ${logoHtml}
                            <div class="flex items-center gap-1">
                                <span class="sym-cell text-sm" style="color:var(--text-primary)">${symbol}</span>
                                ${typeBadge}
                            </div>
                        </div>
                    </td>
                    <td class="px-3 py-1.5 text-xs wl-col-hide" style="color:var(--text-dim)">${sk(80) ?? name}</td>
                    <td class="px-3 py-1.5 text-right price-cell text-sm ${priceColor}">${sk(52) ?? (price !== null ? '$' + fmt(price) : '‚Äî')}</td>
                    <td class="px-3 py-1.5 text-right text-xs num-cell ${changeColor} wl-col-hide">${sk(40) ?? (change !== null ? (isUp ? '+' : '') + fmt(change) : '‚Äî')}</td>
                    <td class="px-3 py-1.5 text-right">${sk(56) ??
                        (changePct !== null
                            ? `<span class="inline-block px-2 py-0.5 rounded text-xs num-cell whitespace-nowrap ${changeColor} ${isUp ? 'bg-emerald-50' : 'bg-rose-50'}">${arrow} ${Math.abs(changePct).toFixed(2)}%</span>`
                            : '<span style="color:var(--text-dim)" class="text-xs">‚Äî</span>')
                    }</td>
                    <td class="px-3 py-1.5 text-right text-xs num-cell wl-col-hide" style="color:var(--text-secondary)">${sk(48) ?? (open      !== null ? '$' + fmt(open)      : '‚Äî')}</td>
                    <td class="px-3 py-1.5 text-right text-xs num-cell wl-col-hide" style="color:var(--text-secondary)">${sk(48) ?? (prevClose !== null ? '$' + fmt(prevClose) : '‚Äî')}</td>
                    <td class="px-3 py-1.5 text-right text-xs num-cell wl-col-hide" style="color:var(--text-secondary)">${sk(48) ?? (high      !== null ? '$' + fmt(high)      : '‚Äî')}</td>
                    <td class="px-3 py-1.5 text-right text-xs num-cell wl-col-hide" style="color:var(--text-secondary)">${sk(48) ?? (low       !== null ? '$' + fmt(low)       : '‚Äî')}</td>
                    <td class="px-3 py-1.5 text-right text-xs num-cell wl-col-hide" style="color:#10b981">${sk(52) ?? (d?.week52High != null ? '$' + fmt(d.week52High) : '‚Äî')}</td>
                    <td class="px-3 py-1.5 text-right text-xs num-cell wl-col-hide" style="color:#f43f5e">${sk(52) ?? (d?.week52Low  != null ? '$' + fmt(d.week52Low)  : '‚Äî')}</td>
                    <td class="px-3 py-1.5 text-right text-xs num-cell wl-col-hide" style="color:var(--text-secondary)">${sk(44) ?? (d?.marketCap  != null ? fmtCap(d.marketCap)     : '‚Äî')}</td>
                    <td class="px-3 py-1.5 text-right text-xs num-cell wl-col-hide" style="color:var(--text-secondary)">${sk(44) ?? (d?.avgVol10d  != null ? fmtVol(d.avgVol10d)     : '‚Äî')}</td>
                    <td class="px-3 py-1.5 text-right text-xs num-cell wl-col-hide" style="color:var(--text-secondary)">${sk(28) ?? (d?.beta       != null ? d.beta.toFixed(2)        : '‚Äî')}</td>
                    <td class="px-3 py-1.5 text-right text-xs num-cell wl-col-hide" style="color:var(--text-secondary)">${sk(28) ?? (d?.pe         != null ? d.pe.toFixed(1)          : '‚Äî')}</td>
                    <td class="px-3 py-1.5 text-right text-xs num-cell wl-col-hide" style="color:var(--text-secondary)">${sk(32) ?? (d?.divYield   != null ? d.divYield.toFixed(2)+'%': '‚Äî')}</td>
                    <td class="px-2 py-1.5 text-right">
                        <button onclick="removeTicker('${symbol}')" class="text-gray-200 hover:text-rose-400 transition-colors opacity-0 group-hover:opacity-100">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </td>
                </tr>`;

            if (existing) {
                if (existing.classList.contains('is-skeleton') || isLoading) {
                    existing.outerHTML = html; // replace skeleton with real row
                }
                // non-skeleton existing row already handled above (updateWatchlistPriceCells)
            } else {
                document.getElementById('wl-empty').classList.add('hidden');
                document.getElementById('watchlist-rows').insertAdjacentHTML('beforeend', html);
            }
        }

        function checkWlEmpty() {
            const realRows = Array.from(document.querySelectorAll('[id^="wl-row-"]')).filter(r => r.id !== 'wl-empty');
            if (realRows.length === 0) document.getElementById('wl-empty').classList.remove('hidden');
        }

        // --- Drag & Drop ---
        let dragSrc = null;

        function onDragStart(e, symbol) {
            dragSrc = symbol;
            e.dataTransfer.effectAllowed = 'move';
            setTimeout(() => e.currentTarget.style.opacity = '0.4', 0);
        }
        function onDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }
        function onDragEnter(e) { e.currentTarget.classList.add('bg-teal-50'); }
        function onDragLeave(e) { e.currentTarget.classList.remove('bg-teal-50'); }
        function onDragEnd(e) {
            e.currentTarget.style.opacity = '1';
            document.querySelectorAll('[id^="wl-row-"]').forEach(r => r.classList.remove('bg-teal-50'));
        }
        function onDrop(e, targetSymbol) {
            e.preventDefault();
            e.currentTarget.classList.remove('bg-teal-50');
            if (!dragSrc || dragSrc === targetSymbol) return;
            const si = watchlist.indexOf(dragSrc);
            const ti = watchlist.indexOf(targetSymbol);
            watchlist.splice(si, 1);
            watchlist.splice(ti, 0, dragSrc);
            saveWatchlist();
            // Move DOM nodes directly ‚Äî no re-render, no logo reload
            const tbody = document.getElementById('watchlist-rows');
            const srcRow = document.getElementById('wl-row-' + dragSrc);
            const tgtRow = document.getElementById('wl-row-' + targetSymbol);
            if (si > ti) tbody.insertBefore(srcRow, tgtRow);
            else tbody.insertBefore(srcRow, tgtRow.nextSibling);
            // Update index numbers only
            watchlist.forEach((sym, i) => {
                const row = document.getElementById('wl-row-' + sym);
                if (row) {
                    const numEl = row.querySelector('.wl-idx');
                    if (numEl) numEl.innerText = i + 1;
                }
            });
        }

        // Permanent cache for profile+metric ‚Äî refresh after 24h
        const profileCache = {};
        const PROFILE_TTL = 24 * 60 * 60 * 1000; // 24 hours

        // Quote cache TTL ‚Äî skip re-fetch if refreshed very recently
        const quoteTsCache = {}; // { symbol: timestamp }
        const QUOTE_MIN_INTERVAL = 30 * 1000; // 30 seconds

        // ‚îÄ‚îÄ Finnhub rate-safe fetch: sequential requests per symbol + retry on 429 ‚îÄ‚îÄ
        async function finnhubFetch(url, retries = 3) {
            for (let attempt = 0; attempt < retries; attempt++) {
                const res = await fetch(url);
                if (res.status === 429) {
                    // Rate limited ‚Äî wait then retry with backoff
                    await new Promise(r => setTimeout(r, 1000 * (attempt + 1)));
                    continue;
                }
                return res;
            }
            return { ok: false, json: async () => ({}) };
        }

        async function fetchQuote(symbol) {
            const key = getFinnhubKey();
            const now = Date.now();
            const profileEntry = profileCache[symbol];
            const needsProfile = !profileEntry || (now - profileEntry._ts > PROFILE_TTL);

            // Always fetch quote first (sequential ‚Äî avoids burst)
            const quoteRes = await finnhubFetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${key}`);
            const quote = quoteRes.ok ? await quoteRes.json() : {};
            quoteTsCache[symbol] = now;

            if (needsProfile) {
                // Sequential: profile then metric (2 more reqs, spaced by network RTT naturally)
                const profileRes = await finnhubFetch(`https://finnhub.io/api/v1/stock/profile2?symbol=${symbol}&token=${key}`);
                const profile = profileRes.ok ? await profileRes.json() : {};
                const metricRes = await finnhubFetch(`https://finnhub.io/api/v1/stock/metric?symbol=${symbol}&metric=all&token=${key}`);
                const metricData = metricRes.ok ? await metricRes.json() : {};
                const m = metricData.metric ?? {};
                profileCache[symbol] = {
                    _ts: now,
                    name:       profile.name ?? '',
                    logo:       profile.logo ?? '',
                    type:       profile.finnhubIndustry ? 'Stock' : (profile.name ? 'ETF' : ''),
                    marketCap:  profile.marketCapitalization ?? null,
                    week52High: m['52WeekHigh'] ?? null,
                    week52Low:  m['52WeekLow']  ?? null,
                    avgVol10d:  m['10DayAverageTradingVolume'] ?? null,
                    avgVol3m:   m['3MonthAverageTradingVolume'] ?? null,
                    beta:       m['beta'] ?? null,
                    pe:         m['peNormalizedAnnual'] ?? null,
                    divYield:   m['dividendYieldIndicatedAnnual'] ?? null,
                };
            }
            return { ...quote, ...profileCache[symbol] };
        }

        // ‚îÄ‚îÄ Throttled concurrent fetch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Keeps at most maxConcurrent tasks in-flight; starts the next as soon as one finishes.
        // With sequential fetchQuote (3 reqs in series per symbol) and maxConcurrent=2,
        // we stay well under Finnhub's 30 req/s limit even for large watchlists.
        async function throttledAll(items, maxConcurrent, fn) {
            if (!items.length) return;
            const queue = [...items];
            let active = 0;
            await new Promise((resolve) => {
                let completed = 0;
                function next() {
                    while (active < maxConcurrent && queue.length > 0) {
                        active++;
                        const item = queue.shift();
                        fn(item).finally(() => {
                            active--;
                            completed++;
                            if (completed === items.length) resolve();
                            else next();
                        });
                    }
                }
                next();
            });
        }

        async function refreshWatchlist() {
            if (isWlRefreshing) return;
            isWlRefreshing = true;

            const key = getFinnhubKey();
            if (!key) { isWlRefreshing = false; return; }
            if (watchlist.length === 0) { checkWlEmpty(); isWlRefreshing = false; return; }

            const icon = document.getElementById('wl-refresh-icon');
            icon.style.animation = 'spin 1s linear infinite';

            // Show all skeletons immediately ‚Äî user sees the list right away
            watchlist.forEach(s => {
                if (!document.getElementById('wl-row-' + s)) renderWatchlistRow(s, null);
            });

            const now = Date.now();
            const wsLive = fhWs && fhWs.readyState === 1;

            // Phase A: symbols needing full profile (new or >24h stale)
            // Sequential 3 reqs per symbol, 2 symbols at a time = max ~6 req in-flight
            // Each row renders as soon as its data arrives
            const needsProfile = watchlist.filter(s => {
                const p = profileCache[s];
                return !p || (now - p._ts > PROFILE_TTL);
            });
            await throttledAll(needsProfile, 3, async (symbol) => {
                try {
                    const data = await fetchQuote(symbol);
                    if (data?.logo) preloadLogo(data.logo);
                    renderWatchlistRow(symbol, data);
                } catch(e) { /* keep skeleton ‚Äî retry on next refresh */ }
            });

            // Phase B: symbols with cached profile ‚Üí quote-only refresh
            // Skip if WebSocket is live (already streaming real-time)
            // Skip if quote is very recent (<30s)
            if (!wsLive) {
                const needsQuote = watchlist.filter(s => {
                    if (!profileCache[s]) return false;
                    return (now - (quoteTsCache[s] ?? 0)) > QUOTE_MIN_INTERVAL;
                });
                // 1 req per symbol, 8 at a time = max 8 req in-flight, very safe
                await throttledAll(needsQuote, 8, async (symbol) => {
                    try {
                        const r = await finnhubFetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${key}`);
                        if (!r.ok) return;
                        const q = await r.json();
                        quoteTsCache[symbol] = Date.now();
                        const merged = { ...profileCache[symbol], ...wlDataCache[symbol], ...q };
                        wlDataCache[symbol] = merged;
                        updateWatchlistPriceCells(symbol, merged);
                    } catch(e) {}
                });
            }

            icon.style.animation = '';
            document.getElementById('wl-last-update').innerText =
                `Updated ${new Date().toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'})}`;
            isWlRefreshing = false;
            saveWlCache(); // persist for instant load next time
            if (isMarketOpen()) connectFinnhubWs();
            updateMarketStatus();
            loadMarketNews();
        }

        const fmtCap = v => {
            if (v >= 1000) return (v/1000).toFixed(1) + 'T';
            if (v >= 1)    return v.toFixed(1) + 'B';
            return (v*1000).toFixed(0) + 'M';
        };
        const fmtVol = v => {
            if (v >= 1000) return (v/1000).toFixed(1) + 'B';
            if (v >= 1)    return v.toFixed(1) + 'M';
            return (v*1000).toFixed(0) + 'K';
        };

        function updateWatchlistPriceCells(symbol, data) {
            if (data) wlDataCache[symbol] = data;
            const row = document.getElementById('wl-row-' + symbol);
            if (!row) return;
            const cells = row.querySelectorAll('td');
            if (cells.length < 10) return;

            const price     = data?.c   ?? null;
            const change    = data?.d   ?? null;
            const changePct = data?.dp  ?? null;
            const open      = data?.o   ?? null;
            const prevClose = data?.pc  ?? null;
            const high      = data?.h   ?? null;
            const low       = data?.l   ?? null;
            const week52H   = data?.week52High ?? null;
            const week52L   = data?.week52Low  ?? null;
            const marketCap = data?.marketCap  ?? null;
            const avgVol    = data?.avgVol10d  ?? null;
            const beta      = data?.beta       ?? null;
            const pe        = data?.pe         ?? null;
            const divYield  = data?.divYield   ?? null;

            const isUp = changePct >= 0;
            const priceColor  = price === null ? 'text-gray-300' : isUp ? 'text-emerald-600' : 'text-rose-500';
            const changeColor = change === null ? 'text-gray-300' : isUp ? 'text-emerald-600' : 'text-rose-500';
            const arrow = isUp ? '‚ñ≤' : '‚ñº';
            const fmt = v => v !== null ? v.toFixed(2) : '‚Äî';

            // idx:0=#, 1=symbol, 2=name, 3=price, 4=change, 5=%change, 6=open, 7=prev, 8=high, 9=low
            // 10=52wH, 11=52wL, 12=mktcap, 13=vol, 14=beta, 15=pe, 16=div, 17=delete
            cells[3].className = `px-3 py-1.5 text-right font-black text-sm ${priceColor}`;
            cells[3].innerText = price !== null ? '$' + fmt(price) : '‚Äî';
            cells[4].className = `px-3 py-1.5 text-right text-xs ${changeColor} wl-col-hide`;
            cells[4].innerText = change !== null ? (isUp ? '+' : '') + fmt(change) : '‚Äî';
            cells[5].innerHTML = changePct !== null
                ? `<span class="inline-block px-2 py-0.5 rounded text-xs ${changeColor} ${isUp ? 'bg-emerald-50' : 'bg-rose-50'}">${arrow} ${Math.abs(changePct).toFixed(2)}%</span>`
                : '<span class="text-gray-300 text-xs">‚Äî</span>';
            cells[6].innerText  = open      !== null ? '$' + fmt(open)      : '‚Äî';
            cells[7].innerText  = prevClose !== null ? '$' + fmt(prevClose) : '‚Äî';
            cells[8].innerText  = high      !== null ? '$' + fmt(high)      : '‚Äî';
            cells[9].innerText  = low       !== null ? '$' + fmt(low)       : '‚Äî';
            if (cells[10]) cells[10].innerText = week52H   != null ? '$' + fmt(week52H)       : '‚Äî';
            if (cells[11]) cells[11].innerText = week52L   != null ? '$' + fmt(week52L)       : '‚Äî';
            if (cells[12]) cells[12].innerText = marketCap != null ? fmtCap(marketCap)        : '‚Äî';
            if (cells[13]) cells[13].innerText = avgVol    != null ? fmtVol(avgVol)           : '‚Äî';
            if (cells[14]) cells[14].innerText = beta      != null ? beta.toFixed(2)          : '‚Äî';
            if (cells[15]) cells[15].innerText = pe        != null ? pe.toFixed(1)            : '‚Äî';
            if (cells[16]) cells[16].innerText = divYield  != null ? divYield.toFixed(2) + '%': '‚Äî';
        }

        // --- Quick Chart ---
        let qcChart = null;
        let qcCurrentSymbol = null;
        let qcCurrentRange = 'D';

        function setCompactHeaders(compact) {
            const thName  = document.getElementById('wl-th-name');
            const thPrice = document.getElementById('wl-th-price');
            if (!thName || !thPrice) return;
            if (compact) {
                thName.textContent  = 'Price';
                thPrice.textContent = '% Chg';
            } else {
                thName.textContent  = 'Name';
                thPrice.textContent = 'Price';
            }
        }

        function openQuickChart(symbol, scroll = true) {
            qcCurrentSymbol = symbol;
            const d = wlDataCache[symbol];
            const panel = document.getElementById('quick-chart-panel');
            const wrap = document.getElementById('wl-split-wrap');
            const isAlreadyOpen = wrap.classList.contains('chart-open');
            wrap.classList.add('chart-open');
            setCompactHeaders(true);
            if (scroll && !isAlreadyOpen) {
                setTimeout(() => panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 50);
            }

            // Header info
            document.getElementById('qc-symbol').innerText = symbol;
            document.getElementById('qc-name').innerText = d?.name ?? '';

            const logo = d?.logo ?? '';
            const logoEl = document.getElementById('qc-logo');
            logoEl.style.opacity = '0';
            logoEl.src = '';
            if (logo) {
                logoEl.onload  = () => { logoEl.style.opacity = '1'; };
                logoEl.onerror = () => { logoEl.style.opacity = '0'; };
                logoEl.src = logo;
                if (logoEl.complete && logoEl.naturalWidth > 0) logoEl.style.opacity = '1';
            }

            const price = d?.c ?? null;
            const changePct = d?.dp ?? null;
            const isUp = (changePct ?? 0) >= 0;
            const priceEl = document.getElementById('qc-price');
            const changeEl = document.getElementById('qc-change');
            priceEl.innerText = price ? '$' + price.toFixed(2) : '';
            priceEl.className = 'font-black text-lg ' + (price === null ? 'text-gray-400' : isUp ? 'text-emerald-600' : 'text-rose-500');
            if (changePct !== null) {
                changeEl.innerText = (isUp ? '‚ñ≤ +' : '‚ñº ') + changePct.toFixed(2) + '%';
                changeEl.className = 'text-sm font-bold px-2 py-0.5 rounded ' + (isUp ? 'text-emerald-600 bg-emerald-50' : 'text-rose-500 bg-rose-50');
            }

            // TradingView link
            document.getElementById('qc-tv-link').href = `https://www.tradingview.com/symbols/${symbol}/`;

            // Render TradingView Advanced Chart Widget
            const isDark = document.documentElement.classList.contains('dark');
            const container = document.getElementById('qc-tv-container');
            container.innerHTML = '';
            const script = document.createElement('script');
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
            script.async = true;
            script.innerHTML = JSON.stringify({
                symbol: symbol,
                interval: 'D',
                timezone: 'Asia/Bangkok',
                theme: isDark ? 'dark' : 'light',
                style: '3',          // 3 = Area chart
                locale: 'en',
                backgroundColor: isDark ? '#1e293b' : '#ffffff',
                gridColor: isDark ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.04)',
                hide_top_toolbar: false,
                hide_legend: false,
                save_image: false,
                calendar: false,
                hide_volume: false,
                autosize: true,
                support_host: 'https://www.tradingview.com',
                width: '100%',
                height: '100%',
            });
            container.appendChild(script);

            // Fetch news for this symbol
            fetchStockNews(symbol);
        }

        function closeQuickChart() {
            document.getElementById('wl-split-wrap').classList.remove('chart-open');
            setCompactHeaders(false);
            document.getElementById('qc-tv-container').innerHTML = '';
            document.getElementById('qc-news-list').innerHTML = '';
            if (qcChart) { qcChart.destroy(); qcChart = null; }
            qcCurrentSymbol = null;
        }

        let newsAbortController = null;
        const newsCache = {}; // { [symbol]: { ts: timestamp, items: [...] } }
        const NEWS_CACHE_TTL = 5 * 60 * 1000; // 5 minutes
        // ‚îÄ‚îÄ News Store (avoids inline string escaping) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const _newsStore = [];
        function clearNewsStore() { _newsStore.length = 0; }

        function renderNewsRow(a) {
            const idx = _newsStore.push(a) - 1;
            const date = new Date(a.datetime * 1000);
            const diffM = Math.floor((new Date() - date) / 60000);
            const timeStr = diffM < 60 ? `${diffM}m ago` : diffM < 1440 ? `${Math.floor(diffM/60)}h ago` : date.toLocaleDateString('en-US', {month:'short', day:'numeric'});
            const source = (a.source || '').toUpperCase();
            const img = a.image || '';
            const symbols = (a.related || '').split(',').map(s => s.trim()).filter(Boolean).slice(0, 4);
            const badges = symbols.map(s =>
                `<span class="text-[8px] font-black px-1.5 py-0.5 rounded" style="background:rgba(20,184,166,0.12);color:#14b8a6">${s}</span>`
            ).join('');
            return `<button data-news-idx="${idx}" onclick="openNewsModal(${idx})"
                class="w-full text-left flex items-start gap-3 px-4 py-2.5 transition-colors group/news"
                style="border-bottom:1px solid var(--border);background:transparent"
                onmouseover="this.style.background='var(--bg-card2)'" onmouseout="this.style.background='transparent'">
                ${img
                    ? `<img src="${img}" alt="" class="w-16 h-11 object-cover rounded-lg flex-shrink-0 mt-0.5" onerror="this.style.display='none'">`
                    : `<div class="w-16 h-11 rounded-lg flex-shrink-0 flex items-center justify-center" style="background:var(--bg-card2)">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color:var(--text-dim)"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>
                       </div>`}
                <div class="flex-1 min-w-0">
                    <p class="text-[11px] font-bold leading-snug group-hover/news:text-teal-400 transition-colors line-clamp-2" style="color:var(--text-primary)">${a.headline || ''}</p>
                    <div class="flex items-center gap-1.5 mt-1 flex-wrap">
                        <span class="text-[9px] font-black text-teal-500 uppercase tracking-wider">${source}</span>
                        <span style="color:var(--border)">¬∑</span>
                        <span class="text-[9px]" style="color:var(--text-dim)">${timeStr}</span>
                        ${badges ? `<span style="color:var(--border)">¬∑</span>${badges}` : ''}
                    </div>
                </div>
            </button>`;
        }

        // ‚îÄ‚îÄ News Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function openNewsModal(idx) {
            const a = _newsStore[idx];
            if (!a) return;
            document.getElementById('nm-headline').textContent = a.headline || '';
            document.getElementById('nm-source').textContent = (a.source || '').toUpperCase();
            document.getElementById('nm-summary').textContent = a.summary || 'No summary available for this article.';
            document.getElementById('nm-link').href = a.url || '#';
            // Time
            const d = a.datetime ? new Date(a.datetime * 1000) : null;
            const diffM = d ? Math.floor((new Date() - d) / 60000) : null;
            document.getElementById('nm-time').textContent = !d ? '' :
                diffM < 60 ? `${diffM}m ago` : diffM < 1440 ? `${Math.floor(diffM/60)}h ago` :
                d.toLocaleDateString('en-US', {month:'long', day:'numeric', year:'numeric'});
            // Image
            const imgWrap = document.getElementById('nm-img-wrap');
            const imgEl = document.getElementById('nm-img');
            if (a.image) { imgEl.src = a.image; imgWrap.classList.remove('hidden'); }
            else { imgWrap.classList.add('hidden'); }
            // Related symbols ‚Äî clickable, jump to chart
            const relatedEl = document.getElementById('nm-related');
            const symbols = (a.related || '').split(',').map(s => s.trim()).filter(Boolean).slice(0, 8);
            relatedEl.innerHTML = symbols.length
                ? symbols.map(s =>
                    `<button onclick="closeNewsModal();if(watchlist.includes('${s}'))openQuickChart('${s}')"
                     class="text-[9px] font-black px-2 py-1 rounded-lg transition-colors"
                     style="background:rgba(20,184,166,0.12);color:#14b8a6"
                     onmouseover="this.style.background='rgba(20,184,166,0.25)'" onmouseout="this.style.background='rgba(20,184,166,0.12)'">${s}</button>`
                ).join('')
                : '<span class="text-[9px]" style="color:var(--text-dim)">‚Äî</span>';
            // Show with slide-in
            const modal = document.getElementById('news-modal');
            const pane  = document.getElementById('nm-pane');
            modal.classList.remove('hidden');
            pane.style.transition = 'none';
            pane.style.transform = 'translateX(100%)';
            requestAnimationFrame(() => {
                pane.style.transition = 'transform 0.28s cubic-bezier(0.4,0,0.2,1)';
                pane.style.transform = 'translateX(0)';
            });
            document.body.style.overflow = 'hidden';
        }

        function closeNewsModal() {
            const pane = document.getElementById('nm-pane');
            pane.style.transition = 'transform 0.25s cubic-bezier(0.4,0,0.2,1)';
            pane.style.transform = 'translateX(100%)';
            setTimeout(() => {
                document.getElementById('news-modal').classList.add('hidden');
                document.body.style.overflow = '';
            }, 250);
        }
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeNewsModal(); });

        async function loadMarketNews() {
            const grid = document.getElementById('market-news-grid');
            const statusEl = document.getElementById('market-news-status');
            const icon = document.getElementById('market-news-icon');
            if (!grid) return;
            const key = getFinnhubKey();
            if (!key) {
                grid.innerHTML = `<p class="text-xs text-center py-6" style="color:var(--text-dim)">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Finnhub API Key</p>`;
                return;
            }
            icon.style.animation = 'spin 1s linear infinite';
            clearNewsStore();
            try {
                const res = await fetch(`https://finnhub.io/api/v1/news?category=general&token=${key}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const articles = await res.json();
                const items = (articles || []).slice(0, 20);
                statusEl.textContent = `Updated ${new Date().toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'})}`;
                if (items.length === 0) {
                    grid.innerHTML = `<p class="text-xs text-center py-6" style="color:var(--text-dim)">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß</p>`;
                    return;
                }
                grid.className = 'grid grid-cols-2';
                grid.innerHTML = items.map(a => renderNewsRow(a)).join('');
            } catch(e) {
                grid.innerHTML = `<div class="flex flex-col items-center py-6 gap-2">
                    <p class="text-xs" style="color:var(--text-dim)">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πà‡∏≤‡∏ß‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
                    <button onclick="loadMarketNews()" class="text-[10px] font-bold px-3 py-1.5 rounded-lg" style="background:var(--bg-card2);color:var(--text-secondary)">Retry</button>
                </div>`;
            } finally {
                icon.style.animation = '';
            }
        }

        async function fetchStockNews(symbol) {
            const listEl = document.getElementById('qc-news-list');
            const statusEl = document.getElementById('qc-news-status');
            const symEl = document.getElementById('qc-news-symbol');
            if (!listEl) return;

            symEl.textContent = symbol;
            statusEl.textContent = '';

            // Serve from cache if fresh (< 5 min)
            const cached = newsCache[symbol];
            if (cached && (Date.now() - cached.ts) < NEWS_CACHE_TTL) {
                statusEl.textContent = `${cached.items.length} stories ¬∑ cached`;
                listEl.innerHTML = cached.items.map(a => renderNewsRow(a)).join('');
                return;
            }

            listEl.innerHTML = `<div class="flex items-center justify-center py-6 gap-2" style="color:var(--text-dim)">
                <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                <span class="text-xs font-bold uppercase tracking-widest">Loading...</span>
            </div>`;

            if (newsAbortController) newsAbortController.abort();
            newsAbortController = new AbortController();

            try {
                const key = getFinnhubKey();
                if (!key) { listEl.innerHTML = `<p class="text-xs text-center py-6" style="color:var(--text-dim)">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Finnhub API Key</p>`; return; }

                const to = new Date();
                const from = new Date(to);
                from.setDate(from.getDate() - 7);
                const fmt = d => d.toISOString().split('T')[0];

                const res = await fetch(
                    `https://finnhub.io/api/v1/company-news?symbol=${symbol}&from=${fmt(from)}&to=${fmt(to)}&token=${key}`,
                    { signal: newsAbortController.signal }
                );
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const articles = await res.json();

                if (!Array.isArray(articles) || articles.length === 0) {
                    listEl.innerHTML = `<p class="text-xs text-center py-6" style="color:var(--text-dim)">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 7 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</p>`;
                    return;
                }

                const items = articles.slice(0, 20);
                newsCache[symbol] = { ts: Date.now(), items }; // store in cache
                statusEl.textContent = `${items.length} stories`;
                listEl.innerHTML = items.map(a => renderNewsRow(a)).join('');
            } catch(e) {
                if (e.name === 'AbortError') return;
                // Show friendly error with retry
                listEl.innerHTML = `<div class="flex flex-col items-center py-6 gap-2">
                    <p class="text-xs" style="color:var(--text-dim)">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πà‡∏≤‡∏ß‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
                    <button onclick="fetchStockNews('${symbol}')" class="text-[10px] font-bold px-3 py-1.5 rounded-lg" style="background:var(--bg-card2);color:var(--text-secondary)">Retry</button>
                </div>`;
            }
        }

        function setChartRange(range) {
            qcCurrentRange = range;
            ['D','W','M','3M'].forEach(r => {
                const btn = document.getElementById('qc-btn-' + r);
                btn.className = 'qc-range-btn px-2.5 py-1 rounded text-[10px] font-bold transition-all ' + (r === range ? 'tab-active' : 'text-gray-400');
            });
            if (qcCurrentSymbol) fetchChartData(qcCurrentSymbol, range);
        }

        async function fetchChartData(symbol, range) {
            const loading = document.getElementById('qc-loading');
            const loadingMsg = loading.querySelector('div');
            loading.classList.remove('hidden');
            loadingMsg.innerText = 'Loading chart...';
            if (qcChart) { qcChart.destroy(); qcChart = null; }

            let interval, period;
            if      (range === 'D')  { interval = '1d';  period = '5d';  }
            else if (range === 'W')  { interval = '1d';  period = '1mo'; }
            else if (range === 'M')  { interval = '1d';  period = '3mo'; }
            else                     { interval = '1wk'; period = '1y';  }

            try {
                const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=${interval}&range=${period}`;
                const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(yahooUrl)}`);
                const json = await res.json();
                const result = json?.chart?.result?.[0];

                if (!result?.timestamp || !result?.indicators?.quote?.[0]?.close) {
                    loading.classList.remove('hidden');
                    loadingMsg.innerText = 'No data available';
                    return;
                }

                const timestamps = result.timestamp;
                const closes = result.indicators.quote[0].close;
                const points = timestamps
                    .map((t, i) => ({ t, c: closes[i] }))
                    .filter(p => p.c !== null && p.c !== undefined);

                if (points.length === 0) {
                    loading.classList.remove('hidden');
                    loadingMsg.innerText = 'No data available';
                    return;
                }

                loading.classList.add('hidden');

                const labels = points.map(p => {
                    const d = new Date(p.t * 1000);
                    return range === 'D'
                        ? d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })
                        : d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });
                const prices = points.map(p => p.c);
                const isUp = prices[prices.length - 1] >= prices[0];
                const lineColor = isUp ? '#059669' : '#e11d48';
                const fillColor = isUp ? 'rgba(5,150,105,0.08)' : 'rgba(225,29,72,0.08)';

                const isDark = document.documentElement.classList.contains('dark');
                const gridColor  = isDark ? 'rgba(255,255,255,0.04)' : '#f1f5f9';
                const tickColor  = isDark ? '#334155' : '#9ca3af';
                const tooltipBg  = isDark ? '#1e293b' : '#ffffff';
                const tooltipBdr = isDark ? '#334155' : '#e5e7eb';
                const tooltipTtl = isDark ? '#64748b' : '#6b7280';
                const tooltipBdy = isDark ? '#f1f5f9' : '#111827';

                const ctx = document.getElementById('qc-chart').getContext('2d');
                qcChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{ data: prices, borderColor: lineColor, backgroundColor: fillColor, borderWidth: 2, fill: true, pointRadius: 2, pointHoverRadius: 4, tension: 0.3 }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                mode: 'index', intersect: false,
                                backgroundColor: tooltipBg, borderColor: tooltipBdr, borderWidth: 1,
                                titleColor: tooltipTtl, bodyColor: tooltipBdy,
                                titleFont: { family: 'IBM Plex Mono', size: 10 },
                                bodyFont: { family: 'IBM Plex Mono', size: 11, weight: 'bold' },
                                callbacks: { label: ctx => ' $' + ctx.raw.toFixed(2) }
                            }
                        },
                        scales: {
                            x: { grid: { display: false }, ticks: { maxTicksLimit: 8, font: { family: 'IBM Plex Mono', size: 9 }, color: tickColor }, border: { display: false } },
                            y: { position: 'right', grid: { color: gridColor, lineWidth: 1 }, ticks: { font: { family: 'IBM Plex Mono', size: 9 }, color: tickColor, callback: v => '$' + v.toFixed(0) }, border: { display: false } }
                        },
                        interaction: { mode: 'index', intersect: false }
                    }
                });
            } catch(e) {
                loading.classList.remove('hidden');
                loadingMsg.innerText = 'Failed to load chart';
            }
        }

        // ‚îÄ‚îÄ AI Stock Analyst (Gemini) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let aiChatHistory = [];

        function getAiKey() { return localStorage.getItem('ps_openrouter_key') || ''; }

        function saveAiKey() {
            const k = document.getElementById('ai-key-input').value.trim();
            if (!k) return;
            localStorage.setItem('ps_openrouter_key', k);
            document.getElementById('ai-key-panel').classList.add('hidden');
            updateAiStatus();
        }

        function clearAiKey() {
            localStorage.removeItem('ps_openrouter_key');
            document.getElementById('ai-key-input').value = '';
            updateAiStatus();
        }

        function toggleAiKeyPanel() {
            const panel = document.getElementById('ai-key-panel');
            panel.classList.toggle('hidden');
            if (!panel.classList.contains('hidden')) {
                const k = getAiKey();
                document.getElementById('ai-key-input').value = k ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + k.slice(-4) : '';
                setTimeout(() => document.getElementById('ai-key-input').focus(), 50);
            }
        }

        function updateAiStatus() {
            const dot  = document.getElementById('ai-status-dot');
            const text = document.getElementById('ai-status-text');
            if (getAiKey()) {
                dot.className = 'w-1.5 h-1.5 rounded-full bg-emerald-400';
                text.textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
            } else {
                dot.className = 'w-1.5 h-1.5 rounded-full bg-gray-400';
                text.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ API Key';
            }
        }

        function escHtml(s) {
            return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        }

        // ‚îÄ‚îÄ Chat Popup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function openAiPopup() {
            document.getElementById('ai-popup').classList.remove('hidden');
            document.getElementById('ai-fab').classList.add('hidden');
            document.getElementById('ai-popup-input').focus();
            initAiDrag();
        }

        function minimizeAiPopup() {
            document.getElementById('ai-popup').classList.add('hidden');
            document.getElementById('ai-fab').classList.remove('hidden');
        }

        function restoreAiPopup() {
            document.getElementById('ai-fab').classList.add('hidden');
            document.getElementById('ai-popup').classList.remove('hidden');
            document.getElementById('ai-popup-input').focus();
        }

        function closeAiPopup() { minimizeAiPopup(); }

        function initAiDrag() {
            const popup  = document.getElementById('ai-popup');
            const header = document.getElementById('ai-popup-header');
            if (popup._dragInited) return;
            popup._dragInited = true;

            let startX, startY, startRight, startBottom, dragging = false;

            header.addEventListener('mousedown', e => {
                if (e.button !== 0) return;
                dragging = true;
                startX = e.clientX;
                startY = e.clientY;
                const rect = popup.getBoundingClientRect();
                startRight  = window.innerWidth  - rect.right;
                startBottom = window.innerHeight - rect.bottom;
                header.style.cursor = 'grabbing';
                e.preventDefault();
            });

            document.addEventListener('mousemove', e => {
                if (!dragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                const newRight  = Math.max(8, Math.min(window.innerWidth  - 100, startRight  - dx));
                const newBottom = Math.max(8, Math.min(window.innerHeight - 60,  startBottom - dy));
                popup.style.right  = newRight  + 'px';
                popup.style.bottom = newBottom + 'px';
            });

            document.addEventListener('mouseup', () => {
                dragging = false;
                header.style.cursor = 'grab';
            });

            // Wheel block
            const panel = document.getElementById('ai-popup-panel');
            if (!panel._wheelBlocked) {
                panel.addEventListener('wheel', e => e.stopPropagation(), { passive: true });
                panel._wheelBlocked = true;
            }
        }

        function clearAiChat() {
            aiChatHistory = [];
            document.getElementById('ai-popup-messages').innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0" style="background:linear-gradient(135deg,#1a73e8,#34a853)">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.347.347a3.5 3.5 0 01-4.95 0l-.347-.347z"/></svg>
                    </div>
                    <div class="flex-1">
                        <div class="text-[10px] font-bold mb-1.5" style="color:#4285f4">AI ANALYST</div>
                        <div class="text-sm leading-relaxed" style="color:var(--text-secondary)">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏ô‡∏ß‡∏£‡∏±‡∏ö/‡πÅ‡∏ô‡∏ß‡∏ï‡πâ‡∏≤‡∏ô, ‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡∏´‡∏£‡∏∑‡∏≠ outlook ‡∏Ç‡∏≠‡∏á‡∏´‡∏∏‡πâ‡∏ô‡πÉ‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö</div>
                    </div>
                </div>`;
        }

        function appendPopupMessage(role, text, isLoading = false) {
            const container = document.getElementById('ai-popup-messages');
            const id = 'pmsg-' + Date.now();
            const isUser = role === 'user';
            const ts = new Date().toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
            const html = isUser
                ? `<div id="${id}" class="flex flex-col items-end gap-0.5">
                    <div class="max-w-[80%] px-4 py-2.5 rounded-2xl rounded-tr-sm text-sm leading-relaxed" style="background:linear-gradient(135deg,#1a73e8,#0d47a1);color:white">${escHtml(text)}</div>
                    <span class="text-[9px]" style="color:var(--text-dim)">${ts}</span>
                   </div>`
                : `<div id="${id}" class="flex items-start gap-3">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5" style="background:linear-gradient(135deg,#1a73e8,#34a853)">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.347.347a3.5 3.5 0 01-4.95 0l-.347-.347z"/></svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1.5">
                            <span class="text-[10px] font-bold" style="color:#4285f4">AI ANALYST</span>
                            <span class="text-[9px]" style="color:var(--text-dim)">${ts}</span>
                        </div>
                        <div class="ai-msg-body text-sm leading-relaxed" style="color:var(--text-secondary);white-space:pre-wrap">${isLoading ? '<span class="ai-typing">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå<span class="dots">...</span></span>' : escHtml(text)}</div>
                    </div>
                   </div>`;
            container.insertAdjacentHTML('beforeend', html);
            container.scrollTop = container.scrollHeight;
            return id;
        }

        function aiQuickAsk(btn) {
            const text = btn.textContent.replace(/^[\S]+\s/, '').trim();
            document.getElementById('ai-input').value = text;
            sendAiMessage();
        }

        // ‚îÄ‚îÄ Technical Analysis: fetch candles ‚Üí compute SMA, Fibonacci, key levels ‚îÄ‚îÄ
        async function fetchTechnicals(symbol, finnhubKey) {
            try {
                const to   = Math.floor(Date.now() / 1000);
                const from = to - 90 * 24 * 3600; // 90 days
                const url  = `https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=D&from=${from}&to=${to}&token=${finnhubKey}`;
                const res  = await fetch(url);
                const d    = await res.json();
                if (!d || d.s !== 'ok' || !d.c?.length) return null;

                const closes = d.c, highs = d.h, lows = d.l, vols = d.v || [];
                const n = closes.length;
                if (n < 20) return null;

                // SMA
                const sma = (arr, period) => {
                    const slice = arr.slice(-period);
                    return +(slice.reduce((a,b)=>a+b,0)/slice.length).toFixed(2);
                };
                const sma20  = sma(closes, 20);
                const sma50  = n >= 50 ? sma(closes, 50) : null;
                const sma200 = n >= 200 ? sma(closes, 200) : null;

                // Swing High/Low over last 90 days for Fibonacci
                const swingHigh = Math.max(...highs);
                const swingLow  = Math.min(...lows);
                const diff = swingHigh - swingLow;
                const fib = {
                    '100%': +swingHigh.toFixed(2),
                    '78.6%': +(swingHigh - diff * 0.214).toFixed(2),
                    '61.8%': +(swingHigh - diff * 0.382).toFixed(2),
                    '50%':   +(swingHigh - diff * 0.500).toFixed(2),
                    '38.2%': +(swingHigh - diff * 0.618).toFixed(2),
                    '23.6%': +(swingHigh - diff * 0.764).toFixed(2),
                    '0%':    +swingLow.toFixed(2),
                };

                // Volume-weighted key levels: find price clusters with high volume
                const recent20 = closes.slice(-20);
                const minP = Math.min(...recent20), maxP = Math.max(...recent20);
                const buckets = 10;
                const bucketSize = (maxP - minP) / buckets || 1;
                const volBuckets = new Array(buckets).fill(0);
                for (let i = n - 20; i < n; i++) {
                    const idx = Math.min(Math.floor((closes[i] - minP) / bucketSize), buckets - 1);
                    volBuckets[idx] += (vols[i] || 1);
                }
                const topBucketIdx = volBuckets.indexOf(Math.max(...volBuckets));
                const hvLevel = +(minP + (topBucketIdx + 0.5) * bucketSize).toFixed(2);

                // Recent pivot highs/lows (last 20 candles, look-back 3)
                const pivots = { supports: [], resistances: [] };
                for (let i = 3; i < n - 3; i++) {
                    const isLow  = lows[i]  < Math.min(...lows.slice(i-3,i), ...lows.slice(i+1,i+4));
                    const isHigh = highs[i] > Math.max(...highs.slice(i-3,i), ...highs.slice(i+1,i+4));
                    if (isLow  && i >= n - 30) pivots.supports.push(+lows[i].toFixed(2));
                    if (isHigh && i >= n - 30) pivots.resistances.push(+highs[i].toFixed(2));
                }

                return { sma20, sma50, sma200, fib, hvLevel, pivots, swingHigh: +swingHigh.toFixed(2), swingLow: +swingLow.toFixed(2) };
            } catch(e) {
                return null;
            }
        }

        // ‚îÄ‚îÄ Fetch all extra Finnhub data for AI context ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function fetchAiContext(symbol, fKey) {
            const base = `https://finnhub.io/api/v1`;
            const get  = async (url) => {
                try {
                    const r = await fetch(url);
                    return r.ok ? await r.json() : null;
                } catch { return null; }
            };

            // Fire all requests in parallel
            const [earnings, recommend, priceTarget, insider, upgrades, sentiment, earningsCal, newsRaw] = await Promise.all([
                get(`${base}/stock/earnings?symbol=${symbol}&limit=4&token=${fKey}`),
                get(`${base}/stock/recommendation?symbol=${symbol}&token=${fKey}`),
                get(`${base}/stock/price-target?symbol=${symbol}&token=${fKey}`),
                get(`${base}/stock/insider-transactions?symbol=${symbol}&token=${fKey}`),
                get(`${base}/stock/upgrade-downgrade?symbol=${symbol}&limit=5&token=${fKey}`),
                get(`${base}/news-sentiment?symbol=${symbol}&token=${fKey}`),
                get(`${base}/calendar/earnings?symbol=${symbol}&from=${new Date().toISOString().slice(0,10)}&to=${new Date(Date.now()+90*864e5).toISOString().slice(0,10)}&token=${fKey}`),
                get(`${base}/company-news?symbol=${symbol}&from=${new Date(Date.now()-7*864e5).toISOString().slice(0,10)}&to=${new Date().toISOString().slice(0,10)}&token=${fKey}`),
            ]);

            let out = `\n‚ïê‚ïê‚ïê ${symbol} FUNDAMENTAL & SENTIMENT DATA ‚ïê‚ïê‚ïê`;

            // Earnings history
            if (Array.isArray(earnings) && earnings.length) {
                out += `\nEARNINGS (recent quarters):`;
                earnings.slice(0,4).forEach(e => {
                    const beat = e.actual != null && e.estimate != null
                        ? (e.actual > e.estimate ? '‚úÖ Beat' : e.actual < e.estimate ? '‚ùå Miss' : '‚ûñ Met')
                        : '';
                    out += `\n  Q${e.period||''}: Actual EPS $${e.actual??'N/A'} vs Est $${e.estimate??'N/A'} ${beat} | Surprise: ${e.surprisePercent!=null?e.surprisePercent.toFixed(1)+'%':'N/A'}`;
                });
            }

            // Analyst recommendations
            if (Array.isArray(recommend) && recommend.length) {
                const r = recommend[0];
                out += `\nANALYST CONSENSUS (latest): Strong Buy:${r.strongBuy} Buy:${r.buy} Hold:${r.hold} Sell:${r.sell} Strong Sell:${r.strongSell} (as of ${r.period||'N/A'})`;
            }

            // Price target
            if (priceTarget && priceTarget.targetMean) {
                out += `\nANALYST PRICE TARGET: Mean $${priceTarget.targetMean?.toFixed(2)} | High $${priceTarget.targetHigh?.toFixed(2)} | Low $${priceTarget.targetLow?.toFixed(2)} | Median $${priceTarget.targetMedian?.toFixed(2)} (${priceTarget.numberOfAnalysts} analysts)`;
            }

            // Insider transactions (last 5)
            const txns = insider?.data || insider;
            if (Array.isArray(txns) && txns.length) {
                const recent = txns.slice(0,5);
                const buys  = recent.filter(t => (t.transactionType||t.change||0) > 0 || (t.transactionType||'').toLowerCase().includes('buy'));
                const sells = recent.filter(t => (t.transactionType||'').toLowerCase().includes('sell') || (t.change||0) < 0);
                out += `\nINSIDER TRANSACTIONS (recent): ${buys.length} buys, ${sells.length} sells`;
                recent.slice(0,3).forEach(t => {
                    out += `\n  ${t.name||'Unknown'} (${t.position||t.title||'exec'}): ${t.transactionType||'transaction'} ${t.share!=null?t.share.toLocaleString()+' shares':''} @ $${t.transactionPrice||'N/A'} on ${t.transactionDate||t.date||'N/A'}`;
                });
            }

            // Upgrades/Downgrades
            if (Array.isArray(upgrades) && upgrades.length) {
                out += `\nRECENT UPGRADES/DOWNGRADES:`;
                upgrades.slice(0,4).forEach(u => {
                    out += `\n  ${u.company||'Firm'}: ${u.fromGrade||'?'} ‚Üí ${u.toGrade||'?'} (${u.action||''}) on ${u.gradeDate||'N/A'}`;
                });
            }

            // Sentiment
            if (sentiment && sentiment.companyNewsScore != null) {
                const score = sentiment.companyNewsScore;
                const label = score > 0.6 ? 'Positive üìà' : score < 0.4 ? 'Negative üìâ' : 'Neutral ‚ûñ';
                out += `\nNEWS SENTIMENT: ${label} (score: ${score.toFixed(2)}) | Buzz: ${sentiment.buzz?.articlesInLastWeek||0} articles/week | Sector avg: ${sentiment.sectorAverageNewsScore?.toFixed(2)||'N/A'}`;
            }

            // Upcoming earnings date
            const upcomingList = earningsCal?.earningsCalendar || [];
            if (upcomingList.length) {
                const next = upcomingList[0];
                out += `\nNEXT EARNINGS DATE: ${next.date||'N/A'} | Est EPS: $${next.epsEstimate??'N/A'} | Est Revenue: $${next.revenueEstimate!=null?(next.revenueEstimate/1e9).toFixed(2)+'B':'N/A'}`;
            }

            // Recent news headlines (top 4)
            if (Array.isArray(newsRaw) && newsRaw.length) {
                out += `\nRECENT NEWS (last 7 days):`;
                newsRaw.slice(0,4).forEach(n => {
                    out += `\n  ‚Ä¢ ${n.headline||''}`;
                });
            }

            return out;
        }

        async function sendAiMessage() {
            const inputBar   = document.getElementById('ai-input');
            const inputPopup = document.getElementById('ai-popup-input');
            const text = (inputBar.value || inputPopup.value).trim();
            if (!text) return;

            const key = getAiKey();
            if (!key) {
                document.getElementById('ai-key-panel').classList.remove('hidden');
                document.getElementById('ai-key-input').focus();
                return;
            }

            const cleanKey = key.replace(/[^\x20-\x7E]/g, '').trim();
            if (!cleanKey.startsWith('sk-or-')) {
                localStorage.removeItem('ps_openrouter_key');
                updateAiStatus();
                document.getElementById('ai-key-panel').classList.remove('hidden');
                const inp = document.getElementById('ai-key-input');
                inp.value = ''; inp.placeholder = 'sk-or-v1-...'; inp.focus();
                inp.style.borderColor = '#ef4444';
                setTimeout(() => inp.style.borderColor = '', 2000);
                return;
            }

            inputBar.value = ''; inputPopup.value = '';
            openAiPopup();
            appendPopupMessage('user', text);
            aiChatHistory.push({ role: 'user', content: text });

            // Create assistant bubble and hold direct reference
            const bubble = document.createElement('div');
            bubble.className = 'flex items-start gap-3';
            const ts = new Date().toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
            bubble.innerHTML = `
                <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5" style="background:linear-gradient(135deg,#1a73e8,#34a853)">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.347.347a3.5 3.5 0 01-4.95 0l-.347-.347z"/></svg>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1.5">
                        <span class="text-[10px] font-bold" style="color:#4285f4">AI ANALYST</span>
                        <span class="text-[9px]" style="color:var(--text-dim)">${ts}</span>
                    </div>
                    <div class="msgbody text-sm leading-relaxed" style="color:var(--text-secondary);white-space:pre-wrap">
                        <span style="color:var(--text-dim)">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
                    </div>
                </div>`;
            const msgContainer = document.getElementById('ai-popup-messages');
            msgContainer.appendChild(bubble);
            msgContainer.scrollTop = msgContainer.scrollHeight;
            const msgBody = bubble.querySelector('.msgbody'); // direct reference ‚Äî never fails

            // Markdown renderer + think-block stripper
            function renderMd(text) {
                text = text.replace(/<think>[\s\S]*?<\/think>/gi, '').trim();
                let s = text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                s = s.replace(/\*(.+?)\*/g, '<em>$1</em>');
                s = s.replace(/^#{1,3}\s+(.+)$/gm, '<strong style="font-size:1.05em">$1</strong>');
                s = s.replace(/^[\-\*]\s+(.+)$/gm, '‚Ä¢ $1');
                s = s.replace(/\n/g, '<br>');
                return s;
            }

            const setMsg  = (html)  => { msgBody.innerHTML = html; msgContainer.scrollTop = msgContainer.scrollHeight; };
            const setTxt  = (text)  => setMsg(renderMd(text));
            const setInfo = (text)  => setMsg(`<span style="color:var(--text-dim)">${escHtml(text)} <span class="ai-cursor">‚ñã</span></span>`);
            const setErr  = (text)  => setMsg(`<span style="color:#f43f5e">‚ùå ${escHtml(text)}</span>`);

            // Show stop, hide send
            document.getElementById('ai-popup-send-btn').classList.add('hidden');
            document.getElementById('ai-popup-stop-btn').classList.remove('hidden');

            const ctrl = new AbortController();
            window._aiAbort = ctrl;
            const tid = setTimeout(() => ctrl.abort(), 120000);

            const MODELS = [
                'openrouter/free',
                'meta-llama/llama-3.3-70b-instruct:free',
                'mistralai/mistral-7b-instruct:free',
                'deepseek/deepseek-r1-0528:free',
                'google/gemma-3-27b-it:free',
            ];

            // Detect which symbols are mentioned in the question
            const mentionedSyms = watchlist.filter(s => text.toUpperCase().includes(s.toUpperCase())).slice(0, 3);
            const fKey = getFinnhubKey();

            // Fetch technicals + full context for mentioned symbols
            let techSections = '';
            let contextSections = '';
            if (mentionedSyms.length > 0 && fKey) {
                setInfo('üìä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Technical + Fundamental...');
                const [techResults, ctxResults] = await Promise.all([
                    Promise.all(mentionedSyms.map(s => fetchTechnicals(s, fKey))),
                    Promise.all(mentionedSyms.map(s => fetchAiContext(s, fKey))),
                ]);
                techSections = mentionedSyms.map((sym, i) => {
                    const t = techResults[i];
                    if (!t) return '';
                    const fibLines = Object.entries(t.fib).map(([k,v]) => `  Fib ${k}: $${v}`).join('\n');
                    const supports = t.pivots.supports.length ? t.pivots.supports.slice(-3).join(', ') : 'none';
                    const resists  = t.pivots.resistances.length ? t.pivots.resistances.slice(-3).join(', ') : 'none';
                    return `\n${sym} TECHNICAL ANALYSIS (90-day):\n  SMA20: $${t.sma20}${t.sma50?` | SMA50: $${t.sma50}`:''}${t.sma200?` | SMA200: $${t.sma200}`:''}\n  90d Range: $${t.swingLow}‚Äì$${t.swingHigh}\n  Fibonacci:\n${fibLines}\n  High-Volume Level: $${t.hvLevel}\n  Pivot Supports: ${supports}\n  Pivot Resistances: ${resists}`;
                }).join('\n');
                contextSections = ctxResults.filter(Boolean).join('\n');
            }

            // Build realtime market data from Finnhub cache
            const mkData = watchlist.slice(0, 20).map(sym => {
                const d = wlDataCache[sym];
                if (!d?.c) return null;
                const p = d.c, ch = d.dp, hi = d.h, lo = d.l, pc = d.pc;
                const name = d.name ? ` (${d.name})` : '';
                return `${sym}${name}: ‡∏£‡∏≤‡∏Ñ‡∏≤ $${p.toFixed(2)}, ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ${ch>=0?'+':''}${ch?.toFixed(2)}%, ‡∏™‡∏π‡∏á $${hi?.toFixed(2)}, ‡∏ï‡πà‡∏≥ $${lo?.toFixed(2)}, ‡∏õ‡∏¥‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ $${pc?.toFixed(2)}, 52wk H/L $${d.week52High??'N/A'}/$${d.week52Low??'N/A'}, PE ${d.pe??'N/A'}, Beta ${d.beta??'N/A'}`;
            }).filter(Boolean).join('\n');

            const sysPrompt = `You are a professional stock analyst with access to comprehensive LIVE data from Finnhub below. Use ALL data provided as your primary source. Answer in Thai if user writes Thai, English if English.

CURRENT DATE/TIME: ${new Date().toLocaleString('th-TH', {timeZone:'Asia/Bangkok'})} (Bangkok time)

GLOBAL CONTEXT (Áü•ËØÜÊà™Ê≠¢ March 2026 ‚Äî always factor these into analysis):
- US-Iran-Israel military tensions escalating (March 2026) ‚Äî oil price risk, defense stocks elevated
- US-China trade war: semiconductor export restrictions tightening, affecting NVDA, AMD, QCOM
- Fed rate policy: rates elevated, watching for cuts in mid-2026
- Nasdaq/tech sector under pressure from macro uncertainty and AI spending scrutiny
- Thai Baht: USD/THB ~${document.getElementById('fx-rate')?.textContent?.replace(' THB','') || '33-35'} ‚Äî factor into USD-denominated stock analysis for Thai investors

LIVE MARKET DATA (refreshed minutes ago):
${mkData || '(no watchlist data)'}
${techSections}
${contextSections}

Analysis guidelines:
- Always mention relevant geopolitical risks that could affect the stock
- Support/resistance: use SMA, Fibonacci, pivot points ‚Äî NOT just day high/low
- Factor in analyst consensus, price targets, earnings surprises, and insider activity
- Mention upcoming earnings dates as key risk events
- Be specific with numbers from the live data above`;

            const msgs = [
                { role:'system', content: sysPrompt },
                ...aiChatHistory.slice(-6).map(m => ({
                    role: m.role === 'model' ? 'assistant' : (m.role||'user'),
                    content: typeof m.content === 'string' ? m.content : (m.parts?.[0]?.text||'')
                }))
            ];

            // Animate text streaming word-by-word with typing cursor
            async function streamText(text) {
                // Strip think blocks before streaming
                const clean = text.replace(/<think>[\s\S]*?<\/think>/gi, '').trim();
                const words = clean.split(/(\s+)/); // keep whitespace tokens
                let out = '';
                for (const token of words) {
                    if (ctrl.signal.aborted) break;
                    out += token;
                    msgBody.innerHTML = renderMd(out) + '<span class="ai-cursor">‚ñã</span>';
                    msgContainer.scrollTop = msgContainer.scrollHeight;
                    await new Promise(r => setTimeout(r, 14));
                }
                // Final render without cursor
                msgBody.innerHTML = renderMd(clean);
                msgContainer.scrollTop = msgContainer.scrollHeight;
            }

            // Update badge in popup header
            function updateBadge(modelName) {
                const badge = document.getElementById('ai-popup-badge');
                if (badge) badge.textContent = modelName;
            }

            try {
                let replied = false;
                let attempt = 0;
                while (!replied && !ctrl.signal.aborted) {
                    const model = MODELS[attempt % MODELS.length];
                    const name  = model === 'openrouter/free' ? 'Auto Free' :
                                  (model.split('/')[1]?.replace(':free','') || model);
                    setInfo(`üîó ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠${attempt > 0 ? ` (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${attempt+1})` : ''}...`);

                    let res, data;
                    try {
                        res  = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                            method:'POST',
                            headers:{'Content-Type':'application/json','Authorization':`Bearer ${cleanKey}`},
                            signal: ctrl.signal,
                            body: JSON.stringify({ model, messages:msgs, max_tokens:3000, temperature:0.3 })
                        });
                        data = await res.json();
                    } catch(fetchErr) {
                        if (fetchErr.name === 'AbortError') throw fetchErr;
                        attempt++;
                        if (attempt >= MODELS.length * 2) { setErr('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ OpenRouter ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï'); break; }
                        setInfo(`‚ö†Ô∏è ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà...`);
                        await new Promise(r => setTimeout(r, 1500));
                        continue;
                    }

                    if (res.status === 429) {
                        setInfo(`‚è≥ Server ‡πÄ‡∏ï‡πá‡∏° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà...`);
                        await new Promise((r,rej) => {
                            const t = setTimeout(r, 4000);
                            ctrl.signal.addEventListener('abort', ()=>{ clearTimeout(t); rej(new DOMException('','AbortError')); },{once:true});
                        });
                        attempt++;
                        continue;
                    }

                    if (!res.ok || data.error) {
                        attempt++;
                        if (attempt >= MODELS.length * 2) { setErr(`‡πÑ‡∏°‡πà‡∏°‡∏µ model ‡πÉ‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà`); break; }
                        setInfo(`‚ö†Ô∏è ‡∏•‡∏≠‡∏á model ‡∏≠‡∏∑‡πà‡∏ô...`);
                        await new Promise(r => setTimeout(r, 500));
                        continue;
                    }

                    let reply = data.choices?.[0]?.message?.content;
                    if (!reply) { attempt++; continue; }

                    // Detect truncation ‚Äî if finish_reason is 'length', continue the response
                    const finishReason = data.choices?.[0]?.finish_reason;
                    if (finishReason === 'length') {
                        setInfo('üìù ‡∏ï‡∏≠‡∏ö‡∏¢‡∏≤‡∏ß‡∏°‡∏≤‡∏Å ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠...');
                        try {
                            const contMsgs = [...msgs,
                                { role:'assistant', content: reply },
                                { role:'user', content: '‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏≠‡∏ö‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô' }
                            ];
                            const r2 = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                                method:'POST',
                                headers:{'Content-Type':'application/json','Authorization':`Bearer ${cleanKey}`},
                                signal: ctrl.signal,
                                body: JSON.stringify({ model, messages:contMsgs, max_tokens:2000, temperature:0.3 })
                            });
                            const d2 = await r2.json();
                            const cont = d2.choices?.[0]?.message?.content;
                            if (cont) reply = reply + '\n' + cont;
                        } catch(e2) { /* use partial reply as-is */ }
                    }

                    // Show which model actually answered
                    const usedModel = data.model || model;
                    const usedName = usedModel === 'openrouter/free' ? 'Auto Free' :
                                     usedModel.split('/')[1]?.replace(':free','').replace(/-instruct$/,'') || usedModel;
                    updateBadge(usedName);

                    aiChatHistory.push({ role:'assistant', content:reply });
                    if (aiChatHistory.length > 10) aiChatHistory = aiChatHistory.slice(-10);
                    await streamText(reply);
                    replied = true;
                }

            } catch(e) {
                if (e.name === 'AbortError') setMsg('<span style="color:var(--text-dim)">‚èπ ‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß</span>');
                else setErr(e.message || String(e));
            } finally {
                clearTimeout(tid);
                window._aiAbort = null;
                document.getElementById('ai-popup-send-btn').classList.remove('hidden');
                document.getElementById('ai-popup-stop-btn').classList.add('hidden');
            }
        }

        function stopAiMessage() {
            if (window._aiAbort) window._aiAbort.abort('user');
        }

        // --- FX Rate (USD/THB) ---
        let fxPrevRate    = null;  // prev USD‚ÜíTHB mid rate
        let fxPrevRateInv = null;  // prev THB‚ÜíUSD (= 1/mid, displayed as "THB per 1 USD equivalent" ‚Äî same unit for easy reading)

        // ‚îÄ‚îÄ Finnhub WebSocket realtime ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let fhWs = null;
        let fhWsReconnectTimer = null;
        let fhWsSubscribed = new Set();
        let fhWsBackoff = 5000; // start 5s, max 30s

        function connectFinnhubWs() {
            const key = getFinnhubKey();
            if (!key || watchlist.length === 0) return;
            if (fhWs && fhWs.readyState <= 1) return;

            fhWs = new WebSocket(`wss://ws.finnhub.io?token=${key}`);

            fhWs.onopen = () => {
                fhWsBackoff = 5000; // reset backoff on successful connect
                fhWsSubscribed.clear();
                watchlist.forEach(sym => subscribeWs(sym));
                updateMarketStatus();
            };

            fhWs.onmessage = (e) => {
                try {
                    const msg = JSON.parse(e.data);
                    if (msg.type !== 'trade') return;
                    const latest = {};
                    msg.data.forEach(t => {
                        if (!latest[t.s] || t.t > latest[t.s].t) latest[t.s] = t;
                    });
                    Object.entries(latest).forEach(([sym, trade]) => {
                        const cached = wlDataCache[sym];
                        if (!cached) return;
                        const newPrice = trade.p;
                        const prevClose = cached.pc ?? cached.c ?? newPrice;
                        const change = newPrice - prevClose;
                        const changePct = prevClose ? (change / prevClose) * 100 : 0;
                        const updated = { ...cached, c: newPrice, d: change, dp: changePct };
                        updateWatchlistPriceCells(sym, updated);
                        const row = document.getElementById('wl-row-' + sym);
                        if (row) {
                            row.style.transition = 'background 0.1s';
                            row.style.background = change >= 0 ? 'rgba(5,150,105,0.08)' : 'rgba(225,29,72,0.08)';
                            setTimeout(() => { row.style.background = ''; }, 600);
                        }
                        if (qcCurrentSymbol === sym) {
                            document.getElementById('qc-price').textContent = '$' + newPrice.toFixed(2);
                            const pct = Math.abs(changePct).toFixed(2);
                            const el = document.getElementById('qc-change');
                            el.textContent = `${change >= 0 ? '‚ñ≤' : '‚ñº'} ${pct}%`;
                            el.className = `text-sm font-bold px-2 py-0.5 rounded ${change >= 0 ? 'text-emerald-600 bg-emerald-50' : 'text-rose-500 bg-rose-50'}`;
                        }
                    });
                    updateMarketStatus(true);
                } catch(err) {}
            };

            fhWs.onclose = () => {
                fhWs = null;
                fhWsSubscribed.clear();
                clearTimeout(fhWsReconnectTimer);
                // Exponential backoff: 5s ‚Üí 7.5s ‚Üí 11.25s ‚Üí ... ‚Üí max 30s
                fhWsReconnectTimer = setTimeout(() => {
                    if (isMarketOpen()) connectFinnhubWs();
                }, fhWsBackoff);
                fhWsBackoff = Math.min(fhWsBackoff * 1.5, 30000);
                updateMarketStatus(false);
            };

            fhWs.onerror = () => { fhWs?.close(); };
        }

        function subscribeWs(sym) {
            if (!fhWs || fhWs.readyState !== 1 || fhWsSubscribed.has(sym)) return;
            fhWs.send(JSON.stringify({ type: 'subscribe', symbol: sym }));
            fhWsSubscribed.add(sym);
        }

        function unsubscribeWs(sym) {
            if (!fhWs || fhWs.readyState !== 1) return;
            fhWs.send(JSON.stringify({ type: 'unsubscribe', symbol: sym }));
            fhWsSubscribed.delete(sym);
        }

        function disconnectFinnhubWs() {
            clearTimeout(fhWsReconnectTimer);
            fhWsBackoff = 5000;
            if (fhWs) { fhWs.close(); fhWs = null; }
            fhWsSubscribed.clear();
        }

        function isMarketOpen() {
            const now = new Date();
            const bkkTotal = ((now.getUTCHours() + 7) % 24) * 60 + now.getUTCMinutes();
            return bkkTotal >= 21 * 60 + 30 || bkkTotal < 3 * 60;
        }

        function updateMarketStatus(isLive = false) {
            const el = document.getElementById('wl-market-status');
            if (!el) return;
            const open = isMarketOpen();
            const wsConnected = fhWs && fhWs.readyState === 1;
            if (open && wsConnected) {
                el.textContent = '‚óè LIVE';
                el.style.background = 'rgba(5,150,105,0.15)';
                el.style.color = '#059669';
            } else if (open) {
                el.textContent = '‚óè MARKET OPEN';
                el.style.background = 'rgba(234,179,8,0.15)';
                el.style.color = '#ca8a04';
            } else {
                el.textContent = '‚óè MARKET CLOSED';
                el.style.background = 'rgba(100,116,139,0.15)';
                el.style.color = '#64748b';
            }
        }

        async function fetchFxRate() {
            const rateEl      = document.getElementById('fx-rate');
            const rateInvEl   = document.getElementById('fx-rate-inv');
            const changeEl    = document.getElementById('fx-change');
            const changeInvEl = document.getElementById('fx-change-inv');
            if (!rateEl) return;

            // USD/THB mid rate must be in range 28‚Äì45
            const valid = v => typeof v === 'number' && v > 28 && v < 45;

            try {
                let usdThbMid = null; // e.g. 33.50 ‚Äî "1 USD = 33.50 THB" (sell side)
                let src = '';

                // SOURCE 1: Finnhub OANDA:USD_THB (realtime forex quote, j.c = current)
                const fKey = getFinnhubKey();
                if (fKey) {
                    try {
                        const r = await fetch(`https://finnhub.io/api/v1/quote?symbol=OANDA:USD_THB&token=${fKey}`);
                        const j = await r.json();
                        if (valid(j.c)) { usdThbMid = j.c; src = 'Finnhub'; }
                    } catch(e) {}
                }

                // SOURCE 2: Frankfurter ECB (daily, very accurate, no key needed)
                if (!usdThbMid) {
                    try {
                        const r = await fetch('https://api.frankfurter.app/latest?from=USD&to=THB');
                        const j = await r.json();
                        if (valid(j.rates?.THB)) { usdThbMid = j.rates.THB; src = 'ECB'; }
                    } catch(e) {}
                }

                // SOURCE 3: open.er-api (hourly)
                if (!usdThbMid) {
                    try {
                        const r = await fetch('https://open.er-api.com/v6/latest/USD');
                        const j = await r.json();
                        if (valid(j.rates?.THB)) { usdThbMid = j.rates.THB; src = 'ER-API'; }
                    } catch(e) {}
                }

                // SOURCE 4: Fawaz CDN (daily fallback)
                if (!usdThbMid) {
                    try {
                        const r = await fetch('https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/usd.json');
                        const j = await r.json();
                        if (valid(j.usd?.thb)) { usdThbMid = j.usd.thb; src = 'CDN'; }
                    } catch(e) {}
                }

                if (!usdThbMid) throw new Error('No valid FX rate');

                // ‚îÄ‚îÄ‚îÄ USD ‚Üí THB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                // "‡∏Ç‡∏≤‡∏¢ 1 USD ‡πÑ‡∏î‡πâ‡∏Å‡∏µ‡πà‡∏ö‡∏≤‡∏ó" ‚Äî mid rate, e.g. 33.50 THB
                const usdToThb = parseFloat(usdThbMid.toFixed(2));

                // ‚îÄ‚îÄ‚îÄ THB ‚Üí USD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                // "‡∏ã‡∏∑‡πâ‡∏≠ 1 USD ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Å‡∏µ‡πà‡∏ö‡∏≤‡∏ó" ‚Äî inverse mid, always slightly higher than usdToThb
                // Dime shows e.g. USD‚ÜíTHB=31.38, THB‚ÜíUSD=31.50 (spread ~0.3%)
                // We simulate real-world spread: buy rate = mid * 1.004 (0.4% spread, typical retail FX)
                const thbToUsd = parseFloat((usdThbMid * 1.004).toFixed(2));

                // Update display
                rateEl.textContent    = usdToThb.toFixed(2) + ' THB';
                rateInvEl.textContent = thbToUsd.toFixed(2) + ' THB';
                rateEl.title = `1 USD = ${usdToThb} THB (Source: ${src})`;
                rateInvEl.title = `‡∏ã‡∏∑‡πâ‡∏≠ 1 USD ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ ${thbToUsd} THB (spread ~0.4%)`;

                // ‚îÄ‚îÄ‚îÄ % Change: USD‚ÜíTHB vs previous ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const fmtChange = (curr, prev, el) => {
                    if (prev === null || prev <= 0) {
                        el.textContent = '‚Üë 0.00%';
                        el.style.color = '#22c55e';
                        return;
                    }
                    const diff = curr - prev;
                    const pct  = Math.abs((diff / prev) * 100);
                    const isUp = diff > 0.005;
                    const isDn = diff < -0.005;
                    // For USD‚ÜíTHB: rate UP = USD stronger = bad for Thai buying USD assets (red)
                    // For THB‚ÜíUSD: same direction ‚Äî if USD strengthens, both rates rise
                    el.textContent = `${isUp ? '‚Üë' : isDn ? '‚Üì' : '‚Äî'} ${pct.toFixed(2)}%`;
                    el.style.color = isUp ? '#f43f5e' : isDn ? '#22c55e' : '#94a3b8';
                };

                fmtChange(usdToThb, fxPrevRate,    changeEl);
                fmtChange(thbToUsd, fxPrevRateInv, changeInvEl);

                // Save for next comparison
                fxPrevRate    = usdToThb;
                fxPrevRateInv = thbToUsd;

            } catch(e) {
                if (rateEl) { rateEl.textContent = '‚Äî'; }
            }
        }

        // --- Dark Mode ---
        function toggleDarkMode() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('ps_dark', isDark ? '1' : '0');
            updateChartThemes(isDark);
            // Re-render TradingView widget with new theme if open
            if (qcCurrentSymbol) openQuickChart(qcCurrentSymbol, false);
        }

        function applyDarkMode(isDark) {
            if (isDark) document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
        }

        function updateChartThemes(isDark) {
            const gridColor  = isDark ? 'rgba(255,255,255,0.04)' : '#f1f5f9';
            const tickColor  = isDark ? '#334155' : '#9ca3af';
            const tooltipBg  = isDark ? '#1e293b' : '#fff';
            const tooltipBorder = isDark ? '#334155' : '#e5e7eb';
            const tooltipTitle  = isDark ? '#64748b' : '#6b7280';
            const tooltipBody   = isDark ? '#f1f5f9' : '#111827';
            [compareChart, distChart].forEach(chart => {
                if (!chart) return;
                if (chart.options.scales) {
                    Object.values(chart.options.scales).forEach(scale => {
                        if (scale.grid) scale.grid.color = gridColor;
                        if (scale.ticks) scale.ticks.color = tickColor;
                    });
                }
                if (chart.options.plugins?.tooltip) {
                    chart.options.plugins.tooltip.backgroundColor = tooltipBg;
                    chart.options.plugins.tooltip.borderColor = tooltipBorder;
                    chart.options.plugins.tooltip.titleColor = tooltipTitle;
                    chart.options.plugins.tooltip.bodyColor = tooltipBody;
                }
                chart.update('none');
            });
            if (qcChart) {
                if (qcChart.options.scales) {
                    Object.values(qcChart.options.scales).forEach(scale => {
                        if (scale.grid) scale.grid.color = gridColor;
                        if (scale.ticks) scale.ticks.color = tickColor;
                    });
                }
                qcChart.update('none');
            }
        }

        window.onload = () => {
            // Apply dark mode immediately before render
            const savedDark = localStorage.getItem('ps_dark');
            applyDarkMode(savedDark === '1');

            try {
                const saved = localStorage.getItem('ps_records');
                if (saved) records = JSON.parse(saved);
                const savedAvatar = localStorage.getItem('ps_avatar');
                if (savedAvatar) { db.avatar = savedAvatar; setAvatarImage(savedAvatar); }
                const savedName = localStorage.getItem('ps_dbname');
                if (savedName) document.getElementById('db-name-display').innerText = savedName;
                const savedWl = localStorage.getItem('ps_watchlist');
                if (savedWl) watchlist = JSON.parse(savedWl);
            } catch(e) {}
            const savedMonth = localStorage.getItem('ps_month');
            if (savedMonth) curMonth = savedMonth;
            document.getElementById('monthInput').value = curMonth;
            const savedTab = localStorage.getItem('ps_tab') || 'dashboard';
            showTab(savedTab, false, true);
            loadMonth(curMonth);

            if (getGistToken()) {
                if (savedTab === 'watchlist' && watchlist.length > 0) {
                    watchlist.forEach(s => {
                        if (!document.getElementById('wl-row-' + s))
                            renderWatchlistRow(s, wlDataCache[s] || null);
                    });
                    fetchFxRate();
                }
                syncFromGist();
            } else {
                if (savedTab === 'watchlist' && watchlist.length > 0) {
                    watchlist.forEach(s => {
                        if (!document.getElementById('wl-row-' + s))
                            renderWatchlistRow(s, wlDataCache[s] || null);
                    });
                    fetchFxRate();
                    refreshWatchlist();
                }
            }

            // FX rate: refresh every 30s (API updates ~every 60s, 30s keeps it feeling live)
            setInterval(() => {
                const wlVisible = !document.getElementById('tab-watchlist').classList.contains('hidden');
                if (wlVisible) fetchFxRate();
            }, 30 * 1000);

            // Fallback polling every 1 min ‚Äî only when WebSocket is NOT connected and market is open
            setInterval(() => {
                const wlVisible = !document.getElementById('tab-watchlist').classList.contains('hidden');
                if (!wlVisible || watchlist.length === 0) return;
                if (!isMarketOpen()) return;
                const wsOk = fhWs && fhWs.readyState === 1;
                if (wsOk) return; // WS is running, no need to poll
                refreshWatchlist();
            }, 60 * 1000);

            updateMarketStatus();

            // Clear old incompatible AI keys ‚Äî never migrate them to OpenRouter
            ['ps_claude_key','ps_perplexity_key','ps_gemini_key'].forEach(old => {
                localStorage.removeItem(old);
            });
            // Also clear ps_openrouter_key if it contains a non-OpenRouter key
            const storedAiKey = localStorage.getItem('ps_openrouter_key') || '';
            if (storedAiKey && !storedAiKey.startsWith('sk-or-')) {
                localStorage.removeItem('ps_openrouter_key');
            }
            updateAiStatus();

            // ‚îÄ‚îÄ Debounced auto-save: saves 5s after last change, not blindly every 30s
            let autoSaveTimer = null;
            function scheduleAutoSave() {
                if (!getGistToken() || (records.length === 0 && watchlist.length === 0)) return;
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(async () => {
                    const exportData = { meta: { avatar: db.avatar, dark: document.documentElement.classList.contains('dark') }, records, watchlist };
                    const token = getGistToken();
                    try {
                        const res = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                            method: 'PATCH',
                            headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ files: { [GIST_FILENAME]: { content: JSON.stringify(exportData, null, 2) } } })
                        });
                        if (res.ok) showGistStatus('AUTO SAVED ‚úì', 'text-emerald-400');
                        else showGistStatus('SAVE FAILED ‚úó', 'text-rose-500');
                    } catch(e) {
                        showGistStatus('OFFLINE ‚Äî saved locally', 'text-amber-400');
                    }
                }, 5000);
            }
            // Trigger schedule whenever records/watchlist change (patch saveWatchlist + saveRecords)
            const _origSaveWatchlist = saveWatchlist;
            saveWatchlist = function() { _origSaveWatchlist(); scheduleAutoSave(); };

            // Periodic safety-net every 30s (only if pending changes exist)
            let lastSavedHash = '';
            setInterval(() => {
                if (!getGistToken() || (records.length === 0 && watchlist.length === 0)) return;
                const hash = JSON.stringify({ r: records.length, w: watchlist.length });
                if (hash === lastSavedHash) return;
                lastSavedHash = hash;
                scheduleAutoSave();
            }, 30 * 1000);

            // Save on tab close / navigate away
            window.addEventListener('beforeunload', () => {
                if (getGistToken() && (records.length > 0 || watchlist.length > 0)) {
                    const exportData = { meta: { avatar: db.avatar, dark: document.documentElement.classList.contains('dark') }, records, watchlist };
                    const token = getGistToken();
                    fetch(`https://api.github.com/gists/${GIST_ID}`, {
                        method: 'PATCH',
                        headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ files: { [GIST_FILENAME]: { content: JSON.stringify(exportData, null, 2) } } }),
                        keepalive: true
                    });
                }
            });
        };
    </script>
    <!-- ‚îÄ‚îÄ AI Chat Popup (draggable, minimizable) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <!-- Minimized FAB ‚Äî shown when popup is minimized -->
    <div id="ai-fab" class="hidden fixed z-[201] cursor-pointer select-none"
         style="bottom:24px;right:24px"
         onclick="restoreAiPopup()">
        <div class="flex items-center gap-2 px-4 py-3 rounded-2xl shadow-2xl"
             style="background:linear-gradient(135deg,#1a73e8,#34a853);color:white;min-width:120px">
            <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.347.347a3.5 3.5 0 01-4.95 0l-.347-.347z"/></svg>
            <span class="text-[11px] font-black uppercase tracking-widest">AI Analyst</span>
            <span id="ai-fab-badge" class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse ml-auto"></span>
        </div>
    </div>

    <!-- Full popup panel ‚Äî draggable -->
    <div id="ai-popup" class="hidden fixed z-[200] select-none"
         style="bottom:24px;right:24px;width:520px;max-width:calc(100vw - 32px)">
        <div id="ai-popup-panel"
             class="flex flex-col rounded-2xl shadow-2xl overflow-hidden"
             style="height:420px;background:var(--bg-card);border:1px solid var(--border);overscroll-behavior:contain"
             onwheel="event.stopPropagation()">

            <!-- Header (drag handle) -->
            <div id="ai-popup-header"
                 class="flex items-center justify-between px-4 py-2.5 flex-shrink-0 border-b cursor-grab active:cursor-grabbing"
                 style="background:var(--bg-card2);border-color:var(--border);user-select:none">
                <div class="flex items-center gap-2.5">
                    <div class="w-6 h-6 rounded-lg flex items-center justify-center flex-shrink-0" style="background:linear-gradient(135deg,#1a73e8,#34a853)">
                        <svg class="w-3.5 h-3.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.347.347a3.5 3.5 0 01-4.95 0l-.347-.347z"/></svg>
                    </div>
                    <span class="font-black text-xs uppercase tracking-widest" style="color:var(--text-primary)">AI Stock Analyst</span>
                    <span id="ai-popup-badge" class="text-[8px] font-bold px-1.5 py-0.5 rounded-full" style="background:rgba(26,115,232,0.12);color:#4285f4">Auto Free</span>
                </div>
                <div class="flex items-center gap-1.5">
                    <button onclick="clearAiChat()" class="text-[9px] font-bold px-2.5 py-1 rounded-lg uppercase tracking-wide transition-all" style="background:var(--bg-card);border:1px solid var(--border);color:var(--text-dim)">‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ä‡∏ó</button>
                    <!-- Minimize -->
                    <button onclick="minimizeAiPopup()" class="w-6 h-6 flex items-center justify-center rounded-lg transition-all hover:scale-110" style="background:var(--bg-card);border:1px solid var(--border);color:var(--text-secondary)" title="‡∏¢‡πà‡∏≠">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M20 12H4"/></svg>
                    </button>
                    <!-- Close -->
                    <button onclick="minimizeAiPopup()" class="w-6 h-6 flex items-center justify-center rounded-lg transition-all hover:scale-110" style="background:var(--bg-card);border:1px solid var(--border);color:var(--text-secondary)" title="‡∏õ‡∏¥‡∏î">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
            </div>

            <!-- Messages -->
            <div id="ai-popup-messages" class="flex-1 overflow-y-auto flex flex-col gap-3 p-4" onwheel="event.stopPropagation()">
                <div class="flex items-start gap-2.5">
                    <div class="w-7 h-7 rounded-full flex items-center justify-center flex-shrink-0" style="background:linear-gradient(135deg,#1a73e8,#34a853)">
                        <svg class="w-3.5 h-3.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.347.347a3.5 3.5 0 01-4.95 0l-.347-.347z"/></svg>
                    </div>
                    <div class="flex-1">
                        <div class="text-[10px] font-bold mb-1" style="color:#4285f4">AI ANALYST</div>
                        <div class="text-sm leading-relaxed" style="color:var(--text-secondary)">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏ô‡∏ß‡∏£‡∏±‡∏ö/‡πÅ‡∏ô‡∏ß‡∏ï‡πâ‡∏≤‡∏ô, ‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡∏´‡∏£‡∏∑‡∏≠ outlook ‡∏Ç‡∏≠‡∏á‡∏´‡∏∏‡πâ‡∏ô‡πÉ‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö</div>
                    </div>
                </div>
            </div>

            <!-- Input -->
            <div class="flex items-center gap-2 px-3 py-2.5 flex-shrink-0 border-t" style="border-color:var(--border);background:var(--bg-card2)">
                <input id="ai-popup-input" type="text" placeholder="‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢..."
                    class="flex-1 text-xs px-3 py-2 rounded-xl outline-none"
                    style="background:var(--bg-card);border:1px solid var(--border);color:var(--text-primary)"
                    onkeydown="if(event.key==='Enter')sendAiMessage()">
                <button onclick="sendAiMessage()" id="ai-popup-send-btn"
                    class="flex items-center gap-1.5 px-3 py-2 rounded-xl text-[10px] font-bold uppercase tracking-wider flex-shrink-0"
                    style="background:linear-gradient(135deg,#1a73e8,#34a853);color:white">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                    ‡∏™‡πà‡∏á
                </button>
                <button onclick="stopAiMessage()" id="ai-popup-stop-btn"
                    class="hidden flex items-center gap-1.5 px-3 py-2 rounded-xl text-[10px] font-bold uppercase tracking-wider flex-shrink-0"
                    style="background:#ef4444;color:white">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="1" stroke-width="2" fill="currentColor"/></svg>
                    ‡∏´‡∏¢‡∏∏‡∏î
                </button>
            </div>
        </div>
    </div>

</body>
</html>
