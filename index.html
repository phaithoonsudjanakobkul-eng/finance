<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PS Smart Finance - Secured</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Apply dark mode before paint to prevent flash
        if (localStorage.getItem('ps_dark') === '1') {
            document.documentElement.classList.add('dark');
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=IBM+Plex+Mono:wght@400;500;600;700&display=optional" rel="stylesheet">
    <style>
        /* Prevent FOUT — lock font size/weight immediately with system fallback that matches Inter metrics */
        body { font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    </style>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;700&family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --font-main: 'Inter', 'IBM Plex Sans Thai', system-ui, san-serif; 
            --font-mono: 'IBM Plex Mono', monospace;
            --bg-dark: #f0f4f8;
            --bg-card: #ffffff;
            --bg-card2: #e8eef5;
            --border: #d0dce8;
            --accent: #0d9488;
            --accent2: #0f766e;
            --danger: #e11d48;
            --warning: #d97706;
            --text-primary: #0f2030;
            --text-secondary: #64748b;
            --text-dim: #94a3b8;
        }

        html.dark {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-card2: #162032;
            --border: #334155;
            --accent: #14b8a6;
            --accent2: #0d9488;
            --danger: #f43f5e;
            --warning: #f59e0b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-dim: #64748b;
        }

        body {
            font-family: var(--font-main);
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            font-size: 13px;
        }

        @keyframes fadeIn {
            from {opacity: 0;}
            to {opacity: 1;}
        }

        @keyframes slideUp {
            from {transform: translateY(10px); opacity: 0;}
            to {transform: translateY(0); opacity: 1;}
        }

        .animate-in {
            animation: fadeIn 0.2s ease, slideUp 0.2s ease;
        }

        .animate-pulse {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .no-transition * {
            transition: none !important;
        }

        /* Quick Chart */
        #quick-chart-wrap {
            position: sticky;
            top: 0;
            z-index: 10;
            min-height: 300px;
            height: 100%; /* Ensure full height */
        }

        #quick-chart-skeleton {
            height: 100%;
            background: var(--bg-card2);
            animation: pulse 1.5s infinite;
        }

        #quick-chart {
            height: 100%; /* Full height for TradingView */
            width: 100%;
        }

        /* Watchlist Table */
        #wl-table {
            min-height: 400px; /* Prevent shrinking */
        }

        #wl-table-skeleton {
            height: 100%;
            background: var(--bg-card2);
            animation: pulse 1.5s infinite;
        }

        /* News Section */
        #wl-news {
            overflow-y: auto;
            max-height: 300px; /* Fixed height to prevent pushing */
        }

        /* Split Wrap */
        #wl-split-wrap {
            min-height: calc(100vh - 120px); /* Adjust based on header height */
        }

        /* Pre-Market Column Styles */
        .pre-market-positive {
            color: #22c55e;
        }

        .pre-market-negative {
            color: #ef4444;
        }
    </style>
</head>
<body class="relative flex flex-col min-h-screen overflow-hidden">
    <!-- Header -->
    <header class="flex items-center justify-between px-6 py-4 border-b" style="border-color:var(--border);background:var(--bg-card2)">
        <!-- Left Side -->
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full overflow-hidden border-2" style="border-color:var(--accent)">
                <img id="avatar-img" src="https://i.pravatar.cc/100?u=phaithoon" alt="User Avatar">
            </div>
            <div>
                <h1 class="text-base font-bold">PS SMART FINANCE</h1>
                <p id="db-name" class="text-[11px]" style="color:var(--text-dim)">PS-SMART-FINANCE.JSON</p>
            </div>
        </div>

        <!-- Right Side -->
        <nav class="flex items-center gap-6">
            <button class="tab-btn px-3 py-1.5 text-sm rounded-lg hover:bg-slate-800" onclick="switchTab('dashboard')">DASHBOARD</button>
            <button class="tab-btn px-3 py-1.5 text-sm rounded-lg hover:bg-slate-800" onclick="switchTab('records')">RECORDS</button>
            <button class="tab-btn px-3 py-1.5 text-sm rounded-lg hover:bg-slate-800 active" onclick="switchTab('watchlist')">WATCHLIST</button>
            <button onclick="syncToGist()" class="p-2 hover:bg-slate-800 rounded" title="SYNC">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></path></svg>
            </button>
            <button onclick="uploadJson()" class="p-2 hover:bg-slate-800 rounded" title="UPLOAD">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 0115.9 7L16 7a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></path></svg>
            </button>
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" class="sr-only" checked onchange="toggleDark(this)">
                <div class="w-9 h-5 rounded-full" style="background:var(--border)">
                    <div class="absolute w-4 h-4 rounded-full transform duration-200 ease-in-out" style="background:var(--bg-card);border:1px solid var(--border);left:1px;top:0.5px;translateX(0)"></div>
                </div>
            </label>
        </nav>
    </header>

    <!-- Tabs -->
    <main class="flex-1 overflow-auto p-4">
        <!-- Dashboard Tab -->
        <div id="tab-dashboard" class="hidden flex flex-col gap-6">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="p-4 rounded-xl" style="background:var(--bg-card);border:1px solid var(--border)">
                    <p class="text-xs uppercase font-medium" style="color:var(--text-secondary)">Current Balance</p>
                    <h2 class="text-2xl font-bold mt-1">8,000.00</h2>
                    <p class="text-xs mt-1" style="color:var(--text-dim)">↑ 42% vs last month</p>
                    <p class="text-xs mt-1 font-medium" style="color:var(--accent)">HEALTHY</p>
                </div>
                <!-- Other summary cards similar -->
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="p-4 rounded-xl" style="background:var(--bg-card);border:1px solid var(--border)">
                    <p class="text-xs uppercase font-medium" style="color:var(--text-secondary)">Trend Comparison</p>
                    <canvas id="trend-chart" class="mt-4"></canvas>
                </div>
                <div class="p-4 rounded-xl" style="background:var(--bg-card);border:1px solid var(--border)">
                    <p class="text-xs uppercase font-medium" style="color:var(--text-secondary)">Distribution</p>
                    <canvas id="distribution-chart" class="mt-4"></canvas>
                </div>
            </div>

            <!-- Market News -->
            <div class="p-4 rounded-xl" style="background:var(--bg-card);border:1px solid var(--border)">
                <p class="text-xs uppercase font-medium" style="color:var(--text-secondary)">Market News</p>
                <select class="text-xs p-1 rounded" onchange="fetchNews(this.value)">
                    <option value="us">US Markets</option>
                </select>
                <button class="text-xs p-1 rounded ml-2" onclick="fetchNews(document.querySelector('#market-news-select').value)">REFRESH</button>
                <div id="market-news" class="mt-4 flex flex-col gap-3 overflow-auto max-h-80"></div>
            </div>
        </div>

        <!-- Records Tab -->
        <div id="tab-records" class="hidden flex flex-col gap-6">
            <!-- Month Selector -->
            <div class="flex items-center gap-4">
                <button onclick="changeMonth(-1)" class="p-2 rounded" style="background:var(--bg-card);border:1px solid var(--border)">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></path></svg>
                </button>
                <h2 id="current-month" class="text-lg font-bold">February 2026</h2>
                <button onclick="changeMonth(1)" class="p-2 rounded" style="background:var(--bg-card);border:1px solid var(--border)">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></path></svg>
                </button>
                <button onclick="pullLastMonth()" class="text-xs px-3 py-1 rounded" style="background:var(--accent2);color:white">PULL LAST DATA</button>
                <button onclick="clearMonth()" class="text-xs px-3 py-1 rounded" style="background:var(--danger);color:white">CLEAR MONTH</button>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="p-4 rounded-xl" style="background:var(--bg-card);border:1px solid var(--border)">
                    <p class="text-xs uppercase font-medium" style="color:var(--text-secondary)">Monthly Income (บาท)</p>
                    <h2 id="monthly-income" class="text-2xl font-bold mt-1">0.00</h2>
                </div>
                <!-- Other summary cards similar -->
            </div>

            <!-- Expenses -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="p-4 rounded-xl" style="background:var(--bg-card);border:1px solid var(--border)">
                    <p class="text-xs uppercase font-medium" style="color:var(--text-secondary)">รายจ่ายประจำ / เงินลงทุน</p>
                    <h2 id="fixed-expenses-total" class="text-xl font-bold mt-1" style="color:var(--danger)">0.00</h2>
                    <p class="text-xs mt-1" style="color:var(--text-dim)">Last Month: 0.00</p>
                    <div id="fixed-expenses" class="flex flex-col gap-2 mt-3"></div>
                    <button onclick="addFixedExpense()" class="text-xs px-3 py-1 rounded mt-3" style="background:var(--accent2);color:white">ADD FIXED EXPENSE</button>
                </div>
                <div class="p-4 rounded-xl" style="background:var(--bg-card);border:1px solid var(--border)">
                    <p class="text-xs uppercase font-medium" style="color:var(--text-secondary)">รายจ่ายผันแปร</p>
                    <h2 id="variable-expenses-total" class="text-xl font-bold mt-1" style="color:var(--danger)">0.00</h2>
                    <p class="text-xs mt-1" style="color:var(--text-dim)">Last Month: 0.00</p>
                    <div id="variable-expenses" class="flex flex-col gap-2 mt-3"></div>
                    <button onclick="addVariableExpense()" class="text-xs px-3 py-1 rounded mt-3" style="background:var(--accent2);color:white">ADD VARIABLE EXPENSE</button>
                </div>
            </div>
        </div>

        <!-- Watchlist Tab -->
        <div id="tab-watchlist" class="flex flex-col gap-4">
            <!-- Header -->
            <div class="flex items-center gap-4">
                <h2 class="text-lg font-bold">WATCHLIST</h2>
                <p id="wl-updated" class="text-xs" style="color:var(--text-dim)">Updated 18:17</p>
                <p id="market-status" class="text-xs px-2 py-1 rounded" style="background:var(--bg-card2);color:var(--text-secondary)">MARKET CLOSED</p>
                <div id="fx-rate-real" class="flex gap-2">
                    <div class="text-xs px-3 py-1 rounded flex items-center gap-1" style="background:var(--bg-card2)">
                        <span>US→TH USD→THB</span>
                        <span id="us-thb-change" class="font-bold" style="color:var(--accent)">+0.00%</span>
                        <span id="us-thb-rate" class="font-bold">0.00 THB</span>
                    </div>
                    <div class="text-xs px-3 py-1 rounded flex items-center gap-1" style="background:var(--bg-card2)">
                        <span>TH→US THB→USD</span>
                        <span id="th-us-change" class="font-bold" style="color:var(--accent)">+0.00%</span>
                        <span id="th-us-rate" class="font-bold">0.00 THB</span>
                    </div>
                </div>
                <button onclick="toggleAiPopup()" class="flex items-center gap-1 text-xs px-3 py-1 rounded" style="background:var(--accent2);color:white">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></path></svg>
                    ถาม AI วิเคราะห์...
                </button>
                <button onclick="refreshWatchlist()" class="text-xs px-3 py-1 rounded" style="background:var(--accent2);color:white">REFRESH</button>
                <button onclick="addSymbol()" class="text-xs px-3 py-1 rounded" style="background:var(--accent2);color:white">ADD</button>
            </div>

            <!-- Watchlist Table Skeleton -->
            <div id="wl-table-skeleton" class="animate-pulse">
                <table class="w-full border-collapse" style="background:var(--bg-card)">
                    <thead>
                        <tr>
                            <th class="p-2 text-xs" style="border-bottom:1px solid var(--border)">#</th>
                            <th class="p-2 text-xs" style="border-bottom:1px solid var(--border)">SYMBOL</th>
                            <th class="p-2 text-xs" style="border-bottom:1px solid var(--border)">NAME</th>
                            <th class="p-2 text-xs" style="border-bottom:1px solid var(--border)">PRICE</th>
                            <th class="p-2 text-xs" style="border-bottom:1px solid var(--border)">CHANGE</th>
                            <th class="p-2 text-xs" style="border-bottom:1px solid var(--border)">% CHANGE</th>
                            <th class="p-2 text-xs" style="border-bottom:1px solid var(--border)">OPEN</th>
                            <th class="p-2 text-xs" style="border-bottom:1px solid var(--border)">PREV CLOSE</th>
                            <th class="p-2 text-xs" style="border-bottom:1px solid var(--border)">HIGH</th>
                            <th class="p-2 text-xs" style="border-bottom:1px solid var(--border)">LOW</th>
                            <th class="p-2 text-xs" style="border-bottom:1px solid var(--border)">52W HIGH</th>
                            <th class="p-2 text-xs" style="border-bottom:1px solid var(--border)">52W LOW</th>
                            <th class="p-2 text-xs" style="border-bottom:1px solid var(--border)">MKT CAP</th>
                            <th class="p-2 text-xs" style="border-bottom:1px solid var(--border)">AVG VOL 1D</th>
                            <th class="p-2 text-xs" style="border-bottom:1px solid var(--border)">BETA</th>
                            <th class="p-2 text-xs" style="border-bottom:1px solid var(--border)">P/E</th>
                            <th class="p-2 text-xs" style="border-bottom:1px solid var(--border)">DIV YIELD</th>
                            <th class="p-2 text-xs" style="border-bottom:1px solid var(--border)">PRE MARKET</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Skeleton rows -->
                        <tr>
                            <td class="p-2" style="background:var(--bg-card2);height:40px"></td>
                            <td class="p-2" style="background:var(--bg-card2)"></td>
                            <td class="p-2" style="background:var(--bg-card2)"></td>
                            <td class="p-2" style="background:var(--bg-card2)"></td>
                            <td class="p-2" style="background:var(--bg-card2)"></td>
                            <td class="p-2" style="background:var(--bg-card2)"></td>
                            <td class="p-2" style="background:var(--bg-card2)"></td>
                            <td class="p-2" style="background:var(--bg-card2)"></td>
                            <td class="p-2" style="background:var(--bg-card2)"></td>
                            <td class="p-2" style="background:var(--bg-card2)"></td>
                            <td class="p-2" style="background:var(--bg-card2)"></td>
                            <td class="p-2" style="background:var(--bg-card2)"></td>
                            <td class="p-2" style="background:var(--bg-card2)"></td>
                            <td class="p-2" style="background:var(--bg-card2)"></td>
                            <td class="p-2" style="background:var(--bg-card2)"></td>
                            <td class="p-2" style="background:var(--bg-card2)"></td>
                            <td class="p-2" style="background:var(--bg-card2)"></td>
                            <td class="p-2" style="background:var(--bg-card2)"></td>
                        </tr>
                        <!-- Repeat for 5-10 skeleton rows -->
                    </tbody>
                </table>
            </div>

            <!-- Watchlist Table -->
            <div id="wl-split-wrap" class="flex flex-col md:flex-row gap-4">
                <div class="md:w-1/2 overflow-auto">
                    <table id="wl-table" class="w-full border-collapse hidden" style="background:var(--bg-card)">
                        <thead>
                            <tr style="background:var(--bg-card2)">
                                <th class="p-2 text-xs sticky top-0" style="border-bottom:1px solid var(--border)">#</th>
                                <th class="p-2 text-xs sticky top-0" style="border-bottom:1px solid var(--border)">SYMBOL</th>
                                <th class="p-2 text-xs sticky top-0" style="border-bottom:1px solid var(--border)">NAME</th>
                                <th class="p-2 text-xs sticky top-0" style="border-bottom:1px solid var(--border)">PRICE</th>
                                <th class="p-2 text-xs sticky top-0" style="border-bottom:1px solid var(--border)">CHANGE</th>
                                <th class="p-2 text-xs sticky top-0" style="border-bottom:1px solid var(--border)">% CHANGE</th>
                                <th class="p-2 text-xs sticky top-0" style="border-bottom:1px solid var(--border)">OPEN</th>
                                <th class="p-2 text-xs sticky top-0" style="border-bottom:1px solid var(--border)">PREV CLOSE</th>
                                <th class="p-2 text-xs sticky top-0" style="border-bottom:1px solid var(--border)">HIGH</th>
                                <th class="p-2 text-xs sticky top-0" style="border-bottom:1px solid var(--border)">LOW</th>
                                <th class="p-2 text-xs sticky top-0" style="border-bottom:1px solid var(--border)">52W HIGH</th>
                                <th class="p-2 text-xs sticky top-0" style="border-bottom:1px solid var(--border)">52W LOW</th>
                                <th class="p-2 text-xs sticky top-0" style="border-bottom:1px solid var(--border)">MKT CAP</th>
                                <th class="p-2 text-xs sticky top-0" style="border-bottom:1px solid var(--border)">AVG VOL 1D</th>
                                <th class="p-2 text-xs sticky top-0" style="border-bottom:1px solid var(--border)">BETA</th>
                                <th class="p-2 text-xs sticky top-0" style="border-bottom:1px solid var(--border)">P/E</th>
                                <th class="p-2 text-xs sticky top-0" style="border-bottom:1px solid var(--border)">DIV YIELD</th>
                                <th class="p-2 text-xs sticky top-0" style="border-bottom:1px solid var(--border)">PRE MARKET</th>
                            </tr>
                        </thead>
                        <tbody id="wl-tbody"></tbody>
                    </table>
                </div>
                <div class="md:w-1/2 flex flex-col gap-4">
                    <div id="quick-chart-wrap" class="rounded-xl overflow-hidden" style="background:var(--bg-card);border:1px solid var(--border)">
                        <div id="quick-chart-skeleton" class="animate-pulse h-full w-full"></div>
                        <div id="quick-chart" class="hidden h-full"></div>
                    </div>
                    <div class="p-4 rounded-xl overflow-auto" style="background:var(--bg-card);border:1px solid var(--border)">
                        <p class="text-xs uppercase font-medium" style="color:var(--text-secondary)">NEWS</p>
                        <div id="wl-news" class="mt-4 flex flex-col gap-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="modal-backdrop" class="fixed inset-0 hidden" style="background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);z-index:50"></div>
    <!-- Other modals similar -->

    <!-- AI Popup Modal -->
    <div id="ai-popup" class="fixed bottom-4 right-4 w-80 hidden flex flex-col rounded-xl overflow-hidden shadow-2xl z-50" style="background:var(--bg-card);border:1px solid var(--border)">
        <!-- Header -->
        <div class="flex items-center justify-between px-3 py-2" style="background:var(--bg-card2)">
            <h3 class="text-xs font-bold uppercase" style="color:var(--text-primary)">AI STOCK ANALYST</h3>
            <button onclick="toggleAiPopup()" class="text-xs" style="color:var(--text-dim)">X</button>
        </div>

        <!-- Chat -->
        <div id="ai-messages" class="flex-1 p-3 overflow-y-auto flex flex-col gap-3 text-xs" style="background:var(--bg-card)">
            <!-- Messages will be appended here -->
        </div>

        <!-- Input -->
        <div class="flex items-center gap-2 px-3 py-2.5 flex-shrink-0 border-t" style="border-color:var(--border);background:var(--bg-card2)">
            <input id="ai-popup-input" type="text" placeholder="ถามต่อได้เลย..."
                class="flex-1 text-xs px-3 py-2 rounded-xl outline-none"
                style="background:var(--bg-card);border:1px solid var(--border);color:var(--text-primary)"
                onkeydown="if(event.key==='Enter')sendAiMessage()">
            <button onclick="sendAiMessage()" id="ai-popup-send-btn"
                class="flex items-center gap-1.5 px-3 py-2 rounded-xl text-[10px] font-bold uppercase tracking-wider flex-shrink-0"
                style="background:linear-gradient(135deg,#1a73e8,#34a853);color:white">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></path></svg>
                ส่ง
            </button>
            <button onclick="stopAiMessage()" id="ai-popup-stop-btn"
                class="hidden flex items-center gap-1.5 px-3 py-2 rounded-xl text-[10px] font-bold uppercase tracking-wider flex-shrink-0"
                style="background:#ef4444;color:white">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="1" stroke-width="2" fill="currentColor"/></svg>
                หยุด
            </button>
        </div>
    </div>

    <script>
        // Add no-transition on load to prevent layout shifts
        document.body.classList.add('no-transition');
        setTimeout(() => document.body.classList.remove('no-transition'), 1000);

        // Updated fetchFxRate with BOT API, inverse, % change, no-cache
        async function fetchFxRate() {
            const botKey = 'YOUR_BOT_API_KEY'; // Replace with your BOT key
            const date = new Date().toISOString().split('T')[0]; // Today's date YYYY-MM-DD
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0]; // Yesterday

            try {
                // Fetch current rate from BOT
                const botUrl = `https://apigw1.bot.or.th/bot/public/Stat-ExchangeRate/v2/daily-avg-exrt?currency=USD&start_period=${date}&end_period=${date}&timestamp=${Date.now()}`;
                const botRes = await fetch(botUrl, {
                    headers: { 'X-IBM-Client-Id': botKey },
                    cache: 'no-store'
                });
                const botData = await botRes.json();
                const currentUsThb = botData.result.data[0].sell_transfer.toFixed(2); // Selling rate for USD->THB
                const currentThUs = (1 / parseFloat(currentUsThb)).toFixed(2);

                // Fetch yesterday rate for % change
                const yesterdayUrl = `https://apigw1.bot.or.th/bot/public/Stat-ExchangeRate/v2/daily-avg-exrt?currency=USD&start_period=${yesterday}&end_period=${yesterday}&timestamp=${Date.now()}`;
                const yesterdayRes = await fetch(yesterdayUrl, {
                    headers: { 'X-IBM-Client-Id': botKey },
                    cache: 'no-store'
                });
                const yesterdayData = await yesterdayRes.json();
                const prevUsThb = yesterdayData.result.data[0].sell_transfer;
                const prevThUs = 1 / prevUsThb;

                const usThbChange = (((parseFloat(currentUsThb) - prevUsThb) / prevUsThb) * 100).toFixed(2) + '%';
                const thUsChange = (((parseFloat(currentThUs) - prevThUs) / prevThUs) * 100).toFixed(2) + '%';

                // Update UI
                document.getElementById('us-thb-rate').innerText = currentUsThb + ' THB';
                document.getElementById('th-us-rate').innerText = currentThUs + ' THB';
                document.getElementById('us-thb-change').innerText = usThbChange;
                document.getElementById('th-us-change').innerText = thUsChange;
                document.getElementById('us-thb-change').style.color = parseFloat(usThbChange) > 0 ? 'var(--accent)' : 'var(--danger)';
                document.getElementById('th-us-change').style.color = parseFloat(thUsChange) > 0 ? 'var(--accent)' : 'var(--danger)';

            } catch (err) {
                console.error('BOT API error', err);
                // Fallback to exchangerate-api
                const fallbackKey = 'YOUR_EXCHANGE_RATE_API_KEY';
                const fallbackUrl = `https://api.exchangerate-api.com/v4/latest/USD?access_key=${fallbackKey}&timestamp=${Date.now()}`;
                const fallbackRes = await fetch(fallbackUrl, { cache: 'no-store' });
                const fallbackData = await fallbackRes.json();
                const currentUsThb = fallbackData.rates.THB.toFixed(2);
                const currentThUs = (1 / parseFloat(currentUsThb)).toFixed(2);

                const fallbackYesterdayUrl = `https://api.exchangerate-api.com/v4/latest/USD?access_key=${fallbackKey}&date=${yesterday}&timestamp=${Date.now()}`;
                const fallbackYesterdayRes = await fetch(fallbackYesterdayUrl, { cache: 'no-store' });
                const fallbackYesterdayData = await fallbackYesterdayRes.json();
                const prevUsThb = fallbackYesterdayData.rates.THB;
                const prevThUs = 1 / prevUsThb;

                const usThbChange = (((parseFloat(currentUsThb) - prevUsThb) / prevUsThb) * 100).toFixed(2) + '%';
                const thUsChange = (((parseFloat(currentThUs) - prevThUs) / prevThUs) * 100).toFixed(2) + '%';

                // Update UI same as above
            }
        }

        // Call fetchFxRate on load and refresh
        fetchFxRate();

        // Update refreshWatchlist to include pre-market data
        async function refreshWatchlist() {
            document.getElementById('wl-table-skeleton').classList.remove('hidden');
            document.getElementById('wl-table').classList.add('hidden');

            const quotes = await Promise.all(watchlist.map(async (item) => {
                const quoteRes = await fetch(`https://finnhub.io/api/v1/quote?symbol=${item.symbol}&token=${finnhubKey}`, { cache: 'no-store' });
                const quote = await quoteRes.json();
                item.price = quote.c.toFixed(2);
                item.change = quote.d.toFixed(2);
                item.changePct = quote.dp.toFixed(2) + '%';
                item.open = quote.o.toFixed(2);
                item.prevClose = quote.pc.toFixed(2);
                item.high = quote.h.toFixed(2);
                item.low = quote.l.toFixed(2);
                item.preMarketPrice = quote.preMarketPrice ? quote.preMarketPrice.toFixed(2) : '—';
                item.preMarketChangePct = quote.preMarketChangePercent ? quote.preMarketChangePercent.toFixed(2) + '%' : '—';
                // Add more fields if needed
                return item;
            }));

            renderWatchlist(quotes);
            document.getElementById('wl-table-skeleton').classList.add('hidden');
            document.getElementById('wl-table').classList.remove('hidden');
        }

        // Adjusted renderWatchlistRow to include pre-market column
        function renderWatchlistRow(item, i) {
            const row = document.createElement('tr');
            row.draggable = true;
            row.ondragstart = dragStart;
            row.ondragover = dragOver;
            row.ondrop = drop;
            row.onclick = () => openQuickChart(item.symbol, item.name);
            row.innerHTML = `
                <td class="p-2 text-xs" style="border-bottom:1px solid var(--border)">${i+1}</td>
                <td class="p-2 flex items-center gap-2">
                    <img src="${item.logo}" alt="${item.symbol}" class="w-4 h-4 rounded-full">
                    <span>${item.symbol}</span>
                </td>
                <td class="p-2 text-xs">${item.name}</td>
                <td class="p-2 text-xs font-medium">$${item.price}</td>
                <td class="p-2 text-xs" style="color:${item.change >= 0 ? 'var(--accent)' : 'var(--danger)'}">${item.change}</td>
                <td class="p-2 text-xs" style="color:${item.changePct.startsWith('+') ? 'var(--accent)' : 'var(--danger)'}">${item.changePct}</td>
                <td class="p-2 text-xs">$${item.open}</td>
                <td class="p-2 text-xs">$${item.prevClose}</td>
                <td class="p-2 text-xs">$${item.high}</td>
                <td class="p-2 text-xs">$${item.low}</td>
                <td class="p-2 text-xs">$${item.high52w}</td>
                <td class="p-2 text-xs">$${item.low52w}</td>
                <td class="p-2 text-xs">${item.marketCap}</td>
                <td class="p-2 text-xs">${item.avgVol}</td>
                <td class="p-2 text-xs">${item.beta}</td>
                <td class="p-2 text-xs">${item.pe}</td>
                <td class="p-2 text-xs">${item.divYield}</td>
                <td class="p-2 text-xs ${item.preMarketChangePct.startsWith('+') ? 'pre-market-positive' : 'pre-market-negative'}">${item.preMarketPrice} (${item.preMarketChangePct})</td>
            `;
            return row;
        }

        // Call refreshWatchlist on load
        if (tab === 'watchlist') refreshWatchlist();

        // Add pre-market fields to watchlist data structure if needed
        // Assume watchlist array has preMarketPrice and preMarketChangePercent added in refreshWatchlist

        // Other code remains the same...
    </script>
</body>
</html>
